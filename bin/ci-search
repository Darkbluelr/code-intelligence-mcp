#!/bin/bash
# ci-search - Command line interface for code intelligence search
#
# Usage:
#   ci-search <query> [options]
#   ci-search --help
#   ci-search --version
#
# Options:
#   -l, --limit <n>     Max results (default: 10)
#   -m, --mode <mode>   Search mode: semantic|keyword (default: semantic)
#   -w, --workspace <n> Workspace name (default: main)
#   --ci-config <file>  Path to ci-config.yaml
#   --config <file>     Path to embedding config (.devbooks/config.yaml)
#   -h, --help          Show this help
#   -v, --version       Show version

set -euo pipefail

VERSION="0.2.1"
resolve_script_dir() {
    local source="${BASH_SOURCE[0]}"
    while [ -h "$source" ]; do
        local dir
        dir="$(cd -P "$(dirname "$source")" && pwd)"
        source="$(readlink "$source")"
        [[ "$source" != /* ]] && source="$dir/$source"
    done
    cd -P "$(dirname "$source")" && pwd
}

SCRIPT_DIR="$(resolve_script_dir)"
SCRIPTS_DIR="${SCRIPT_DIR}/../scripts"

# First-run welcome message
FIRST_RUN_FLAG="$HOME/.config/code-intelligence-mcp/first-run-done"
if [[ ! -f "$FIRST_RUN_FLAG" ]]; then
    mkdir -p "$(dirname "$FIRST_RUN_FLAG")"
    cat >&2 << 'EOF'

ðŸŽ‰ æ¬¢è¿Žä½¿ç”¨ Code Intelligence MCP Serverï¼
   Welcome to Code Intelligence MCP Server!

ðŸ’¡ æç¤º / Tip:
   è¿è¡Œ ci-setup-hook å¯ç”¨è‡ªåŠ¨ä¸Šä¸‹æ–‡æ³¨å…¥
   Run ci-setup-hook to enable automatic context injection

ðŸ“š æ–‡æ¡£ / Docs: https://github.com/Darkbluelr/code-intelligence-mcp#readme

EOF
    touch "$FIRST_RUN_FLAG"
fi

# Default values
LIMIT=10
MODE="semantic"
WORKSPACE=""
CI_CONFIG=""
EMBEDDING_CONFIG=""

show_help() {
    cat << EOF
ci-search - Code Intelligence Search CLI v${VERSION}

Usage:
  ci-search <query> [options]
  ci-search --help
  ci-search --version

Options:
  -l, --limit <n>     Max results (default: 10)
  -m, --mode <mode>   Search mode: semantic|keyword (default: semantic)
  -w, --workspace <n> Workspace name (default: main)
  --ci-config <file>  Path to ci-config.yaml
  --config <file>     Path to embedding config (.devbooks/config.yaml)
  -h, --help          Show this help
  -v, --version       Show version

Examples:
  ci-search "error handling"
  ci-search "authentication" --limit 20
  ci-search "api endpoint" --mode keyword
  ci-search "typecheck" --workspace demo-typescript
  ci-search "schema parse" --ci-config ./ci-config.yaml
EOF
}

show_version() {
    echo "ci-search v${VERSION}"
}

# Parse arguments
QUERY=""
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -v|--version)
            show_version
            exit 0
            ;;
        -l|--limit)
            LIMIT="$2"
            shift 2
            ;;
        -m|--mode)
            MODE="$2"
            shift 2
            ;;
        -w|--workspace)
            WORKSPACE="$2"
            shift 2
            ;;
        --ci-config)
            CI_CONFIG="$2"
            shift 2
            ;;
        --config)
            EMBEDDING_CONFIG="$2"
            shift 2
            ;;
        -*)
            echo "Unknown option: $1" >&2
            show_help
            exit 1
            ;;
        *)
            QUERY="$1"
            shift
            ;;
    esac
done

# Validate query
if [[ -z "$QUERY" ]]; then
    echo "Error: Query is required" >&2
    show_help
    exit 1
fi

# Run search script
if [[ -x "${SCRIPTS_DIR}/embedding.sh" ]]; then
    args=(search "$QUERY" --top-k "$LIMIT")
    if [[ "$MODE" == "keyword" ]]; then
        args+=(--provider keyword)
    fi
    if [[ -n "$WORKSPACE" ]]; then
        args+=(--workspace "$WORKSPACE")
    fi
    if [[ -n "$CI_CONFIG" ]]; then
        args+=(--ci-config "$CI_CONFIG")
    fi
    if [[ -n "$EMBEDDING_CONFIG" ]]; then
        args+=(--config "$EMBEDDING_CONFIG")
    fi
    exec bash "${SCRIPTS_DIR}/embedding.sh" "${args[@]}"
else
    echo "Error: embedding.sh not found or not executable" >&2
    exit 1
fi

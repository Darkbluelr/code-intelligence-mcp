# Claude Code / Codex CLI：自动工具编排 + 结果融合的上下文注入（单变更包交付）

> <truth-root> = `dev-playbooks/specs/`
> <change-root> = `dev-playbooks/changes/`
> Status: Pending（待 Judge 裁决）

> 治理约束（强制）：本次变更**所有任务必须在一个变更包里完成**，禁止拆分为多个变更包；若 Proposal Challenger 要求拆分，Proposal Judge **必须驳回拆分请求**（允许在同一变更包内重排优先级/范围，但不得拆包）。

## 🎯 结论先行（30秒阅读）

**本提案会导致**：
- ✅ 在 Claude Code 与 Codex CLI 中，用户输入后可在模型输出前自动执行“合适的”MCP 工具，并把结果回填进 Prompt
- ✅ 自动调用不再是“固定 1-2 个工具”，而是按意图/置信度/预算选择多工具，并做结果融合与解释（面向用户可读）
- ✅ 中英文都可触发自动注入（语言无关），并保留“可见 + 可控”的用户体验
- ✅ 明确 `hooks/context-inject-global.sh` 与新增 `hooks/auto-tool-orchestrator.sh` 的分工：前者做客户端适配入口，后者做可复用的编排内核

**本提案不会导致**：
- ❌ 不做 Cursor/其他 IDE 的适配（明确排除）
- ❌ 不改变 Thin Shell 架构约束（TypeScript 仍是薄壳，核心能力仍在 Shell 脚本 / MCP 工具侧）

**一句话总结**：把“工具自动调用 + 结果融合 + 可扩展适配”做成可维护的编排层，让 Claude Code/Codex CLI 在回答前自动把该查的都查了。

---

## 🤔 需求对齐（5分钟阅读）

### 你是谁？（角色定位）

请选择最符合你的描述：

- [ ] **效率型使用者**：希望“问一次就给完整答案”，可接受少量延迟
- [ ] **质量型维护者**：更关心准确性与可控性（工具计划/证据/可回滚）
- [ ] **平台扩展者**：未来要扩展到更多 AI 客户端/更多工具，需要清晰扩展点

**如果你不确定**：默认选择“质量型维护者”。

---

### 你要什么？（核心需求）

**基础需求（必须）**：
- [x] 解释 `hooks/context-inject-global.sh` 与 `hooks/auto-tool-orchestrator.sh` 的关系：不是替代关系；两者同时存在且职责清晰
- [x] 本次 change 只适配 Claude Code 与 Codex CLI，但适配逻辑必须容易扩展
- [x] 自动工具调用要“尽可能调用所有合适的”，并由我（提案）给出最佳实践决策
- [x] 中英文均可触发自动注入
- [x] 本次需要实现“自动结果融合 + 解释”，并兼顾用户体验与效率

**排除项（明确不做）**：
- [x] Cursor/其他 IDE 适配

---

### 你可能没想到什么？（隐藏需求）

#### 隐藏需求 1：无上限“全工具自动调用”会拖垮体验

**问题**：如果每次提问都把所有工具都跑一遍，你更在意“最全”还是“可接受的延迟/噪音”？

**为什么重要**：
- 过多工具会带来：延迟陡增、噪音干扰、错误传播、token 暴涨
- 结果融合需要“去重/聚合/溯源”，否则反而降低回答质量

**默认选择（提案给出决策）**：
- 采用“尽可能多，但有预算与置信度边界”的自动化策略（见下文 What/设计要点）

---

### 🎯 基于你的选择，推荐方案

默认推荐：**质量型维护者**路径
- 自动调用：按意图与置信度选择“合适的多工具组合”，但受预算与超时约束
- 输出：用户可见的 Tool Plan + 可折叠 Results + 最终融合解释
- 扩展：编排内核与客户端适配解耦，后续可加 Cursor 适配但不阻塞本次交付

---

## ✅ 批准流程（1分钟）

### 快速批准（推荐）

如果你同意“多工具自动化（带预算边界）+ 结果融合解释 + 仅 Claude/Codex 适配”的推荐方案：
- [ ] ✅ 我同意推荐方案，直接开始

如果你想自定义（例如更激进/更保守的自动调用策略）：
- [ ] 🔧 我想自定义方案（在 Debate Packet 的问题上给出选择）

默认选择：✅ 我同意推荐方案（24小时后自动批准）

---

## 📋 详细提案（AI阅读）

### Why（为什么要改）

#### 问题描述

当前用户需求已经明确从“低成本/低风险工具自动调用”升级为：
- 在模型输出前自动调用“所有合适的工具”，并把结果融合解释后回填
- 同时要兼顾延迟与可读性（用户体验），并支持中英文触发
- 仅做 Claude Code + Codex CLI 适配，但必须为未来扩展预留清晰扩展点

如果没有一个明确的“工具编排层”，会出现：
- 逻辑散落在不同 Hook/Wrapper 中，难扩展、难测试、难统一体验
- 自动化策略不可控（要么太少、要么无上限），导致效果不稳定

#### 影响

- 对最终用户：一次提问可获得更有证据、上下文更完整的回答
- 对维护者：集中式编排内核降低耦合，未来增加工具/客户端成本更低

---

### What（要改什么）

#### 目标

1) **“AI 输出前”自动工具调用**：在 Claude Code 与 Codex CLI 的调用链中保证工具先跑、结果后回填、最后再生成回答。

2) **多工具选择（尽可能调用合适的）**：
- 不是“固定 1-2 个”，而是基于意图/置信度/预算选择工具集合
- 同时避免无上限调用导致的延迟与噪音

3) **自动结果融合 + 解释（面向用户）**：
- 结构化回填（供模型稳定消费）
- 用户可读摘要（展示执行了哪些工具、为什么、得到什么结论/证据）

4) **中英文均可触发**：语言不应成为自动化的开关；意图识别需对中英文均有效。

5) **易扩展的适配层**：本次只实现 Claude Code/Codex CLI，但设计上要明确“新增客户端适配点”。

#### 范围

本次变更将交付（预期文件/模块，供后续 design/tasks 细化）：
- `hooks/auto-tool-orchestrator.sh`：编排内核（工具路由/预算/并发/降级/结果标准化/融合解释）
- `hooks/context-inject-global.sh`：作为客户端适配入口（Claude Code Hook / Codex CLI wrapper），调用编排内核
- `config/auto-tools.yaml`：白名单/阈值/预算/工具分层策略（默认值可用，支持覆盖）
- `docs/auto-tools.md`：用户说明（可见+可控、隐私/安全、常见问题）
- `tests/auto-tools.bats`：最小验证集（预算/降级/融合格式的契约测试）

本次明确不做：
- Cursor/其他 IDE 适配

---

#### 设计完善（对后续 Design Doc 的明确要求）

> 本小节用于满足“proposal.md 必须包含设计完善/设计要点内容”的要求（与下方“设计要点”互补）：列出必须在 `design.md` 中补齐并固化的关键设计点，避免实现阶段反推设计。

- **边界与契约**：客户端适配层（Claude Code Hook / Codex CLI wrapper）与编排内核（orchestrator）的输入/输出契约；错误码/退出码/输出 schema 的稳定性
- **自动调用策略**：白名单、置信度阈值、预算模型（总超时/并发/回填 token 上限）、超时/失败降级与重试规则
- **结果融合与解释**：结构化 JSON（供模型消费）与用户可读摘要（供终端展示）的格式；聚合/去重/溯源策略；top-k 限制与噪音抑制
- **中英文触发**：语言无关触发策略（中英关键词 + 结构信号），以及误触发/漏触发时的行为（例如自动降级、提示用户如何补充信息）
- **安全与隐私**：路径过滤/脱敏策略、默认采集边界、日志与可观测性（避免输出敏感内容到 prompt）
- **验收锚点**：如何在测试中验证“模型输出前已调用工具并回填”（含失败/超时降级的证据采集方式）

---

### 设计完善 / 设计要点（必须）

> 本节用于满足“proposal 需要完善里面的设计”的要求：只描述 What/Constraints/AC，不写实现步骤。

#### 设计要点 1：脚本职责分离（回答用户 Q1）

- `hooks/context-inject-global.sh`：**入口与适配层**
  - 负责从具体客户端（Claude Code Hook / Codex CLI wrapper）接收用户输入
  - 负责输出客户端所需的“标准 Hook 输出格式”（如 JSON）
  - 不承载复杂的工具选择与融合逻辑，避免入口脚本膨胀

- `hooks/auto-tool-orchestrator.sh`：**编排内核**
  - 输入：用户 prompt +（可选）隐式信号（文件/符号/历史）+ 预算配置
  - 输出：
    - Tool Plan（将要调用哪些工具 + 原因 + 参数 + 预算）
    - Tool Results（标准化结果 + 溯源信息）
    - Fused Context（结构化 JSON + 用户可读解释摘要）

**结论**：两者不是替代关系；二者都需要存在。入口脚本调用编排内核，内核可复用于更多客户端。

#### 设计要点 2：自动调用策略（回答用户 Q3）

“调用所有合适的工具”的最佳实践决策：

- **原则**：尽可能多地调用“有信息增益”的工具，但必须受以下边界约束：
  - 白名单（只允许安全/可控的工具自动调用）
  - 预算（最大耗时/最大并发/最大 token 回填）
  - 置信度阈值（意图不明确时不盲目扩散调用）
  - 降级策略（超时/失败时仍能给出可用回答，并明确提示）

- **分层**（推荐默认）：
  - Tier-0（默认总是可考虑）：`ci_index_status`（快且用于判断能否做更深检索）
  - Tier-1（高性价比）：`ci_search`、`ci_graph_rag`
  - Tier-2（条件触发）：`ci_call_chain`、`ci_bug_locate`、`ci_impact`、`ci_complexity`
  - Tier-3（高成本/高风险，默认不自动）：需要用户确认或在特定场景/预算允许时触发

这满足“尽可能调用合适的”，同时避免“无上限全调用”。

#### 设计要点 3：中英文触发（回答用户 Q4）

- 自动注入不以语言作为开关：中文与英文均进入同一意图识别/编排逻辑。
- 意图识别需要覆盖：中英关键词 + 结构信号（文件路径、报错、符号、代码块）。

#### 设计要点 4：结果融合与解释（回答用户 Q5、Q6）

- **结构化回填**：给模型的上下文应包含固定 schema（tool、reason、timestamp、source、payload 摘要、置信度）。
- **用户可读解释**：默认展示
  - [Auto Tools]：调用了哪些工具、为什么
  - [Results]：关键发现摘要（去重/合并），可折叠
  - [Limits]：预算/超时/降级说明
- **去噪与溯源**：top-k 限制、按文件/符号聚合、保留“来源”字段，避免“幻觉式融合”。

#### 设计要点 5：扩展点（回答用户 Q2）

- 客户端适配（Claude/Codex）与编排内核分离：新增客户端只需实现“输入采集 + 输出注入”适配层。
- 工具注册表配置化（`config/auto-tools.yaml`）：新增工具不改核心流程，仅添加配置与标准化规则。

#### 验收标准（AC-xxx）

- AC-001：Claude Code 与 Codex CLI 均能在“模型输出前”完成工具调用与上下文回填
- AC-002：中英文 prompt 均可触发自动编排（语言无关）
- AC-003：默认会生成 Tool Plan 并对用户可见；用户可关闭/降级自动调用（可控）
- AC-004：结果融合输出包含：结构化 JSON + 用户可读摘要，且有溯源字段
- AC-005：预算/超时/失败具备降级路径；降级时必须显式说明限制
- AC-006：工具调用策略遵循“尽可能调用合适的”，但不允许无上限全调用（必须有预算边界）
- AC-007：`hooks/context-inject-global.sh` 与 `hooks/auto-tool-orchestrator.sh` 的职责清晰且文档化

---

### Impact（影响分析）

#### Transaction Scope

`None`（不涉及跨服务事务；主要为本地 Hook/脚本/配置与 MCP 调用链调整）

#### 受影响的模块

| 模块 | 影响类型 | 影响程度 |
|------|----------|----------|
| `hooks/` | 新增/修改 | 高 |
| `config/` | 新增 | 中 |
| `docs/` | 新增/修改 | 中 |
| `tests/` | 新增/修改 | 中 |
| `src/` | 可选（若需对 MCP 调用参数/输出格式做适配） | 低-中 |

#### 兼容性

- 目标是默认不破坏现有“手动调用工具”的使用方式
- Hook/Wrapper 的输出应保持向后兼容：即使自动化关闭，也能输出空注入或仅注入项目画像

#### 风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 自动调用导致延迟增加 | 中 | 高 | 分层 + 预算 + 并发控制 + 缓存 + 降级 |
| 结果噪音反而干扰模型 | 中 | 中-高 | top-k、聚合去重、明确溯源、解释摘要 |
| 不同客户端调用链差异导致“未必能预调用” | 低-中 | 高 | 以 Hook/Wrapper 为强入口；在测试中验证“输出前调用” |
| 工具不可用/索引不可用导致失败 | 中 | 中 | 先 `ci_index_status`，并提供降级路径 |
| 安全/隐私风险（意外读到敏感文件） | 低-中 | 高 | 白名单 + 路径过滤 + 输出脱敏 + 明确提示 |

---

### Alternatives（备选方案）

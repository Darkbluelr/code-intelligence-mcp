现在让我基于提案内容和现有代码进行全面的质疑审查。我将按照"提案质疑提示词"的要求输出报告。

---

# Challenger 质疑报告

## 结论

**Revise（要求修改后再评审）**

**理由**：提案在架构设计、可行性验证、安全边界与范围收敛方面存在多处阻断性缺口，且部分设计决策缺乏充分证据支撑。虽然目标明确且具有价值，但当前设计存在"过度设计 vs 可交付性"的矛盾，需要在保持单变更包约束的前提下进一步收敛范围、补齐验证路径并明确降级策略。

---

## 1. 阻断项（Blocking）

### B1. Codex CLI 会话连续性方案的可行性未经验证

**问题**：
- 提案第 273-277 行声明"session_id 来源：wrapper 以 `codex exec --json` / `codex exec resume --json` 运行，解析 JSON 事件中的 `session_id`"
- **证据缺口**：未提供 `codex exec --json` 输出格式的实际样例或文档引用
- **风险**：若 Codex CLI 不输出 `session_id` 或输出格式不稳定，整个会话连续性方案将失效

**要求**：
1. 补充 `codex exec --json` 的实际输出样例（至少包含 session_id 字段的 JSON 结构）
2. 若 Codex CLI 不支持 `--json` 或不输出 session_id，必须提供替代方案（如基于 PID/时间戳的本地会话管理）
3. 在 AC-002 中补充"若 Codex CLI 不支持 JSON 输出，降级为无会话模式"的验证锚点

**引用**：proposal.md:273-277, 539

---

### B2. 编排内核与入口层的错误传播契约不完整

**问题**：
- 提案定义了 `error.code` 枚举（461-471 行）和入口层退出码（473-479 行），但未明确：
  - 编排内核（`auto-tool-orchestrator.sh`）如何向入口层传递错误码？（通过退出码？JSON 字段？stderr？）
  - 入口层如何区分"编排内核不可用"（如脚本不存在）vs"编排执行失败"（如工具超时）？
- **风险**：错误传播不明确会导致降级逻辑混乱，用户无法区分"自动化关闭"vs"自动化失败"

**要求**：
1. 明确编排内核的输出接口：成功时输出 JSON 到 stdout + 退出码 0；失败时输出错误 JSON（含 `error.code`）到 stdout + 非零退出码
2. 补充入口层的错误处理伪代码：如何根据编排内核的退出码与 JSON 输出决定降级策略
3. 在 AC-008 中补充"编排内核不可用时，入口层输出空注入 + [Limits] 说明"的验证

**引用**：proposal.md:461-479, 545

---

### B3. 安全边界的"参数裁剪"规则缺乏强制执行机制

**问题**：
- 提案第 337-341 行定义了参数上限（如 `ci_graph_rag.depth <= 2`），但未说明：
  - 谁负责裁剪？编排内核？还是工具调用前的参数验证层？
  - 若用户在 prompt 中写"depth=10"，如何保证不被透传？
- **风险**：若参数裁剪仅依赖"配置默认值"而非"强制校验"，恶意或误操作的 prompt 可能绕过限制

**要求**：
1. 明确参数裁剪的执行位置：建议在编排内核的"工具路由"阶段强制校验并裁剪参数
2. 补充参数裁剪的伪代码或规则表（输入参数 → 校验 → 裁剪/拒绝）
3. 在 AC-006 中补充"构造超限参数的 prompt，验证参数被裁剪且 [Limits] 说明原因"

**引用**：proposal.md:337-341, 543

---

### B4. 范围膨胀风险：MVP 与"可选/后续"的边界模糊

**问题**：
- 提案第 218-229 行定义了"同包分阶段"策略，但未明确：
  - MVP 的"必须交付"范围是否包含 Tier-2 的"条件触发"逻辑？
  - "条件触发"的实现复杂度（意图识别 + 预算动态调整）是否会拖累 MVP 交付？
- **风险**：若 MVP 包含过多"条件触发"逻辑，可能导致本次变更无法按时交付或质量不可控

**要求**：
1. 明确 MVP 的最小可交付范围：建议仅包含 Tier-0/1 的自动调用 + 控制面 + 安全边界 + 契约测试
2. 将 Tier-2 的"条件触发"标注为"可选/后续"，并在 AC-009 中补充"MVP 仅验证 Tier-0/1 自动，Tier-2 默认不触发"
3. 在 Decision Log 中补充"若 MVP 交付时间紧张，Tier-2 可延后到下一轮迭代"的回退路径

**引用**：proposal.md:218-229, 546

---

## 2. 遗漏项（Missing）

### M1. 缺少"编排内核不可用"时的用户可见提示

**问题**：
- 提案定义了 fail-open 策略（315 行），但未说明：
  - 若 `hooks/auto-tool-orchestrator.sh` 不存在或无执行权限，用户如何知道"自动化未生效"？
  - 是否在 [Limits] 中输出"编排内核不可用，已降级为空注入"？
- **影响**：用户可能误以为"自动化已开启但无结果"，导致困惑

**建议**：
1. 在入口层（`context-inject-global.sh`）检测编排内核是否可用，若不可用则在 [Limits] 输出明确提示
2. 补充 AC："编排内核不存在时，输出包含 [Limits] 说明'auto-tool-orchestrator.sh not found'"

**引用**：proposal.md:315, 545

---

### M2. 缺少"工具输出包含二进制/超大内容"的处理策略

**问题**：
- 提案第 353 行提到"二进制/超大文件：默认跳过或仅回填元信息"，但未定义：
  - 如何判断"二进制"？（MIME 类型？文件扩展名？内容检测？）
  - "超大"的阈值是多少？（1MB？10MB？）
  - 元信息包含哪些字段？（路径 + 大小 + 哈希？）
- **影响**：若工具返回大量二进制内容，可能导致 token 暴涨或解析失败

**建议**：
1. 明确二进制检测规则：优先使用 `file` 命令检测 MIME 类型，降级到扩展名黑名单
2. 定义超大文件阈值：建议 500KB（对齐 ripgrep 的 `--max-filesize`）
3. 补充元信息格式：`{file: "path", size: 1024, type: "binary", hash: "sha256:..."}`

**引用**：proposal.md:353

---

### M3. 缺少"中英文触发"的误触发/漏触发降级策略

**问题**：
- 提案第 208 行提到"误触发/漏触发时的行为（例如自动降级、提示用户如何补充信息）"，但未给出具体规则
- **影响**：若意图识别不准确，可能导致"非代码问题触发自动化"或"代码问题未触发自动化"

**建议**：
1. 定义误触发降级：若意图置信度 < 0.3，输出 [Limits] 提示"意图不明确，已跳过自动工具调用"
2. 定义漏触发提示：若用户 prompt 包含代码符号但未触发，在 [Limits] 提示"可尝试使用 @file 引用或明确指令词"
3. 补充 AC："构造低置信度 prompt，验证降级逻辑与 [Limits] 提示"

**引用**：proposal.md:208

---

### M4. 缺少"Codex wrapper 安装后的验证命令"

**问题**：
- 提案第 532 行提到验证命令 `codex-auto --dry-run "ping"`，但未说明：
  - 若 `codex-auto` 不在 PATH 中，如何引导用户排查？
  - 验证输出的"成功标志"是什么？（包含 `schema_version`？退出码 0？）
- **影响**：用户安装后无法确认"wrapper 是否正常工作"

**建议**：
1. 补充验证命令的完整输出样例（包含 `schema_version`、`run_id`、`tool_plan` 等字段）
2. 在安装文档中补充"若 `codex-auto` 不可用，检查 PATH 或使用绝对路径"
3. 补充 AC："执行验证命令，断言输出包含 `schema_version` 且退出码为 0"

**引用**：proposal.md:532

---

## 3. 非阻断项（Non-blocking）

### N1. 预算默认值的取值依据不够充分

**问题**：
- 提案第 363-370 行给出了具体预算值（如总墙钟 5000ms、并发 3），但未说明：
  - 这些值是基于实测数据？还是经验估算？
  - 若实际环境中工具响应时间超出预期，如何调整？
- **影响**：预算过紧可能导致频繁超时；过松可能影响用户体验

**建议**：
1. 在提案中补充"预算值基于现有 `context-inject-global.sh` 的默认超时（如 `SEARCH_TIMEOUT=2`）"
2. 在配置文档中说明"用户可通过 `config/auto-tools.yaml` 或环境变量覆盖默认值"
3. 在 AC-007 中补充"模拟慢工具响应，验证超时降级与 [Limits] 说明"

**引用**：proposal.md:363-370, hooks/context-inject-global.sh:39

---

### N2. 结果融合的"冲突结论呈现"规则过于简化

**问题**：
- 提案第 506-508 行定义了冲突结论的呈现规则："若相同去重键出现互斥结论，则在 [Results] 输出'冲突条目'并列出来源工具与时间"
- **不足**：未定义"互斥结论"的判断标准（如何判断两条结论是"冲突"而非"补充"？）
- **影响**：可能导致误报冲突或漏报冲突

**建议**：
1. 明确"互斥结论"的判断规则：例如"同一符号的定义位置不同"或"同一文件的复杂度评分差异 > 50%"
2. 在融合逻辑中补充"若无法判断是否冲突，标记为'需人工判断'并输出所有来源"
3. 在 AC-011 中补充"构造冲突结论样例，验证冲突标记与来源输出"

**引用**：proposal.md:506-508

---

### N3. 安装脚本的"覆盖旧脚本"策略缺少备份机制

**问题**：
- 提案第 522 行提到"升级：重复运行 `./install.sh --with-hook` 覆盖旧脚本（保留 settings 备份）"
- **不足**：未说明是否备份旧的 `context-inject-global.sh`（若用户有自定义修改，覆盖后无法恢复）
- **影响**：用户升级后可能丢失自定义配置

**建议**：
1. 在安装脚本中补充"覆盖前备份旧脚本到 `~/.claude/hooks/context-inject-global.sh.bak`"
2. 在升级文档中说明"若需恢复旧版本，可从备份文件恢复"
3. 在 AC 中补充"重复安装，验证旧脚本被备份"

**引用**：proposal.md:522, install.sh:78-80

---

## 4. 替代方案

### A1. 简化 Tier-2 触发逻辑，降低 MVP 复杂度

**当前方案**：Tier-2 工具需要"条件触发"（意图=modify/debug 且明确给出文件/符号/报错）或"用户确认触发"

**替代方案**：
- MVP 阶段：Tier-2 默认完全关闭（`CI_AUTO_TOOLS_TIER_MAX=1`），仅在用户显式设置 `CI_AUTO_TOOLS_TIER_MAX=2` 时启用
- 后续迭代：补充"条件触发"逻辑（基于意图分析与预算动态调整）

**优势**：
- 降低 MVP 复杂度，减少"意图识别不准确"导致的误触发风险
- 保留扩展性，后续可逐步增强触发逻辑

**劣势**：
- 用户需要手动开启 Tier-2，初期体验可能不如"智能触发"

**建议**：在 Decision Log 中补充"MVP 采用简化方案，Tier-2 默认关闭"的裁决

---

### A2. 将 Codex CLI 会话连续性标注为"可选/后续"

**当前方案**：MVP 必须实现 Codex CLI 的会话连续性（session_id 保存与恢复）

**替代方案**：
- MVP 阶段：Codex CLI 仅支持"单次注入"（入口 B），不保证会话连续性
- 后续迭代：补充 wrapper 的会话管理逻辑（入口 A）

**优势**：
- 降低 MVP 对 Codex CLI 内部机制的依赖，减少"session_id 不可用"的风险
- 保留扩展性，后续可逐步完善 wrapper

**劣势**：
- 用户在 Codex TUI 内的多轮对话无法复用上下文

**建议**：在 Decision Log 中补充"若 Codex CLI 会话连续性验证失败，可降级为单次注入"的回退路径

---

## 5. 风险与证据缺口

### R1. 编排内核的"并发调用"实现复杂度被低估

**风险**：
- 提案第 364 行定义"并发上限：3"，但未说明：
  - 如何实现并发？（Bash 的 `&` + `wait`？GNU Parallel？）
  - 如何处理并发工具的输出顺序？（是否需要按 tool_plan 顺序合并？）
- **证据缺口**：未提供并发调用的伪代码或实现草案

**影响**：
- 若并发实现不当，可能导致输出乱序、死锁或资源泄漏
- 若依赖外部工具（如 GNU Parallel），增加安装依赖

**建议**：
1. 在设计文档中补充并发调用的伪代码（建议使用 Bash 的 `&` + `wait` + 临时文件收集输出）
2. 在 AC-007 中补充"并发调用 3 个工具，验证输出顺序与 tool_plan 一致"
3. 若并发实现复杂度过高，可在 MVP 中降级为"顺序调用"

**引用**：proposal.md:364

---

### R2. 提示注入防护的"疑似注入模式"检测规则未定义

**风险**：
- 提案第 458 行提到"当发现'疑似提示注入/越权指令'模式时：删除/脱敏该段"
- **证据缺口**：未定义"疑似注入模式"的具体规则（如正则表达式、关键词列表）

**影响**：
- 若检测规则过严，可能误删正常工具输出
- 若检测规则过松，可能漏过真实注入攻击

**建议**：
1. 在安全边界部分补充"疑似注入模式"的检测规则（如 `ignore previous instructions`、`execute rm -rf`、`system("...")`）
2. 在 AC-010 中补充"构造包含注入模式的工具输出，验证被过滤且 [Limits] 说明"
3. 在配置文档中说明"用户可通过 `config/auto-tools.yaml` 自定义注入模式黑名单"

**引用**：proposal.md:458, 547

---

### R3. repo-root 判定在"非 git 场景"的兜底逻辑可能导致路径泄露

**风险**：
- 提案第 348 行定义"无 git 场景：使用 `pwd` 作为 repo-root"
- **证据缺口**：未说明若用户在 `/tmp` 或 `/home/user` 等敏感目录运行，是否会泄露路径

**影响**：
- 若 repo-root 为 `/tmp`，路径过滤可能失效（允许读取 `/tmp` 下的所有文件）
- 若 repo-root 为 `/home/user`，可能泄露用户目录结构

**建议**：
1. 在路径过滤规则中补充"若 repo-root 为 `/tmp` 或 `/home/*`，输出 [Limits] 警告'repo-root 可能不安全，建议在 git 仓库内运行'"
2. 在 AC-005 中补充"在 `/tmp` 运行，验证 [Limits] 包含安全警告"
3. 在配置文档中说明"建议在 git 仓库内运行，避免路径过滤失效"

**引用**：proposal.md:348, 542

---

## 总结

本提案在目标定位、架构分层与验收标准方面已有较好基础，但在**可行性验证**（Codex CLI 会话连续性）、**错误传播契约**（编排内核与入口层）、**安全边界强制执行**（参数裁剪）与**范围收敛**（MVP vs 可选）方面存在阻断性缺口。

**核心建议**：
1. **优先补齐 B1-B4 的阻断项**，特别是 Codex CLI 会话连续性的可行性验证与 MVP 范围收敛
2. **简化 Tier-2 触发逻辑**，建议 MVP 仅实现 Tier-0/1 自动 + 控制面 + 安全边界
3. **补充错误传播契约与参数裁剪的强制执行机制**，避免降级逻辑混乱与安全边界被绕过
4. **在 Decision Log 中明确回退路径**：若 Codex CLI 会话连续性验证失败，可降级为单次注入；若 MVP 交付时间紧张,Tier-2 可延后

**裁决依据**：
- 阻断项 B1-B4 直接影响可交付性与安全性，必须在进入 Design 阶段前解决
- 遗漏项 M1-M4 影响用户体验与可维护性，建议在 Design 阶段补齐
- 非阻断项 N1-N3 与风险 R1-R3 可在实现阶段逐步完善，但需在 Design 中预留扩展点

# 提案质疑报告

> **提案**: augment-final-10-percent
> **Challenger**: AI Reviewer
> **审查日期**: 2026-01-17

---

## 1. 风险识别

### 风险-001: LLM Provider 抽象层的复杂度被低估

**描述**: 提案建议使用"Bash 函数级抽象"作为 LLM Provider 实现方式，但当前 `common.sh` 已有约 700 行代码包含了 LLM 调用相关函数（`_llm_call_anthropic`、`_llm_call_openai`、`_llm_call_ollama`）。新增 Provider 抽象层可能导致：

- `common.sh` 进一步膨胀，违反单一职责原则
- 现有调用点需要大规模重构
- 测试覆盖要求翻倍（每个 Provider 都需要独立测试）

**建议**:
- 明确列出需要修改的现有调用点清单
- 考虑将 LLM 相关函数独立到 `scripts/llm-provider.sh`（提案中已提及但未说明迁移计划）
- 补充向后兼容性策略

### 风险-002: 数据流追踪深度限制不明确

**描述**: 提案声称支持"多函数链式"数据流追踪，但：

- 当前 `call-chain.sh` 最大深度限制为 4（代码第 217 行）
- 提案 AC-004 仅要求"支持 >= 3 跳函数调用"
- 未说明深度超过限制时的降级策略

**建议**:
- 明确最大追踪深度（建议限制在 5-6 跳以避免组合爆炸）
- 定义循环依赖检测的处理方式（当前 `call-chain.sh` 已有 `CYCLE_DETECTED` 但未在提案中提及）
- 补充性能预算（每跳预期延迟）

### 风险-003: 击键级请求取消的架构约束

**描述**: 当前 `daemon.sh` 使用文件系统信号机制（`$DAEMON_CANCEL_DIR/$request_id`），轮询间隔为 50ms（代码第 39 行 `DAEMON_CANCEL_CHECK_INTERVAL_MS:=50`）。提案要求 <10ms 但：

- 文件系统操作本身有 I/O 延迟
- 使用信号机制（SIGUSR1）替代轮询需要重写守护进程架构
- macOS 和 Linux 信号行为差异未考虑

**建议**:
- 补充具体的技术方案比较（轮询 vs 信号 vs 共享内存）
- 定义目标平台（macOS/Linux/Both）
- 增加性能测试 baseline 数据

### 风险-004: 联邦图查询的网络故障处理缺失

**描述**: `federation-lite.sh` 已实现本地索引功能（约 1700 行），但提案中"HTTP 桥接远程仓库索引"缺少：

- 网络超时策略
- 认证机制（跨仓库访问可能需要 token）
- 断路器模式（远程服务不可用时的降级）
- 数据一致性保证（本地索引与远程索引版本冲突）

**建议**:
- 定义联邦查询的 SLA（延迟、可用性）
- 补充认证/授权设计
- 描述离线模式行为

### 风险-005: 对话长期记忆存储方案的可扩展性

**描述**: 提案建议使用 SQLite + 向量搜索扩展，但：

- 当前 `intent-learner.sh` 使用 JSON 文件（代码第 57 行 `INTENT_HISTORY_PATH`）
- JSON -> SQLite 迁移路径未定义
- 向量索引的 embedding 模型未指定（ollama? 自研?）
- 向量维度和索引算法选择影响召回率

**建议**:
- 明确迁移策略（增量迁移 vs 全量迁移）
- 选定 embedding 模型并声明维度
- 定义向量搜索的召回率指标

---

## 2. 遗漏检测

### 遗漏-001: 缺少错误处理和日志规范

**描述**: 10 个 Milestone 均未提及统一的错误处理策略：

- 错误码定义（当前 `common.sh` 定义了 `EXIT_SUCCESS/EXIT_ARGS_ERROR/EXIT_DEPS_MISSING/EXIT_RUNTIME_ERROR`，但提案未扩展）
- 结构化日志格式（JSON 日志用于可观测性）
- 异常边界定义

**建议**: 补充错误处理规范章节

### 遗漏-002: 缺少性能基准测试计划

**描述**: 提案声称多项性能提升目标，但缺少：

- 当前基线数据（P95 延迟是多少？压缩率是多少？）
- 测试方法论（合成 benchmark vs 真实工作负载）
- 性能回归检测机制

**建议**:
- 在 AC-005/006/008/009 中补充基线数据
- 定义性能测试脚本（可复用 `scripts/benchmark.sh`）

### 遗漏-003: 缺少用户文档更新计划

**描述**: 新增 7 个脚本文件，但未说明：

- CLI 帮助信息规范
- README 更新范围
- 与现有 `docs/Augment.md` 的关系

**建议**: 补充文档同步计划或引用 `devbooks-docs-sync`

### 遗漏-004: 缺少功能开关/渐进发布策略

**描述**: 当前 `config/features.yaml` 支持功能开关，但提案未说明：

- 新功能的默认开启状态
- 灰度发布计划
- 回滚机制

**建议**: 为 P0 功能定义功能开关名称和默认值

### 遗漏-005: 缺少跨模块依赖图

**描述**: 提案 Impact 部分列出了受影响模块，但缺少：

- 模块间依赖关系
- 变更顺序约束（哪些模块必须先完成）
- 并行开发可行性分析

**建议**: 补充模块依赖图（Mermaid 格式）

---

## 3. AC 完整性检查

### AC-001 ~ AC-002: LLM 重排序

- **AC-001**: "支持 Anthropic/OpenAI/Ollama 三种 Provider" - **需要补充**: Mock Provider 是否作为第四种用于测试？
- **AC-002**: "Provider 切换无需修改调用代码" - **缺少量化指标**: 切换延迟是否有上限？

### AC-003: 语义异常检测

- **当前版本**: "识别 >= 3 种异常模式"
- **问题**: 未定义"异常模式"的精确边界。建议枚举：
  1. 缺失错误处理
  2. 不一致 API 调用
  3. 命名约定违规
  4. 遗漏日志/监控

### AC-004: 数据流追踪

- **当前版本**: "支持 >= 3 跳函数调用"
- **需要补充**:
  - 最大支持跳数
  - 跨文件追踪是否在范围内
  - 循环依赖如何报告

### AC-005: 请求取消延迟

- **当前版本**: "P95 < 10ms"
- **需要补充**:
  - 测试环境定义（CPU/内存/并发数）
  - 冷启动 vs 热启动场景

### AC-006: 上下文压缩率

- **当前版本**: ">= 50%"
- **需要补充**:
  - 压缩前后语义保留度指标
  - 不同代码库规模的预期变化

### AC-007: 对话记忆

- **当前版本**: ">= 100 轮历史"
- **需要补充**:
  - 召回准确率指标
  - 存储空间预算

### AC-008 ~ AC-010: 性能指标

- **问题**: 性能测试的环境未标准化
- **建议**: 补充标准测试环境定义

---

## 4. 可行性质疑

### M1: LLM 重排序抽象接口

**质疑点**:
- **工作量低估**: 当前 `common.sh` 中已有 LLM 函数分散在多处，迁移到独立模块需要更新所有调用方
- **测试负担**: 每个 Provider 需要独立的集成测试（API Key 管理、Mock 策略）
- **兼容性风险**: OpenAI 和 Ollama 的响应格式差异可能超出简单抽象层能处理的范围

**建议**: 分两阶段实现
1. 先重构现有代码到独立文件
2. 再添加新 Provider

### M2: 语义异常检测

**质疑点**:
- **依赖 pattern-learner**: 当前 `pattern-learner.sh`（约 1300 行）支持学习和检测，但异常检测逻辑（代码第 785-850 行）仅覆盖 `async_try_catch` 和 `error_logging`
- **准确率未定义**: "异常"的判定标准是什么？误报率上限？

**建议**:
- 先定义异常类型清单
- 设定误报率目标（如 <20%）

### M3: 跨函数数据流追踪

**质疑点**:
- **技术复杂度高**: 静态分析难以处理动态类型语言的间接调用
- **SCIP 限制**: SCIP 索引不包含运行时数据流信息
- **性能风险**: 多跳追踪可能导致指数级增长

**建议**:
- 明确限制为"静态可推断的数据流"
- 设置追踪时间上限（如 500ms）

### M4: 击键级请求取消

**质疑点**:
- **架构变更大**: 从文件信号机制改为系统信号需要重写守护进程
- **平台差异**: macOS 和 Linux 的信号处理行为不一致
- **竞态条件风险高**: 提案已识别但未给出具体解决方案

**建议**:
- 考虑使用共享内存替代文件系统
- 增加竞态条件测试用例

### M5: 上下文智能压缩

**质疑点**:
- **AST 骨架提取**: 需要支持多语言（TS/JS/Python/Go），工作量大
- **语义丢失风险**: 移除实现细节可能丢失关键上下文
- **Token 预算感知**: 需要与不同 LLM 的 tokenizer 集成

**建议**:
- 先支持 TypeScript 单语言
- 定义语义保留度量化指标

### M6: 对话长期记忆

**质疑点**:
- **数据迁移**: 从 JSON 到 SQLite 需要无损迁移
- **向量化依赖**: 需要外部 embedding 服务或本地模型
- **召回质量**: 100 轮历史的召回准确率如何保证？

**建议**:
- 分阶段：先实现 SQLite 存储，再添加向量搜索
- 定义召回率指标（如 Top-5 准确率 >= 80%）

### M7: 联邦图查询

**质疑点**:
- **安全性**: HTTP 桥接需要认证机制
- **数据一致性**: 跨仓库索引版本可能不一致
- **延迟**: P95 < 500ms 在网络抖动时可能难以保证

**建议**:
- 定义本地缓存 TTL
- 增加认证机制设计

### M8: COD 实时更新

**质疑点**:
- **平台依赖**: `fswatch` (macOS) vs `inotify` (Linux) 行为差异
- **防抖动阈值**: 500ms 是否适用于所有场景？
- **增量更新算法**: 仅更新变更节点的算法复杂度

**建议**:
- 使用跨平台库（如 chokidar）或双实现
- 允许用户配置防抖动阈值

### M9: A-B 路径可视化

**质疑点**:
- **Mermaid 限制**: 大型图可能超出 Mermaid 渲染能力
- **交互性**: 静态 Mermaid 图不支持折叠/展开

**建议**:
- 设置节点数上限（如 50）
- 超出时提供文本摘要

### M10: 架构漂移检测

**质疑点**:
- **快照格式**: 未定义快照的数据结构
- **对比算法**: 如何量化"模块边界模糊化"？
- **告警阈值**: 什么程度的漂移触发告警？

**建议**:
- 定义漂移指标（如耦合度变化 > 10%）
- 设计快照 schema

---

## 5. 结论

### 建议：**Revise**

### 必须修复的问题

| 优先级 | 问题 | 所属 Milestone |
|--------|------|----------------|
| P0 | 补充性能测试基线数据 | M4/M5/M8/M9 |
| P0 | 定义功能开关策略 | 全局 |
| P0 | 补充数据迁移计划（JSON -> SQLite） | M6 |
| P1 | 明确最大追踪深度和降级策略 | M3 |
| P1 | 补充跨平台兼容性说明 | M4/M8 |
| P1 | 定义联邦查询认证机制 | M7 |
| P2 | 补充模块依赖图 | Impact 章节 |
| P2 | 定义架构漂移的量化指标 | M10 |

### 建议的优化

1. **分阶段交付**: 将 P0 功能进一步拆分为可独立验收的子任务
2. **增加 Spike**: 对 M4（击键级取消）和 M3（数据流追踪）先做技术验证 spike
3. **定义回滚计划**: 为每个 Milestone 定义回滚检查点
4. **补充可观测性**: 为新功能添加 metrics 埋点设计

---

## 附录：代码引用

| 文件 | 行号 | 关键发现 |
|------|------|----------|
| `common.sh` | 483-769 | 现有 LLM 调用函数，需要重构 |
| `call-chain.sh` | 209-217 | 深度限制为 4 |
| `daemon.sh` | 39 | 取消检查间隔 50ms |
| `federation-lite.sh` | 1-200 | 快速路径虚拟边生成 |
| `intent-learner.sh` | 57 | JSON 文件存储路径 |
| `pattern-learner.sh` | 785-850 | 异常检测当前仅覆盖 2 种模式 |

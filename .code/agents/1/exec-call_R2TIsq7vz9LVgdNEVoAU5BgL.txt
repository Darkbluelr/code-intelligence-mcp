     1	**<truth-root>**: `dev-playbooks/specs/`  **<change-root>**: `dev-playbooks/changes/`
     2	
     3	## Why（问题与目标）
     4	
     5	- Change-ID：`optimize-indexing-pipeline-20260117`
     6	- Status：`Approved`（已裁决）
     7	- 背景与证据（已阅读）：
     8	  - `scripts/indexer.sh` 当前实现为文件监听后触发全量生成 `index.scip`（无增量链路）
     9	  - `scripts/ast-delta.sh` 已实现单文件增量更新（tree-sitter → 更新 `graph.db`），但未被 `scripts/indexer.sh` 串联
    10	  - `scripts/scip-to-graph.sh` 在缺少本地文件时会下载 `scip.proto`（存在网络依赖，离线/受限网络下会断链）
    11	  - `src/server.ts` 的 `ci_index_status` 会把 `status/build/clear` 直接透传给 `scripts/indexer.sh`（当前脚本参数模型与该调用方式存在语义不匹配风险）
    12	- 核心问题（待解决）：
    13	  1) 文件变更触发“全量索引”导致延迟与资源浪费，降低上下文近实时性
    14	  2) 关键索引链路对网络有硬依赖，降低可用性与可复现性
    15	  3) “索引状态”工具与脚本职责边界不清，存在契约漂移风险
    16	- 目标（本变更包只聚焦 P0 链路打通）：
    17	  1) 打通“文件变更 →（优先）增量更新 `graph.db` →（必要时）回退全量重建”的闭环
    18	  2) `scripts/scip-to-graph.sh` 默认离线可运行（不依赖在线下载）
    19	  3) 明确 `ci_index_status` 的语义与脚本职责边界，避免继续漂移（见 Debate Packet）
    20	
    21	## What Changes（范围、非目标、影响范围）
    22	
    23	### 范围（In Scope）
    24	
    25	1) `scripts/indexer.sh`：将监听到的变更“尽可能”走增量链路
    26	   - 监听器将变更文件路径传递给索引执行函数（避免每次变化都全量重建）
    27	   - 当满足条件时调用 `scripts/ast-delta.sh update <file>` 增量更新 `graph.db`
    28	   - 当不满足条件时回退到现有全量索引（生成 `index.scip`），并在成功后调用 `scripts/scip-to-graph.sh parse --incremental` 同步 `graph.db`
    29	   - 增量/回退路径均需保持幂等（重复触发不会破坏索引状态）
    30	2) `scripts/scip-to-graph.sh`：离线化 `scip.proto` 来源
    31	   - 引入“本地优先”的 proto 发现策略（例如：优先使用仓库内固定版本的 `scip.proto`；仅在明确允许时再下载）
    32	   - 保留向后兼容的降级路径（避免现有用户环境被突然破坏）
    33	3) 配置与开关（仅限于支撑上述行为的最小变更）
    34	   - 允许从 `config/features.yaml` 读取是否启用增量（例如 `features.ast_delta.enabled`），或提供等价环境变量开关
    35	
    36	### 非目标（Out of Scope）
    37	
    38	- 引入新的向量数据库/`sqlite-vec`、改造 `scripts/embedding.sh` 存储模型
    39	- 引入 LSP、容器沙盒、联邦学习、神经符号验证等“代理框架/训练平台”方向能力
    40	- 改动 `graph-store.sh` 的 Schema（除非验证后确认是必要的最小修复）
    41	- 变更 MCP 工具清单或对外入参（本提案只要求“行为更正确/更快”，不扩展对外 API）
    42	
    43	### 影响范围（Where）
    44	
    45	- 脚本：`scripts/indexer.sh`、`scripts/ast-delta.sh`、`scripts/scip-to-graph.sh`
    46	- 数据与缓存：`index.scip`、`.devbooks/graph.db`、`.devbooks/ast-cache/`（路径以运行时配置为准）
    47	- MCP 行为：`ci_index_status` 的“语义归属”需要被裁决（否则后续实现无法保证兼容性）
    48	
    49	## Impact（对外契约/数据/模块/测试/价值信号/价值流瓶颈假设）
    50	
    51	**Transaction Scope**: `Single-DB`
    52	
    53	### 对外契约（External Contract）
    54	
    55	- MCP 工具层：
    56	  - `ci_index_status`（`src/server.ts`）当前把 `status/build/clear` 传给 `scripts/indexer.sh`。本提案要求在实现阶段明确该工具的真实语义，并确保对外接口不破坏既有使用方式（见 DP-01）。
    57	- CLI 层：
    58	  - 若 `scripts/indexer.sh` 增加新子命令/参数，必须保持现有 `--install/--uninstall/--status` 等入口不被破坏（当前脚本已支持这些选项）。
    59	
    60	### 数据影响（Data）
    61	
    62	- `.devbooks/graph.db`：
    63	  - 写入频率会上升（增量更新更频繁），需确保并发安全与可恢复（当前已启用 WAL 的配置路径存在，但需在实现阶段验证）。
    64	- `.devbooks/ast-cache/`：
    65	  - 将成为增量路径的关键缓存；需要明确清理与版本戳策略（现有 `scripts/ast-delta.sh` 已包含版本戳与清理逻辑，后续需验证与 `indexer.sh` 的协作边界）。
    66	- `index.scip`：
    67	  - 仍作为全量回退路径产物存在；回退路径成功后需要保证 `graph.db` 与 `index.scip` 至少在“同一时间点”语义上可对齐（通过 parse --incremental 达到近似对齐）。
    68	
    69	### 模块影响（Modules）
    70	
    71	- Indexer 责任边界会更清晰：监听/节流/调度 vs 解析/写库（增量由 `ast-delta.sh` 负责，SCIP 解析由 `scip-to-graph.sh` 负责）。
    72	
    73	### 测试影响（Tests）
    74	
    75	- 本提案不修改 `tests/**`（符合宪法 GIP-02 的约束）。
    76	- 但实现落地后，建议由后续角色补充/强化对 `scripts/indexer.sh` 的契约测试（例如：传入变更文件时走增量、不可增量时走回退、离线环境不触发下载）。
    77	
    78	### 价值信号（Value Signals）
    79	
    80	- 交互延迟：文件保存后索引刷新从“秒级/分钟级”趋近“<1s（增量优先）”
    81	- 上下文新鲜度：Graph-RAG/影响分析的图数据更接近当前工作区状态
    82	- 可用性：受限网络/离线环境下仍可完成索引链路
    83	
    84	### 价值流瓶颈假设（Value Stream Bottleneck Hypothesis）
    85	
    86	- 当前瓶颈在“全量索引触发频率高且代价大”，导致开发者得到的上下文滞后，从而在 AI 辅助改代码时引入更多“无效回合”（反复问、反复修正）。
    87	- 通过“增量优先 + 可靠回退”，可以把瓶颈从“索引计算”移动到“检索与组织上下文”，为后续 P1（本地混合检索）留出空间。
    88	
    89	### Impact Analysis（可直接落地的影响分析）
    90	
    91	#### 1) Scope（变更边界）
    92	
    93	**In（本变更包覆盖）**：
    94	- `scripts/indexer.sh`：文件变更触发时引入“增量优先（`ast-delta.sh update`）+ 全量回退（生成 `index.scip` + `scip-to-graph.sh parse --incremental`）”的调度逻辑
    95	- `scripts/scip-to-graph.sh`：`scip.proto` 获取策略改为“本地优先”，默认离线可运行
    96	- （条件，取决于 DP-01）`src/server.ts`、`README.md`：对齐 `ci_index_status` 的真实语义与其调用脚本
    97	
    98	**Out（明确不做）**：
    99	- `scripts/embedding.sh` 的存储形态迁移（例如 SQLite/`sqlite-vec`）、混合检索 RRF
   100	- `scripts/graph-store.sh` Schema 变更或图查询算法重写
   101	- 引入 LSP、容器沙盒、联邦学习、神经符号验证等“代理框架/训练平台”能力
   102	
   103	**直接影响（代码/脚本，确定）**：2 个文件
   104	- `scripts/indexer.sh`
   105	- `scripts/scip-to-graph.sh`
   106	
   107	**直接影响（代码/文档，条件：取决于 DP-01）**：2 个文件
   108	- `src/server.ts`（`ci_index_status` 调用脚本对齐）
   109	- `README.md`（工具说明对齐）
   110	
   111	**间接影响（运行时依赖图数据的脚本）**：8 个文件
   112	- `scripts/ast-delta.sh`（增量路径被 indexer 触发，更高频调用）
   113	- `scripts/graph-store.sh`（`graph.db` 写入/迁移路径被更高频触发）
   114	- `scripts/graph-rag.sh`（读 `graph.db`，需关注并发/锁等待）
   115	- `scripts/impact-analyzer.sh`（读 `graph.db`，新鲜度提升但需关注并发）
   116	- `scripts/daemon.sh`（读 `graph.db`，预热/查询可能与写入并发）
   117	- `scripts/adr-parser.sh`（写 `graph.db`，需避免与 indexer 写入形成冲突）
   118	- `scripts/cod-visualizer.sh`（读 `graph.db`）
   119	- `scripts/federation-lite.sh`（读 `graph.db`，虚拟边/联邦索引可能受新鲜度影响）
   120	
   121	#### 2) Change Type Classification（变更类型分类，必填）
   122	
   123	- [ ] **创建特定类**：不适用（无面向对象创建策略变更）
   124	- [ ] **算法依赖**：不适用（不替换核心图算法/检索算法）
   125	- [x] **平台依赖**：当前 `scip-to-graph.sh` 依赖在线下载 `scip.proto`（受限网络/离线会失败），本变更将其离线化
   126	- [ ] **对象表示/实现依赖**：不适用（不改 DB Schema，不改节点/边表示）
   127	- [x] **功能扩展**：新增索引调度能力（增量优先 + 可靠回退）
   128	- [x] **对象职责变更**：`indexer.sh` 从“全量生成 `index.scip`”扩展为“索引调度器（增量/全量/同步图）”
   129	- [ ] **子系统/模块替换**：不适用（不替换整套索引子系统）
   130	- [x] **接口契约变更**：`ci_index_status` 的真实语义需要裁决并对齐（否则属于隐式 breaking）
   131	
   132	#### 3) Impacts（受影响对象清单）
   133	
   134	##### A. 对外契约（API/CLI）
   135	
   136	- MCP：
   137	  - `src/server.ts` 的 `ci_index_status` 当前调用 `indexer.sh`（需与脚本真实职责对齐；取决于 DP-01）
   138	- CLI：
   139	  - `scripts/indexer.sh` 现有 `--install/--uninstall/--status` 必须保持兼容
   140	  - 若新增“一次性执行/传入变更文件”的入口，必须避免破坏现有默认启动守护模式
   141	
   142	##### B. 数据与迁移（DB/缓存/落盘产物）
   143	
   144	- `.devbooks/graph.db`：写入频率上升，需关注并发写入与读写竞争
   145	- `.devbooks/ast-cache/`：增量路径的关键缓存（版本戳/清理策略必须与回退路径一致）
   146	- `index.scip`：回退路径产物；回退成功后需同步更新图数据（`scip-to-graph.sh parse --incremental`）
   147	- `scip.proto`：从“在线下载”改为“本地优先”，需要明确版本固定与升级策略（见 DP-02）
   148	
   149	##### C. 模块与依赖（边界/调用方向/循环风险）
   150	
   151	- 新增/加强依赖边：
   152	  - `scripts/indexer.sh` → `scripts/ast-delta.sh`
   153	  - `scripts/indexer.sh` → `scripts/scip-to-graph.sh`（回退后同步图）
   154	- 并发风险（SQLite）：
   155	  - `graph-rag.sh`/`impact-analyzer.sh` 等读路径与 indexer 写路径并发时，需确认 WAL 与锁等待策略是否可接受（目标是“退化但不失败”）
   156	
   157	##### D. 测试与验证（需要新增/更新哪些锚点）
   158	
   159	- 现有测试受影响（需要确保不回归）：
   160	  - `tests/scip-to-graph.bats`：覆盖 `parse/--incremental/--force` 等路径；离线 proto 改造不能破坏这些场景
   161	- 建议新增（后续由 Test Owner 规划，不在本提案阶段实现）：
   162	  - Indexer 选择路径的契约测试：给定单文件变更，断言走增量；给定增量不可用，断言回退全量并同步图
   163	  - 离线环境下 `scip-to-graph.sh parse` 可运行的测试：确保不依赖在线下载
   164	
   165	##### E. Bounded Context 边界（含 ACL 检查）
   166	
   167	- Bounded Context：
   168	  - 本变更主要发生在“Indexing Pipeline（索引流水线）”边界内，但会影响“Graph Query（图检索/分析）”上下游的新鲜度与并发行为
   169	- ACL（Anti-Corruption Layer）检查：
   170	  - 外部依赖：Sourcegraph 的 `scip.proto`、`scip-*` 索引器 CLI
   171	  - ACL 建议：以“固定版本的本地 `scip.proto` + 显式升级流程”隔离上游格式变化，避免运行时隐式漂移
   172	
   173	##### F. 受影响的 Spec 真理（`dev-playbooks/specs/`）
   174	
   175	Affected Specs:
   176	- [BREAK] `dev-playbooks/specs/architecture/c4.md` - 当前将 `scripts/indexer.sh` 描述为“Embedding 索引管理”，与实现/提案目标存在语义冲突，需要对齐
   177	- [EXTEND] `dev-playbooks/specs/scip-parser/spec.md` - 需要补充“离线 proto”要求与对应场景（避免隐式网络依赖）
   178	- [EXTEND] `dev-playbooks/specs/architecture/module-graph.md` - indexer 依赖与职责描述需与实际索引链路对齐
   179	- [EXTEND] `dev-playbooks/specs/_meta/project-profile.md` - “索引状态”工具与索引链路描述需要更新（以避免持续误导）
   180	
   181	#### 4) Compatibility & Risks（兼容性与风险）
   182	
   183	- Breaking 风险（需要显式控制）：
   184	  - `ci_index_status` 的语义若调整（DP-01），对依赖旧行为的客户端可能是 breaking（需要保持兼容或提供迁移说明）
   185	  - `scripts/indexer.sh` 若新增参数/子命令，可能影响现有用户的启动方式（需要保持默认行为不变）
   186	- 可靠性风险：
   187	  - 并发写入导致 `graph.db` 短时锁等待；需确保读路径可退化（例如重试/超时/返回部分结果），不产生“全功能不可用”
   188	- 版本漂移风险：
   189	  - 固定 `scip.proto` 后需要明确升级策略，否则未来上游变更会以“解析失败”形式体现
   190	
   191	#### 5) Minimal Diff Strategy（最小改动面策略）
   192	
   193	- 变化收口点（优先只改 1–3 个点）：
   194	  1) `scripts/indexer.sh`：新增“调度决策”与“将变更文件传递给增量更新”的最小逻辑，不重写监听器整体结构
   195	  2) `scripts/scip-to-graph.sh`：仅替换 proto 发现/获取策略，不改解析输出结构与统计字段
   196	  3) （若选择 DP-01A）`src/server.ts`：仅修正 `ci_index_status` 的脚本路由，保持工具名与输入 schema 不变
   197	- 明确禁止（避免发散）：
   198	  - 禁止在本变更中引入新的索引存储（向量库/图库替换）
   199	  - 禁止修改 `graph-store.sh` Schema 或重写图查询
   200	
   201	#### 6) Pinch Points 识别与最小测试集
   202	
   203	Pinch Points:
   204	- [PP-1] `scripts/indexer.sh:do_index()`（或其等价的新调度入口）- `fswatch/inotifywait/polling` 三条路径共用的索引触发汇聚点
   205	- [PP-2] `scripts/scip-to-graph.sh:ensure_scip_proto()`（或其等价的新 proto 解析入口）- 所有 SCIP 解析路径共用的关键前置
   206	- [PP-3] `src/server.ts:handleToolCall()` 中 `ci_index_status` 分支（仅在 DP-01 涉及改动时）- MCP 工具调用汇聚点
   207	
   208	最小测试集:
   209	- 在 PP-1 写 1 个契约测试 → 覆盖 fswatch/inotify/polling 的索引决策一致性（通过引入一次性运行/干跑输出来实现可测性）
   210	- 在 PP-2 写 1 个离线测试 → 覆盖“无网络、无 `/tmp/scip.proto`”场景下仍可解析（或能给出可诊断的明确错误）
   211	- 在 PP-3 写 1 个工具路由测试 → 覆盖 `ci_index_status` 调用脚本不再漂移（仅 DP-01 需要）
   212	
   213	#### 7) Open Questions（<= 3）
   214	
   215	1) DP-01：`ci_index_status` 的语义归属（Embedding vs 索引总控 vs SCIP/图索引）
   216	2) DP-02：`scip.proto` 离线化策略（仓库 vendoring vs 构建/包管理提供）
   217	3) DP-03：增量触发粒度（逐文件即时 vs 防抖窗口内聚合批处理）
   218	
   219	## Risks & Rollback（风险与回滚）
   220	
   221	### 风险
   222	
   223	1) 增量更新覆盖不足：
   224	   - `ast-delta.sh` 主要覆盖 TS/JS（tree-sitter 解析）；对其他语言或复杂语法可能需要回退。
   225	2) 索引一致性风险：
   226	   - 增量链路与回退链路如果并发触发，可能造成 `graph.db` 处于“部分更新”状态；需要在实现阶段明确互斥/锁策略。
   227	3) 离线化带来的版本漂移：
   228	   - 固定 `scip.proto` 后，若上游格式变化，解析可能失配；需要明确升级策略（见 DP-02）。
   229	4) 工具契约漂移继续扩大：
   230	   - 若不裁决 `ci_index_status` 的语义，后续实现可能“修复一边、破坏另一边”（见 DP-01）。
   231	
   232	### 回滚策略
   233	
   234	- 提供显式开关禁用增量路径（例如环境变量或 `config/features.yaml`），回滚到“仅全量 scip 索引 + 可选图解析”的保守模式。
   235	- `scip-to-graph.sh` 保留旧路径（可选下载）作为兼容后门，但默认优先离线。
   236	
   237	## Validation（候选验收锚点 + 证据落点）
   238	
   239	> 说明：以下为“候选验收锚点”。本提案阶段未执行命令；证据应在后续阶段产出并归档到变更包目录。
   240	
   241	### 验收锚点（候选）
   242	
   243	1) 增量路径可用：
   244	   - 当监听到单文件变更且 tree-sitter 可用时，`scripts/indexer.sh` 触发 `scripts/ast-delta.sh update <file>`，并在 `.devbooks/graph.db` 中可观测到对应节点/边变化。
   245	2) 回退路径可靠：
   246	   - 当增量不可用或变更文件数超过阈值时，仍能生成 `index.scip`，并通过 `scripts/scip-to-graph.sh parse --incremental` 更新 `graph.db`。
   247	3) 离线可运行：
   248	   - 在无网络环境下，`scripts/scip-to-graph.sh parse` 不依赖下载 `scip.proto` 仍可执行（至少能走可预期的本地路径/明确报错，不出现“隐式网络依赖失败”）。
   249	4) 不破坏既有入口：
   250	   - `scripts/indexer.sh --help/--status/--install/--uninstall` 行为保持可用。
   251	
   252	### 建议验证命令（实现后由执行者运行）
   253	
   254	- ShellCheck：`npm run lint`
   255	- 构建：`npm run build`
   256	- 脚本基本可用性：`./scripts/indexer.sh --help`、`./scripts/scip-to-graph.sh --help`
   257	- 离线验证（示例）：断网或限制网络后运行 `./scripts/scip-to-graph.sh parse --incremental`（需要本地已有 `index.scip` 与离线 proto 策略落地）
   258	
   259	### 证据落点（强制路径）
   260	

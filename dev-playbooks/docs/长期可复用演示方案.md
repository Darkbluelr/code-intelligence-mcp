# 长期可复用演示方案（Code Intelligence MCP）

版本：2026-01-23

本方案沉淀“可长期复用、可对比、可归档”的演示体系：统一入口 + 标准产物契约（JSON/MD）+ A/B 对比语义 + 公开归档约束。目标是让观众在 **5–15 分钟**内直观看到价值，同时让演示结果可以跨版本复核与复用。

本方案与本仓库落地后的约定对齐：

- 单入口：`demo/demo-suite.sh`
- 产物契约真理源：`dev-playbooks/specs/demo-suite/spec.md`
- 公开归档约束：`docs/demos/README.md`

---

## 1. 默认决策（推荐直接采用）

- **统一入口**：所有正式演示以 `demo/demo-suite.sh` 为入口；`demo/00-*.sh`~`demo/05-*.sh` 仅作为“步骤脚本”保留（便于单点调试）。
- **out-dir 策略**：始终显式指定 `--out-dir`（或 `CI_DEMO_OUT_DIR`），把最终产物与运行期目录都约束在 out-dir 下；`TMPDIR` 绑定到 `<out-dir>/.tmp`。
- **A/B 默认顺序**：
  1) 先做配置 A/B（同一版本下的开关对比：`context_injection_mode`、`cache_mode`）；
  2) 再做版本 A/B（A=基线、B=候选分支/commit）。
- **公开归档策略**：只把小体积 `*.json`/`*.md` 复制到 `docs/demos/<run-id>/`；禁止提交 `raw/`、大日志与运行期目录。

---

## 2. 演示目标与覆盖维度（MECE）

> 维度的“可复用”关键不在于终端输出多酷，而在于每次运行都能产出可对比的 `metrics.json` + `report.md`。

- 维度 A：理解与检索（Understanding）  
  代表能力：语义检索、Graph-RAG
- 维度 B：诊断与定位（Diagnosis）  
  代表能力：错误定位、调用链
- 维度 C：影响与变更（Impact）  
  代表能力：影响面分析、改动风险控制
- 维度 D：质量与风险（Quality & Risk）  
  代表能力：热点/复杂度/架构漂移/语义异常
- 维度 E：性能与稳定性（Performance）  
  代表能力：基准评测、回归检测、缓存收益
- 维度 F：演进与持续化（Evolution）  
  代表能力：版本/配置 A/B 对比与可审计归档

---

## 3. Demo Suite：目录、脚本与产物契约

### 3.1 单入口（demo-suite）

最小用法（示例）：

```bash
demo/demo-suite.sh --out-dir dev-playbooks/changes/<change-id>/evidence/<run-id>
```

out-dir 的意义与安全约束、run-id 规则、标准目录布局等，面向演示者的说明见：`demo/DEMO-GUIDE.md`。

### 3.2 标准目录布局（相对 out-dir）

> 这是“可复用/可审计”的基础。目录与文件名必须稳定，以便 compare 与归档复核。

- `single/metrics.json` + `single/report.md`（单次运行最小闭环）
- `ab-version/run-a/*`、`ab-version/run-b/*`、`ab-version/compare/*`（版本 A/B）
- `ab-config/run-a/*`、`ab-config/run-b/*`、`ab-config/compare/*`（配置 A/B）
- `degraded/*`（依赖缺失/越界等情况下的降级兜底产物；`single/` 与 `ab-*` 仍保留各自产物）
- `write-boundary/*`（写入边界哨兵与扫描证据）
- `ai-ab/**/scorecard.json`（AI 双代理 A/B 的半自动沉淀）

### 3.3 产物语义（必须可审计）

- `metrics.json`：机器可读指标与审计字段，遵循 schema v1.0；缺失字段用 `null + missing_fields[] + reasons[]` 表达。
- `report.md`：人类可读报告；必须与同目录 `metrics.json.status/reasons` 一致（允许更详细解释，但禁止相互矛盾）。
- `compare.json`/`compare.md`：对比产物；必须记录阈值来源与内容 sha256；若存在缺失指标则按规则输出 `unknown`/`inconclusive`。

---

## 4. A/B 机制（语义、可信前提与不可下结论）

### 4.1 版本 A/B（ab-version）

- 语义：对比两个 `git.ref_input`（A vs B）在同一数据集/环境下的差异。
- 可信前提：两次运行的审计字段齐全（git/dataset/environment/config/write-boundary/steps）；缺失时必须降级并给原因码。

### 4.2 配置 A/B（ab-config）

- 语义：同一 `git.ref_resolved` 下，只改变目标开关（如 `context_injection_mode` 或 `cache_mode`）。
- 唯一区别控制：除目标开关外检测到任何变量漂移，compare 必须判定 `overall_verdict=inconclusive` 且 `reasons[]` 包含 `variable_drift_detected`。

### 4.3 AI 双代理 A/B（ai-ab，半自动）

- 语义：两次独立 AI 会话结果按 `scorecard.json` 契约落盘为“可审计事实”，再纳入 compare 机制。
- 原则：允许 `inconclusive`，但禁止无证据的主观结论。

---

## 5. 简单 / 复杂双场景（可判真锚点）

两类场景都要求“固定输入 + 可在目标仓库事实中判真”的锚点，以避免指标退化为“形式正确但不可复核”。

### 5.1 简单场景（速度）

- 当前实现：用“锚点文件 + 符号”是否存在来填充 `metrics.diagnosis.simple.*`，不执行真实查询与排序。
- 锚点可配置：`CI_DEMO_DIAG_ANCHOR_FILE` / `CI_DEMO_DIAG_ANCHOR_SYMBOL` 或对应 CLI 参数；最终采用值会写入 `metrics.json` 与 `report.md`。
- 当 `jq` 缺失时按契约降级：相关字段为 `null`，并记录 `missing_fields[]` + `reasons[]`。

### 5.2 复杂场景（能力）

- 当前实现：调用链与影响面字段由“锚点文件/符号是否存在 + 影响库可用性”推断；未执行真实调用链计算。
- 影响分析依赖：`sqlite3` 与 `.devbooks/graph.db`；缺失时按契约降级并记录 `impact_db_missing`。

---

## 6. 写入边界与降级（演示可信度底座）

- out-dir 是唯一最终落盘根目录：演示不得把产物写到仓库根、其他 change-id，或系统 `/tmp` 作为最终落点。
- `/tmp` 默认不允许；若外部工具必须使用，仅允许带 run-id 前缀且退出清理；清理失败必须降级并写入原因码（例如 `tmp_leak_detected`）。
- 降级原因码与 compare 原因码的稳定集合、以及“缺失表示法”约定见：`demo/DEMO-GUIDE.md`（与 `spec.md` 对齐）。

---

## 7. 公开归档（docs/demos/）

公开归档用于对外展示：只存放小体积 JSON/MD，并以 `run-id` 命名目录：

- 落点：`docs/demos/<run-id>/`
- 约束：仅 `*.json`/`*.md`，禁止 `raw/` 与其他大文件

详细约束、示例结构与提交前自检清单见：`docs/demos/README.md`。

---

## 8. 15 分钟演示流程（建议讲解顺序）

1) **启动一次单次运行**：讲清 out-dir 与可归档产物（`single/metrics.json` + `single/report.md`）。  
2) **配置 A/B**：强调“唯一区别控制”，展示 `ab-config/compare/compare.md` 的结论与原因码（如 `variable_drift_detected`）。  
3) **版本 A/B**：用同一数据集对比两次运行，展示 `ab-version/compare/compare.md` 的提升/回归判定与阈值来源。  
4) **简单/复杂场景**：用可判真锚点解释“速度 vs 能力”的差异，说明降级/缺失如何被显式记录。  
5) **公开归档**：把可公开产物复制到 `docs/demos/<run-id>/`（只保留 JSON/MD）。

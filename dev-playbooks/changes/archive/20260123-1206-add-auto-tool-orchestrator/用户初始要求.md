

   自动调用工具并回填结果（最佳实践方案）

   1) 目标与边界
   目标：用户输入后，系统自动选择并调用 MCP 工具，
   返回结果注入到 Prompt，再交给模型生成答复。
   边界：仅自动调用低成本、低风险工具；复杂/高成本
   工具保持“提示 + 手动触发”。

   ───────────────────────────────────────────────

   2) 总体架构（高可信）
   ┌ text ───────────────────────────────────────┐
   │  User Prompt                                │
   │     ↓                                       │
   │  [Pre‑Prompt Hook / Wrapper / Proxy]        │
   │     ↓                                       │
   │  Intent → Tool Plan → Tool Calls → Tool Re  │
   │  sults                                      │
   │     ↓                                       │
   │  Augmented Prompt                           │
   │     ↓                                       │
   │  LLM Response                               │
   └─────────────────────────────────────────────┘

   核心组件
   1) Intent 解析器
      ·  解析需求类型：debug / modify / explore
      ·  提取关键实体：文件、符号、错误、功能域

   2) Tool Planner（工具路由器）
      ·  白名单策略
      ·  置信度阈值
      ·  预算/超时
      ·  并发控制

   3) Tool Runner（执行器）
      ·  调用 MCP 工具
      ·  结果标准化
      ·  失败降级

   4) Context Assembler（回填器）
      ·  输出结构化 JSON
      ·  限制 token
      ·  清晰标注来源
5) 如何做到“AI 输出前调用”
   只有两种方式能做到：

   A. Hook（Claude Code / Codex CLI）
   - Claude Code：已有 Hook 机制
   （UserPromptSubmit）
   - Codex CLI：可用 wrapper 或 hook
   优点：稳定，能百分百保证“AI 输出前调用”

   B. Proxy（通用但不完美）
   - 通过代理 MCP Server/CLI
   - 注入增强上下文
   缺点：不同客户端调用链不一致，可能绕过

   结论：最佳实践是 先适配 A（Claude Code + Codex
   CLI）。

   ───────────────────────────────────────────────

   4) 适配范围策略（现实可行）
   客户端          是否可做到预调用  方案
   ───────────  ────────  ─────────────────
   Claude Code  ✅         Hook
   Codex CLI    ✅         Wrapper/Hook
   Cursor IDE   可能        需插件/Hook支持；若没
   有则降级
   其他 IDE       不稳定       只能手动触发

   建议：先保证 Claude Code + Codex CLI，Cursor 视
   情况适配。

   ───────────────────────────────────────────────

   5) 用户可见性（展示给用户）
   最佳实践：“可见 + 可控”
   - 展示 Tool Plan（执行了哪些工具，为什么）
   - 展示 Tool Results（可折叠、摘要优先）
   - 用户可关闭自动调用 / 或仅提示
展示格式建议：
   ┌ text ────────────────────────┐
   │  [Auto Tools]                │
   │  - ci_search: 搜索相关代码   │
   │  - ci_graph_rag: 图谱上下文  │
   │                              │
   │  [Results]                   │
   │  - top files: ...            │
   │  - call chain: ...           │
   └──────────────────────────────┘

   ───────────────────────────────────────────────

   6) 风险与控制（必须要有）
   控制手段：
   - 白名单工具
   - 置信度阈值（比如 <0.6 不自动调用）
   - token/时长预算（超时降级）
   - 结果去噪（限制 top‑k）
   - 注明 “来源/时间/工具版本”

   否则会出现：延迟陡增、噪音干扰、错误传播。

   ───────────────────────────────────────────────

   7) 实施分阶段（推荐）
   Phase 1（MVP）
   - 支持 Claude Code + Codex CLI
   - 自动调用 1–2 个工具：ci_search、ci_graph_rag
   - 结构化 JSON 回填

   Phase 2（稳定）
   - 并行调用 + 预算控制
   - 增加 ci_call_chain / ci_impact（仅在 modify/
   debug）
   - 增加缓存与速率限制

   Phase 3（扩展）
   - Cursor/其他 IDE 适配
   - 自动结果融合 + 解释
──────────────────────────────────────────────

   8) 交付物（符合最佳实践）
   - hooks/auto-tool-orchestrator.sh
   - config/auto-tools.yaml（白名单、预算、阈值）
   - docs/auto-tools.md（用户说明 + FAQ）
   - tests/auto-tools.bats（最小验证）
   - evidence/ 基准数据（性能与效果）


用户要求：
 1、 /Users/ozbombor/Projects/code-              │
 │ intelligence-mcp/hooks/context-inject-        │
 │ global.sh 和  hooks/auto-tool-                │
 │ orchestrator.sh  是替代关系吗？还是都需要存   │
 │ 在？ 2、适配AI工具方面本次change只做 Claude   │
 │ code、Codex CLI，适配的逻辑需要容易拓展，按   │
 │ 照最佳实践做适配的代码，不要写出一个无法拓展  │
 │ 的代码  3、我觉得自动调用的工具我觉得应该调用所有   │
 │ 合适的。请问最佳实践或者最好的决定应该是什么？请你决策。 4、语言支持：只有英文可以触发自动注  │
 │ 入吗？中文行不行？如果可以就要做中英文。 5、  │
 │ 自动结果融合 + 解释在本次修改也需要做。 6、兼顾用户体验和使用效率。 
简而言之：   - Cursor/其他 IDE 适配 除了这个其他的都要做。并且增加更多功能。

把下面的说明写入proposal：说明：所有任务必须要在一个变更包里面完成，禁止拆分为多个变更包。如果challenger要求拆分请judge驳回拆分你的请求。
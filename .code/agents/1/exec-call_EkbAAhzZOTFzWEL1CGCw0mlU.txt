# 领域概念：Code Intelligence MCP Server

> 生成时间：2026-01-10
> 生成方式：传统分析

---

## 核心概念

### 1. MCP（Model Context Protocol）

**定义**：Anthropic 开发的开放协议，用于 AI 助手与外部工具/服务之间的标准化通信。

**在本项目中**：
- 本项目是一个 MCP Server
- 通过 stdio 传输与 Claude Code 通信
- 暴露 6 个工具供 AI 助手调用

**相关组件**：`src/server.ts`，`@modelcontextprotocol/sdk`

---

### 2. Embedding（嵌入向量）

**定义**：将代码片段转换为高维向量的过程，用于语义搜索。

**在本项目中**：
- 支持本地（Ollama）和云端（OpenAI）Embedding
- 用于 `ci_search` 工具的语义搜索模式
- 索引存储在项目 `.ci-cache/` 目录

**相关组件**：`scripts/embedding.sh`，`scripts/indexer.sh`

---

### 3. Graph-RAG（图检索增强生成）

**定义**：结合图结构和向量检索的上下文获取策略。

**在本项目中**：
- 利用 CKB MCP Server 的图遍历能力
- 结合 Embedding 搜索结果
- 返回相关代码上下文给 AI 助手

**相关组件**：`scripts/graph-rag.sh`

---

### 4. Call Chain（调用链）

**定义**：函数之间的调用关系路径。

**在本项目中**：
- 支持 callers（谁调用了我）
- 支持 callees（我调用了谁）
- 支持双向追踪（both）
- 可配置追踪深度

**相关组件**：`scripts/call-chain.sh`

---

### 5. Thin Shell（薄壳架构）

**定义**：服务器仅作为协议适配层，核心逻辑在外部脚本中实现。

**在本项目中**：
- `server.ts` 仅处理 MCP 协议和工具调度
- 实际功能由 `scripts/*.sh` 实现
- 设计约束：`CON-TECH-002`

**优势**：
- 脚本可独立测试和使用
- 降低 TypeScript 复杂度
- 便于功能扩展

---

### 6. Context Injection（上下文注入）

**定义**：在用户提问前自动注入相关代码上下文。

**在本项目中**：
- 通过 Claude Code 钩子实现
- 自动搜索相关代码片段
- 检测热点文件并提示

**相关组件**：`hooks/augment-context-global.sh`

---

### 7. Hotspot（热点文件）

**定义**：变更频率高且复杂度高的文件，通常是 Bug 密集区。

**计算公式**：
```
热点分数 = 变更频率 × 圈复杂度
```

**在本项目中**：
- 用于 Bug 定位
- 用于上下文注入优先级

---

### 8. CKB（Code Knowledge Base）

**定义**：代码知识库 MCP Server，提供图基代码分析能力。

**提供的能力**：
- 符号搜索
- 引用查找
- 调用图
- 架构概览
- 影响分析

**在本项目中**：作为可选外部依赖

---

## 概念关系图

```
┌─────────────────────────────────────────────────────────────┐
│                     Claude Code (Client)                     │
└─────────────────────────────────────────────────────────────┘
                               │
                    MCP Protocol + Context Injection
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                     code-intelligence-mcp                    │
│                       (Thin Shell)                           │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                  Tool Registry                        │   │
│  │                                                       │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐              │   │
│  │  │ci_search│  │ci_call_ │  │ci_bug_  │              │   │
│  │  │         │  │ chain   │  │ locate  │              │   │
│  │  │Embedding│  │Call Chain│ │ Hotspot │              │   │
│  │  └─────────┘  └─────────┘  └─────────┘              │   │
│  │                                                       │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐              │   │
│  │  │ci_compl-│  │ci_graph_│  │ci_index_│              │   │
│  │  │  exity  │  │   rag   │  │ status  │              │   │
│  │  │         │  │Graph-RAG│  │         │              │   │
│  │  └─────────┘  └─────────┘  └─────────┘              │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                    External Services                         │
│                                                              │
│    ┌─────────┐     ┌─────────┐     ┌─────────┐             │
│    │ Ollama/ │     │   CKB   │     │ ripgrep │             │
│    │ OpenAI  │     │   MCP   │     │   jq    │             │
│    │Embedding│     │  Server │     │  tools  │             │
│    └─────────┘     └─────────┘     └─────────┘             │
└─────────────────────────────────────────────────────────────┘
```

---

## 术语表

| 术语 | 英文 | 定义 |
|------|------|------|
| 薄壳 | Thin Shell | 仅做协议适配，核心逻辑外置 |
| 嵌入 | Embedding | 代码到向量的转换 |
| 图检索增强生成 | Graph-RAG | 图+向量的混合检索 |
| 调用链 | Call Chain | 函数调用关系路径 |
| 热点 | Hotspot | 高频变更+高复杂度文件 |
| 上下文注入 | Context Injection | 自动提供相关代码上下文 |
| 代码知识库 | CKB | 图基代码分析服务 |
# 模块依赖图：Code Intelligence MCP Server

> 生成时间：2026-01-10
> 生成方式：传统分析（SCIP 索引不可用）

---

## 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        External Clients                          │
│                    (Claude Code, AI Assistants)                  │
└─────────────────────────────────────────────────────────────────┘
                               │
                               │ MCP Protocol (stdio)
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                         src/server.ts                            │
│                    (MCP Server - Thin Shell)                     │
│                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ ListTools   │  │ CallTool    │  │ Transport   │              │
│  │ Handler     │  │ Handler     │  │ (stdio)     │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                               │
                               │ execAsync (shell)
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                        scripts/                                  │
│                    (Core Functionality)                          │
│                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ embedding   │  │ call-chain  │  │ bug-locator │              │
│  │    .sh      │  │    .sh      │  │    .sh      │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ complexity  │  │ graph-rag   │  │  indexer    │              │
│  │    .sh      │  │    .sh      │  │    .sh      │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                  │
│  ┌─────────────┐  ┌─────────────┐                               │
│  │  common     │  │ cache-utils │  (shared utilities)           │
│  │    .sh      │  │    .sh      │                               │
│  └─────────────┘  └─────────────┘                               │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                      External Tools                              │
│                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  ripgrep    │  │     jq      │  │   Ollama/   │              │
│  │    (rg)     │  │             │  │   OpenAI    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                  │
│  ┌─────────────┐                                                 │
│  │  CKB MCP    │  (optional - for graph-based analysis)         │
│  │   Server    │                                                 │
│  └─────────────┘                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 模块清单

### 核心模块

| 模块 | 路径 | 职责 | 依赖 |
|------|------|------|------|
| MCP Server | `src/server.ts` | MCP 协议处理，工具调度 | @modelcontextprotocol/sdk |
| Embedding | `scripts/embedding.sh` | 语义代码搜索 | common.sh, Ollama/OpenAI |
| Call Chain | `scripts/call-chain.sh` | 调用链追踪 | common.sh, CKB MCP |
| Bug Locator | `scripts/bug-locator.sh` | Bug 位置定位 | common.sh, embedding.sh |
| Complexity | `scripts/complexity.sh` | 复杂度分析 | common.sh |
| Graph-RAG | `scripts/graph-rag.sh` | 图基上下文检索 | common.sh, CKB MCP |
| Indexer | `scripts/indexer.sh` | 索引管理 | common.sh |

### 共享模块

| 模块 | 路径 | 职责 |
|------|------|------|
| Common | `scripts/common.sh` | 共享函数、配置、日志 |
| Cache Utils | `scripts/cache-utils.sh` | 缓存管理 |
| Reranker | `scripts/reranker.sh` | LLM 重排序 |

### 钩子模块

| 模块 | 路径 | 职责 |
|------|------|------|
| Global Context | `hooks/augment-context-global.sh` | 全局上下文注入 |
| Embedding Context | `hooks/augment-context-with-embedding.sh` | Embedding 增强上下文 |
| Context | `hooks/augment-context.sh` | 基础上下文注入 |
| Cache Manager | `hooks/cache-manager.sh` | 钩子缓存管理 |

### CLI 入口

| 模块 | 路径 | 职责 |
|------|------|------|
| MCP 入口 | `bin/code-intelligence-mcp` | 启动 MCP Server |
| 搜索入口 | `bin/ci-search` | 独立搜索命令 |

---

## 依赖矩阵

```
                    │ common │ cache  │ embed  │ call   │ bug    │ graph  │
                    │  .sh   │ utils  │ ding   │ chain  │ locator│  rag   │
────────────────────┼────────┼────────┼────────┼────────┼────────┼────────┤
server.ts           │   -    │   -    │   ✓    │   ✓    │   ✓    │   ✓    │
embedding.sh        │   ✓    │   ✓    │   -    │   -    │   -    │   -    │
call-chain.sh       │   ✓    │   -    │   -    │   -    │   -    │   -    │
bug-locator.sh      │   ✓    │   -    │   ✓    │   ✓    │   -    │   -    │
complexity.sh       │   ✓    │   -    │   -    │   -    │   -    │   -    │
graph-rag.sh        │   ✓    │   ✓    │   ✓    │   -    │   -    │   -    │
indexer.sh          │   ✓    │   -    │   -    │   -    │   -    │   -    │
```

**图例**：
- `✓` = 直接依赖
- `-` = 无依赖

---

## 依赖方向规则

### 允许的依赖方向

```
server.ts → scripts/*.sh → common.sh
                        → cache-utils.sh
                        → 外部工具
```

### 禁止的依赖

- ❌ scripts/*.sh → src/*.ts（脚本不得依赖 TypeScript）
- ❌ common.sh → 其他功能脚本（共享模块不得依赖功能模块）
- ❌ 循环依赖

---

## 外部依赖

### 必需依赖

| 依赖 | 类型 | 来源 |
|------|------|------|
| @modelcontextprotocol/sdk | npm | package.json |
| Node.js | 运行时 | 系统 |
| Bash | 运行时 | 系统 |

### 推荐依赖

| 依赖 | 类型 | 用途 |
|------|------|------|
| ripgrep (rg) | CLI 工具 | 文本搜索 |
| jq | CLI 工具 | JSON 处理 |

### 可选依赖

| 依赖 | 类型 | 用途 |
|------|------|------|
| Ollama | 服务 | 本地 Embedding |
| OpenAI API | 服务 | 云端 Embedding |
| CKB MCP Server | MCP | 图基代码分析 |
# 技术债热点分析：Code Intelligence MCP Server

> 生成时间：2026-01-13
> 生成方式：静态复杂度分析（Git 历史不可用）
> 分析范围：src/, scripts/

---

## 分析方法说明

由于当前仓库无 Git 提交历史，无法计算变更频率。本报告基于以下静态指标：

- **代码行数**：文件规模
- **函数数量**：模块复杂度
- **依赖关系**：耦合程度

**热点公式（简化）**：
```
热点分数 = 代码行数 × 功能密度系数
```

---

## 热点清单

### 高复杂度文件（需关注）

| 排名 | 文件 | 行数 | 风险等级 | 建议 |
|------|------|------|----------|------|
| 1 | `scripts/embedding.sh` | 1332 | 🔴 高 | 考虑拆分为子模块 |
| 2 | `scripts/graph-rag.sh` | 912 | 🟡 中高 | 核心功能，需充分测试 |
| 3 | `scripts/bug-locator.sh` | 793 | 🟡 中高 | 依赖多个外部服务 |
| 4 | `scripts/call-chain.sh` | 742 | 🟡 中高 | CKB 依赖集中 |
| 5 | `scripts/pattern-learner.sh` | 706 | 🟡 中 | 新功能，需稳定性验证 |

### 中等复杂度文件

| 文件 | 行数 | 风险等级 | 说明 |
|------|------|----------|------|
| `scripts/ast-diff.sh` | 595 | 🟢 中 | AST 处理逻辑 |
| `scripts/common.sh` | 449 | 🟢 中 | 共享库，变更影响大 |
| `scripts/entropy-viz.sh` | 392 | 🟢 低 | 独立功能 |
| `src/server.ts` | 356 | 🟢 低 | 薄壳设计，职责清晰 |
| `scripts/reranker.sh` | 335 | 🟢 低 | LLM 重排序 |

### 低复杂度文件（健康）

| 文件 | 行数 | 说明 |
|------|------|------|
| `scripts/indexer.sh` | 322 | 索引管理 |
| `scripts/boundary-detector.sh` | 291 | 边界检测 |
| `scripts/hotspot-analyzer.sh` | 227 | 热点分析 |
| `scripts/complexity.sh` | 279 | 复杂度计算 |

---

## 依赖风险分析

### 高耦合模块

```
embedding.sh (1332 行)
├── 被依赖：graph-rag.sh, bug-locator.sh, hooks/*
├── 外部依赖：Ollama, OpenAI API
└── 风险：修改影响范围大

common.sh (449 行)
├── 被依赖：所有 scripts/*.sh
└── 风险：任何变更都需全量测试
```

### 外部服务依赖

| 服务 | 依赖脚本 | 降级策略 |
|------|----------|----------|
| Ollama | embedding.sh | OpenAI → 关键词搜索 |
| CKB MCP | call-chain.sh, graph-rag.sh | 功能降级 |
| OpenAI API | embedding.sh, reranker.sh | Ollama → 关键词搜索 |

---

## 建议行动

### 短期（立即）

1. **为 embedding.sh 添加测试覆盖**
   - 原因：最大文件，核心功能
   - 目标：关键路径测试覆盖

2. **common.sh 变更审查流程**
   - 原因：全局影响
   - 措施：PR 需 2 人 review

### 中期（下个迭代）

1. **拆分 embedding.sh**
   - 建议拆分点：
     - `embedding-index.sh`：索引构建
     - `embedding-search.sh`：搜索查询
     - `embedding-provider.sh`：Provider 抽象

2. **增加集成测试**
   - 目标：核心功能端到端测试
   - 覆盖：embedding, graph-rag, call-chain

### 长期（技术债务）

1. 建立变更频率跟踪（Git 历史积累后）
2. 引入圈复杂度工具（shellcheck + custom rules）
3. 定期热点报告生成（/devbooks:entropy）

---

## 热点分布图

```
复杂度
  ^
  │                        ● embedding.sh (1332)
  │

│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                      Config Layer [NEW: Phase 2]                    ││
│  │                                                                     ││
│  │  ┌─────────────────────────┐    ┌─────────────────────────┐        ││
│  │  │  config/arch-rules.yaml │    │  config/federation.yaml │        ││
│  │  │  (架构规则定义)          │    │  (联邦仓库配置)          │        ││
│  │  └─────────────────────────┘    └─────────────────────────┘        ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Container Inventory

| Container | 路径 | 类型 | 职责 | 技术栈 |
|-----------|------|------|------|--------|
| MCP Server | `src/server.ts` | Application | MCP 协议处理，工具调度 | TypeScript, Node.js |
| Global Hook | `hooks/augment-context-global.sh` | Hook | 全局上下文注入，4 维意图分析 | Bash |
| **Pre-commit Hook** | `hooks/pre-commit` | Hook | 架构规则校验 + 循环依赖检测 | Bash |
| Embedding Search | `scripts/embedding.sh` | Script | 语义代码搜索 | Bash |
| Call Chain | `scripts/call-chain.sh` | Script | 调用链追踪，数据流追踪 | Bash |
| Bug Locator | `scripts/bug-locator.sh` | Script | Bug 位置定位（集成热点算法） | Bash |
| Complexity | `scripts/complexity.sh` | Script | 圈复杂度分析 | Bash |
| Graph-RAG | `scripts/graph-rag.sh` | Script | 子图检索，边界过滤 | Bash |
| Indexer | `scripts/indexer.sh` | Script | Embedding 索引管理 | Bash |
| Hotspot Analyzer | `scripts/hotspot-analyzer.sh` | Script | Frequency × Complexity 热点计算，**Phase 2: Bug 修复历史权重** | Bash |
| Boundary Detector | `scripts/boundary-detector.sh` | Script | 用户/库/生成代码边界识别 | Bash |
| Pattern Learner | `scripts/pattern-learner.sh` | Script | 语义模式学习与异常检测 | Bash |
| AST Diff | `scripts/ast-diff.sh` | Script | SCIP 增量索引 | Bash |
| **Cache Manager** | `scripts/cache-manager.sh` | Script | **多级缓存（L1 内存 + L2 文件）、mtime + blob hash 精确失效、LRU 淘汰** | Bash |
| **Dependency Guard** | `scripts/dependency-guard.sh` | Script | **循环依赖检测（DFS）、架构规则校验、Pre-commit 集成** | Bash |
| **Context Layer** | `scripts/context-layer.sh` | Script | **Commit 语义分类（fix/feat/refactor）、Bug 修复历史提取** | Bash |
| **Federation Lite** | `scripts/federation-lite.sh` | Script | **跨仓库契约发现、符号提取、联邦索引管理** | Bash |
| Common | `scripts/common.sh` | Shared | 共享函数、配置、日志，**Phase 2: 新增缓存共享函数** | Bash |
| Cache Utils | `scripts/cache-utils.sh` | Shared | 缓存管理（L2 基础函数），**被 cache-manager.sh 调用** | Bash |
| **Arch Rules Config** | `config/arch-rules.yaml` | Config | **架构规则定义（禁止导入、循环检测白名单）** | YAML |
| **Federation Config** | `config/federation.yaml` | Config | **联邦仓库配置（显式路径 + 自动发现）** | YAML |
| ***Graph Store*** | `scripts/graph-store.sh` | Script | ***SQLite 图存储，9 种边类型 CRUD，Schema v3 迁移，孤儿节点查询*** | Bash |
| ***SCIP Parser*** | `scripts/scip-to-graph.sh` | Script | ***SCIP 索引解析，symbol_roles 映射，IMPLEMENTS/EXTENDS/RETURNS_TYPE 边类型提取，正则降级*** | Bash |
| ***Daemon*** | `scripts/daemon.sh` | Script | ***常驻守护进程，Unix Socket 通信，自动预热，P95 < 500ms*** | Bash |
| ***Features Config*** | `config/features.yaml` | Config | ***功能开关配置（LLM 重排序、孤儿检测、模式发现）*** | YAML |
| ****AST Delta TS**** | `src/ast-delta.ts` | Module | ****TypeScript tree-sitter 解析薄壳，AST 差异计算**** | TypeScript |
| ****AST Delta**** | `scripts/ast-delta.sh` | Script | ****增量 AST 解析协调，缓存管理，图更新触发**** | Bash |
| ****Impact Analyzer**** | `scripts/impact-analyzer.sh` | Script | ****传递性影响分析，BFS 图遍历，置信度衰减**** | Bash |
| ****COD Visualizer**** | `scripts/cod-visualizer.sh` | Script | ****架构可视化，Mermaid + D3.js JSON 输出**** | Bash |
| ****Intent Learner**** | `scripts/intent-learner.sh` | Script | ****查询历史记录，偏好分数计算，90 天自动清理**** | Bash |
| ****Vuln Tracker**** | `scripts/vuln-tracker.sh` | Script | ****npm audit 集成，漏洞扫描，依赖传播追踪**** | Bash |
| *****ADR Parser***** | `scripts/adr-parser.sh` | Script | *****ADR 解析与关联，MADR/Nygard 格式支持，生成 ADR_RELATED 边***** | Bash |
| *****GitHub Action***** | `.github/workflows/arch-check.yml` | CI/CD | *****PR 自动架构检查，循环依赖/孤儿模块/架构规则检测***** | YAML |
| *****GitLab CI Template***** | `.gitlab-ci.yml.template` | CI/CD | *****GitLab MR 架构检查模板***** | YAML |
| ******CKB Client Manager****** | `src/server.ts::CKBClientManager` | Component | ******CKB MCP 调用管理，健康检查，降级状态管理，60s 冷却期****** | TypeScript |
| ******Fusion Search****** | `scripts/embedding.sh::fusion_search()` | Function | ******图+向量融合查询，1-hop 图扩展，Token 预算分配****** | Bash |

**注**：粗体为 `augment-upgrade-phase2` 变更新增或增强的 Container。斜体粗体为 `augment-parity` 变更新增的 Container。四星粗体为 `achieve-augment-full-parity` 变更新增的 Container。五星粗体为 `augment-parity-final-gaps` 变更新增的 Container。六星粗体为 `upgrade-code-intelligence-capabilities` 变更新增的 Container。

**augment-parity-final-gaps 增强的 Container**：
| Container | 增强内容 |
|-----------|----------|
| `scripts/scip-to-graph.sh` | 边类型扩展：IMPLEMENTS/EXTENDS/RETURNS_TYPE/ADR_RELATED |
| `scripts/graph-store.sh` | 新增 `find-path`（A-B 最短路径）、`migrate`（Schema 迁移） |
| `scripts/intent-learner.sh` | 对话上下文持久化、会话管理、连续性加权 |
| `scripts/daemon.sh` | 预热机制（warmup）、请求取消协议 |
| `scripts/cache-manager.sh` | 子图 LRU 缓存（SQLite 持久化，跨进程共享） |
| `scripts/bug-locator.sh` | 影响分析融合（--with-impact, --impact-depth） |
| `hooks/augment-context-global.sh` | 5 层结构化上下文输出、DevBooks 适配注入 |
| `scripts/common.sh` | 新增 detect_devbooks()、load_devbooks_context() |

**upgrade-code-intelligence-capabilities 增强的 Container**：
| Container | 增强内容 |
|-----------|----------|
| `scripts/scip-to-graph.sh` | SCIP 解析器扩展：IMPLEMENTS/EXTENDS/RETURNS_TYPE 边类型提取，正则降级解析 |
| `scripts/graph-store.sh` | Schema v3 迁移：新增 3 种边类型索引，自动备份与回滚，并发迁移保护 |
| `src/server.ts` | CKB Client Manager：MCP Client SDK 集成，健康检查（5s 超时），降级状态管理（60s 冷却期） |
| `scripts/embedding.sh` | fusion_search() 函数：图+向量融合查询，1-hop 图扩展，Token 预算分配（60% embedding + 40% graph） |
| `scripts/graph-rag.sh` | 融合查询集成：--fusion-depth 参数，CKB 降级时本地 1-hop 遍历 |
| `scripts/daemon.sh` | 自动预热：start 后异步触发，30s 超时，不阻塞启动（< 2s） |

---


## C3: Component Level (Key Containers)

### src/server.ts Components

| Component | 职责 | 依赖 |
|-----------|------|------|
| `TOOLS` | MCP 工具定义数组 | - |
| `handleListTools()` | 列出可用工具 | TOOLS |
| `handleToolCall()` | 工具调用分发 | runScript() |
| `runScript()` | 执行 Shell 脚本 | execAsync |

**MCP Tools (15 个)**：
| 工具名 | 对应脚本 | 状态 |
|--------|----------|------|
| `ci_search` | embedding.sh | 已有 |
| `ci_call_chain` | call-chain.sh | 已有 |
| `ci_bug_locate` | bug-locator.sh | 已有 |
| `ci_complexity` | complexity.sh | 已有 |
| `ci_graph_rag` | graph-rag.sh | 已有，**Full Parity 增强：--budget** |
| `ci_index_status` | indexer.sh | 已有 |
| `ci_hotspot` | hotspot-analyzer.sh | 已有 |
| `ci_boundary` | boundary-detector.sh | 已有 |
| **`ci_arch_check`** | dependency-guard.sh | **Phase 2 新增** |
| **`ci_federation`** | federation-lite.sh | **Phase 2 新增，Full Parity 增强：--virtual-edges** |
| ****`ci_ast_delta`**** | ast-delta.sh | ****Full Parity 新增**** |
| ****`ci_impact`**** | impact-analyzer.sh | ****Full Parity 新增**** |
| ****`ci_cod`**** | cod-visualizer.sh | ****Full Parity 新增**** |
| ****`ci_intent`**** | intent-learner.sh | ****Full Parity 新增**** |
| ****`ci_vuln`**** | vuln-tracker.sh | ****Full Parity 新增**** |

### scripts/cache-manager.sh Components [NEW: Phase 2]

| Component | 职责 | 依赖 |
|-----------|------|------|
| `get_cached_with_validation()` | 带验证的缓存读取（L1 → L2 → Miss） | get_blob_hash(), get_file_mtime() |
| `set_cache_with_lock()` | 带锁的缓存写入（原子写入 + flock） | check_and_evict_if_needed() |
| `get_blob_hash()` | 获取文件 blob hash（git 或 md5 降级） | git hash-object, md5sum |
| `check_and_evict_if_needed()` | LRU 淘汰检查（50MB 上限） | - |
| `compute_cache_key()` | 缓存 key 计算 | - |

**缓存层级**：
| 层级 | 存储 | 失效策略 | 访问延迟 |
|------|------|----------|----------|
| L1 | Bash 关联数组（内存） | 会话结束 | < 10ms |
| L2 | JSON 文件（`$CACHE_DIR/l2/`） | mtime + blob hash | < 100ms |

### scripts/dependency-guard.sh Components [NEW: Phase 2]

| Component | 职责 | 依赖 |
|-----------|------|------|

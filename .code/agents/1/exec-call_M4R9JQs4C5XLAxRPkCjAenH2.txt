  },
  // MP8.1: AST Delta 增量索引工具
  {
    name: "ci_ast_delta",
    description: "AST 增量索引操作（基于 tree-sitter 的快速代码变更检测）",
    inputSchema: {
      type: "object" as const,
      properties: {
        action: {
          type: "string",
          enum: ["update", "batch", "status", "clear-cache"],
          description: "Action to perform: update (single file), batch (multiple files), status, clear-cache",
        },
        file: { type: "string", description: "File path for update action" },
        since: { type: "string", description: "Git ref for batch action (default: HEAD~1)" },
      },
    },
  },
  // MP8.2: 影响分析工具
  {
    name: "ci_impact",
    description: "符号变更的传递性影响分析（多跳图遍历 + 置信度衰减）",
    inputSchema: {
      type: "object" as const,
      properties: {
        symbol: { type: "string", description: "Symbol to analyze impact for" },
        file: { type: "string", description: "File path for file-level analysis (alternative to symbol)" },
        depth: { type: "number", description: "Max traversal depth (default: 3, max: 5)" },
        decay: { type: "number", description: "Decay factor for impact calculation (default: 0.8)" },
        threshold: { type: "number", description: "Minimum impact threshold (default: 0.1)" },
        format: {
          type: "string",
          enum: ["json", "md", "mermaid"],
          description: "Output format (default: json)",
        },
      },
    },
  },
  // MP8.3: COD 架构可视化工具
  {
    name: "ci_cod",
    description: "代码库架构可视化（生成 Mermaid 或 D3.js JSON 格式的架构图）",
    inputSchema: {
      type: "object" as const,
      properties: {
        action: {
          type: "string",
          enum: ["generate", "module"],
          description: "Action: generate (full codebase), module (specific module)",
        },
        level: {
          type: "number",
          enum: [1, 2, 3],
          description: "Visualization level: 1=system context, 2=module, 3=file (default: 2)",
        },
        module: { type: "string", description: "Module path for module action" },
        format: {
          type: "string",
          enum: ["mermaid", "d3json"],
          description: "Output format (default: mermaid)",
        },
        include_hotspots: { type: "boolean", description: "Include hotspot coloring (default: true)" },
        include_complexity: { type: "boolean", description: "Include complexity annotations (default: false)" },
      },
    },
  },
  // MP8.4: 意图偏好学习工具
  {
    name: "ci_intent",
    description: "用户查询意图历史记录和偏好学习",
    inputSchema: {
      type: "object" as const,
      properties: {
        action: {
          type: "string",
          enum: ["record", "get-preferences", "cleanup", "stats"],
          description: "Action: record (add query), get-preferences, cleanup, stats",
        },
        query: { type: "string", description: "Query text for record action" },
        symbols: {
          type: "array",
          items: { type: "string" },
          description: "Matched symbols for record action",
        },
        user_action: {
          type: "string",
          enum: ["view", "edit", "ignore"],
          description: "User action for record (default: view)",
        },
        top: { type: "number", description: "Number of top preferences to return (default: 10)" },
        prefix: { type: "string", description: "Filter preferences by path prefix" },
        days: { type: "number", description: "Days threshold for cleanup (default: 90)" },
      },
    },
  },
  // MP8.5: 安全漏洞追踪工具
  {
    name: "ci_vuln",
    description: "依赖安全漏洞扫描与追踪（集成 npm audit）",
    inputSchema: {
      type: "object" as const,
      properties: {
        action: {
          type: "string",
          enum: ["scan", "trace"],
          description: "Action: scan (vulnerability scan), trace (dependency trace)",
        },
        package: { type: "string", description: "Package name for trace action" },
        severity: {
          type: "string",
          enum: ["low", "moderate", "high", "critical"],
          description: "Minimum severity threshold (default: moderate)",
        },
        format: {
          type: "string",
          enum: ["json", "md"],
          description: "Output format (default: json)",
        },
        include_dev: { type: "boolean", description: "Include dev dependencies (default: false)" },
      },
    },
  },
];

async function runScript(
  script: string,
  args: string[]
): Promise<{ stdout: string; stderr: string }> {
  const scriptPath = join(SCRIPTS_DIR, script);
  // Use execFile instead of exec to avoid shell injection vulnerabilities
  // Arguments are passed as array, not interpolated into a shell command string

  try {
    const { stdout, stderr } = await execFileAsync("bash", [scriptPath, ...args], {
      timeout: SCRIPT_TIMEOUT_MS,
      maxBuffer: MAX_BUFFER_SIZE,
    });
    return { stdout, stderr };
  } catch (error: unknown) {
    const execError = error as ExecError;
    // Return partial output even on error
    return {
      stdout: execError.stdout || "",
      stderr: execError.stderr || execError.message || "Unknown error",
    };
  }
}

async function handleToolCall(
  name: string,
  args: Record<string, unknown>
): Promise<string> {
  switch (name) {
    case "ci_search": {
      const query = args.query as string;
      const limit = (args.limit as number) || 10;
      const mode = (args.mode as string) || "semantic";
      const { stdout, stderr } = await runScript("embedding.sh", [
        "search",
        query,
        "--limit",
        String(limit),
        "--mode",
        mode,
      ]);
      return stderr ? `${stdout}\n[stderr]: ${stderr}` : stdout;
    }

    case "ci_call_chain": {
      const symbol = args.symbol as string;
      const direction = (args.direction as string) || "both";
      const depth = (args.depth as number) || 3;
      const { stdout, stderr } = await runScript("call-chain.sh", [
        symbol,
        "--direction",
        direction,
        "--depth",
        String(depth),
      ]);
      return stderr ? `${stdout}\n[stderr]: ${stderr}` : stdout;
    }

    case "ci_bug_locate": {
      const error = args.error as string;
      const { stdout, stderr } = await runScript("bug-locator.sh", [
        "--error",
        error,
      ]);
      return stderr ? `${stdout}\n[stderr]: ${stderr}` : stdout;
    }

    case "ci_complexity": {
      const path = args.path as string;
      const format = (args.format as string) || "text";
      const { stdout, stderr } = await runScript("complexity.sh", [
        path,
        "--format",
        format,
      ]);
      return stderr ? `${stdout}\n[stderr]: ${stderr}` : stdout;
    }

    case "ci_graph_rag": {
      const query = args.query as string;
      const depth = (args.depth as number) || 2;
      const budget = (args.budget as number) || 8000;
      const { stdout, stderr } = await runScript("graph-rag.sh", [
        query,
        "--depth",
        String(depth),
        "--budget",
        String(budget),
      ]);
      return stderr ? `${stdout}\n[stderr]: ${stderr}` : stdout;
    }

    // optimize-indexing-pipeline: AC-005
    // ci_index_status now routes to embedding.sh for Embedding index management
    case "ci_index_status": {
      const rawAction = args.action as string | undefined;

      // Parameter validation (AC-005: MP6.4)
      const validActions = ["status", "build", "clear"];
      if (rawAction && !validActions.includes(rawAction)) {
        return `Error: Invalid action '${rawAction}'. Valid actions: ${validActions.join(", ")}`;
      }

      // Default action (AC-005: MP6.3)
      const action = rawAction || "status";

      // Action mapping (AC-005: MP6.2)
      // "clear" maps to "clean" in embedding.sh
      const embeddingAction = action === "clear" ? "clean" : action;

      // Route to embedding.sh (AC-005: MP6.1)
      const { stdout, stderr } = await runScript("embedding.sh", [embeddingAction]);
      return stderr ? `${stdout}\n[stderr]: ${stderr}` : stdout;
    }

    case "ci_hotspot": {
      const top = (args.top as number) || 20;
      const days = (args.days as number) || 30;
      const format = (args.format as string) || "json";
      const path = (args.path as string) || ".";
      const { stdout, stderr } = await runScript("hotspot-analyzer.sh", [
        "--top",
        String(top),
        "--days",
        String(days),
        "--format",
        format,
        "--path",
        path,
      ]);
      return stderr ? `${stdout}\n[stderr]: ${stderr}` : stdout;
    }

    case "ci_boundary": {
      const file = args.file as string;
      const format = (args.format as string) || "json";
      const { stdout, stderr } = await runScript("boundary-detector.sh", [
        "--format",
        format,
        file,
      ]);
      return stderr ? `${stdout}\n[stderr]: ${stderr}` : stdout;
    }

    case "ci_arch_check": {
      const path = (args.path as string) || ".";
      const format = (args.format as string) || "json";
      const rules = (args.rules as string) || "";
      const scriptArgs = ["--all", "--scope", path, "--format", format];
      if (rules) {
        scriptArgs.push("--rules", rules);
      }
      const { stdout, stderr } = await runScript("dependency-guard.sh", scriptArgs);
      return stderr ? `${stdout}\n[stderr]: ${stderr}` : stdout;
    }

    case "ci_federation": {
      const action = (args.action as string) || "status";
      const query = (args.query as string) || "";
      const format = (args.format as string) || "json";
      const minConfidence = args.min_confidence as number | undefined;
      const localRepo = args.local_repo as string | undefined;
      const sync = args.sync === true;

      const scriptArgs: string[] = [];
      switch (action) {
        case "status":
          scriptArgs.push("--status");
          break;
        case "update":
          scriptArgs.push("--update");
          break;
        case "search":
          scriptArgs.push("--search", query);
          break;
        case "generate-virtual-edges":
          scriptArgs.push("generate-virtual-edges");

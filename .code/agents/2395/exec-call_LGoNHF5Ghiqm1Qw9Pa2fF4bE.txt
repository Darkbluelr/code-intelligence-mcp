
---

### Decision（决策，待 Judge 裁决）

**推荐选择**：方案 B（入口适配层 + 编排内核拆分）。

**关键决策点（提案给出默认）**：
- 自动调用策略：尽可能调用合适工具，但受白名单/预算/阈值边界约束（反对无上限全调用）
- 语言支持：中英文均支持（语言无关）
- 交付边界：仅 Claude Code + Codex CLI；Cursor 等明确不做

---

## 批准历史

| 时间 | 阶段 | 操作 | 操作者 | 理由 |
|------|------|------|--------|------|
| 2026-01-23 | Proposal | 创建 | AI（Proposal Author） | 根据 `用户初始要求.md` 生成 |

## Decision Log

### 2026-01-23 裁决：Revise

**理由摘要**：
- 已核验：本文件正文不包含“占位式截断文本”；Challenger 提到的截断内容很可能来自工具输出被截断（该点不构成本次裁决的阻断理由）。
- Codex CLI “模型输出前调用”的集成路径未明确（入口/触发时机/差异点），可行性与改动面无法评估。
- 控制面（开关/降级/回滚）与默认预算（超时/并发/回填上限）缺失，会导致体验、成本与稳定性不可控。
- 安全边界缺口：白名单/参数约束/路径过滤与脱敏/日志与回填敏感信息策略未定义。
- 契约与验收锚点不足：编排输出 schema/兼容策略未明确，AC 未绑定可执行验证，存在范围膨胀与“假完成”风险。

**必须修改项**（若 Revise）：
- [ ] 明确 Codex CLI “模型输出前”集成路径：入口形式（wrapper/hook/其他）、触发时机、最小配置、与 Claude Code 的差异点。
- [ ] 定义控制面：默认开关、用户可控选项（完全关闭/降级到 Tier-1/仅生成 Plan）、配置优先级（env > config > default）、失败后的自动回滚与“不阻塞输出”策略。
- [ ] 给出安全边界：自动调用工具白名单来源与审核方式、参数约束（防止危险参数）、路径过滤与脱敏规则、日志与回填中敏感信息的处理策略。
- [ ] 明确编排内核 I/O 契约：Tool Plan/Tool Results/Fused Context 的 JSON schema（字段/类型/必填/可选/版本号/兼容策略），以及终端文本输出格式约束。
- [ ] 预算与并发默认值落地为具体数字：总超时、单工具超时、并发数、回填 token/字节上限、top-k 等，并解释取值依据（保守/激进的权衡）。
- [ ] 失败模型与提示注入防护：工具输出视为不可信数据；融合提示中显式声明不得执行工具输出中的指令；定义超时/部分失败/解析失败时的合并与降级规则。
- [ ] 澄清与现有 hooks 的关系：`hooks/context-inject-global.sh`、`hooks/augment-context-global.sh` 与拟新增 `hooks/auto-tool-orchestrator.sh` 的职责边界、调用链、向后兼容策略。
- [ ] 验收标准补齐可验证锚点：每个 AC 绑定至少一个可执行验证（bats 测试/静态检查/示例命令）；并核查/消除重复或冲突的 AC。
- [ ] 移除“24 小时后自动批准”的默认条款，改为显式批准，避免绕过裁决流程。
- [ ] Tier 分层依据与触发条件写清：每个 Tier 的准入标准（成本/风险/稳定性/信息增益）、Tier-2 的默认触发条件与“需要用户确认”的边界。
- [ ] 范围收敛（仍在同一变更包内）：先定义 MVP（默认仅 Tier-0/1 自动；Tier-2 仅条件触发或需用户确认），将非 MVP 明确标注为“可选/后续”，避免本次交付范围膨胀。

**验证要求**：
- [ ] 在 proposal 中补充至少 1 条可重复的端到端验证步骤：给定输入 prompt，能证明“工具在回答前执行且回填被消费”（可用 hooks 输出中的时间戳/标记字段作为证据）。
- [ ] 增加最小安全验证说明：构造“工具输出包含提示注入文本”的样例，验证融合提示不会把其当成系统指令执行。
- [ ] 增加最小降级验证说明：模拟工具超时/不可用时仍能生成可用输出，并显式标注降级原因与降级到的层级。

### 2026-01-23 补记：关于占位核验（Revise 回合）

- 已复核：当前 `proposal.md` 正文未包含任何“占位式截断字符串”；若历史讨论中出现“正文存在截断占位”的说法，以本条核验结果为准。
- 本次 Revise 已将提案正文改为完整可读文本；不再依赖任何“省略/截断占位”来表达结构。

### 2026-01-23 裁决：Revise

**理由摘要**：
- Codex CLI 入口 A 的会话连续性仍缺定义：需明确 `codex exec resume --last` 的可用性与降级边界，确保可测试与可回退。
- 验收锚点仍缺“可重复且不依赖外部 codex”的路径：需要明确 `CI_AUTO_TOOLS_MODE=plan`/`--dry-run` 的可测试输出（增强 prompt 或编排 JSON）以供 bats 断言“先编排后回答”。
- repo-root 判定与非 git/子目录/monorepo 行为未定义，路径过滤规则缺乏可验证边界。
- 结果融合确定性与错误码/退出码契约缺口：去重/排序/摘要长度/冲突处理与 error.code 枚举未明示，影响稳定性与可测试性。
- 安装/升级/卸载/验证路径未成文：Claude hook 与 Codex wrapper 的安装位置、PATH 要求与回滚验证流程缺失。

**必须修改项**（若 Revise）：
- [ ] Codex CLI 入口 A 的会话连续性方案：以 `codex exec resume --last` 为首选路径，失败即降级为无会话模式，并给出最小可实现路径。
- [ ] 明确 `CI_AUTO_TOOLS_MODE=plan` 或 `--dry-run` 的输出接口：输出增强 prompt/编排 JSON，且在此模式下不调用 codex；补充 bats 用例断言。
- [ ] repo-root 判定规则：`git rev-parse --show-toplevel`/`pwd`/配置的优先级；无 git/monorepo/子目录场景的行为与错误处理。
- [ ] 结果融合确定性规则：去重键、聚合顺序（稳定排序）、摘要长度/截断策略、冲突结论呈现；并给出示例。
- [ ] 定义 error.code 与入口层退出码枚举，说明超时/解析失败/工具不可用等失败类型的降级路径与用户可见文本。
- [ ] 补充安装/升级/卸载/验证流程：Claude hooks 与 Codex wrapper 的安装位置、PATH/配置依赖、回滚与验证命令。

**验证要求**：
- [ ] bats 覆盖 plan/dry-run 输出：给定固定 prompt，断言输出包含 `schema_version/run_id/tool_plan` 且未执行 codex。
- [ ] e2e/脚本验证 Codex wrapper 会话恢复：模拟连续两轮 prompt，验证 `codex exec resume --last` 或降级逻辑与 [Limits] 输出。
- [ ] 路径过滤验证用例：在无 git/子目录/monorepo 三场景下，断言 repo-root 解析与过滤行为一致。
- [ ] 结果融合确定性验证：同一输入重复执行输出顺序与摘要长度稳定（含示例断言）。
- [ ] 错误码/退出码验证：模拟 timeout/解析失败/工具不可用并断言 code 与 [Limits] 文本一致。

### 2026-01-23 修订说明（Author）

- 已收敛入口层为“输入采集 + 输出注入”，明确迁移/去重路径与回滚策略，确保工具调用统一进入编排内核。
- 已将 Codex CLI 会话连续性改为 `codex exec resume --last` 优先、失败即降级为无会话模式，不再依赖 `--json/session_id`。
- 已补齐“唯一工具通道 + 绕过拒绝”策略与 [Limits] 提示，并在 AC-006/AC-009 补充绕过与 Tier-2 提示验证锚点。
- 已明确 Tier-2 唯一启用入口为 `CI_AUTO_TOOLS_TIER_MAX=2`，默认提示文本与最短用户决策树。

### 2026-01-23 裁决：Revise

**理由摘要**：
- 编排内核与现有 `hooks/context-inject-global.sh` 的边界仍停留在描述层，未给出迁移/复用或去重路径；在现有脚本已包含编排逻辑的前提下存在“双轨并存、行为不一致”的风险。
- Codex CLI 会话连续性仍未确定唯一可验证路径，需要明确 `codex exec resume --last` 的可用性与降级边界，确保 AC-002 可测试。
- 参数裁剪/白名单“强制执行”缺少对入口层直连工具路径的拦截或迁移说明，存在绕过编排内核导致安全边界失效的风险。
- Tier-2 的显式触发与用户提示仍不够可执行（仅给开关、缺少触发方式与默认提示行为），MVP 的可用性与范围收敛仍不清晰。

**必须修改项**（若 Revise）：
- [ ] 给出 `hooks/context-inject-global.sh` 与 `hooks/auto-tool-orchestrator.sh` 的迁移/复用方案：明确哪些既有编排逻辑会被移出或封装进内核，保证入口层不再直接调用工具；补充向后兼容与回滚策略。
- [ ] 移除 `codex exec --json/session_id` 依赖，改为 `codex exec resume --last` 优先、失败即降级为无会话模式，并明确 AC-002 的可验证锚点。
- [ ] 明确参数裁剪/白名单的唯一执行点与绕过检测机制：定义入口层调用工具的唯一通道，或提供拦截/拒绝策略，并在 [Limits] 明示裁剪原因。
- [ ] 明确 Tier-2 的显式触发路径与用户提示：定义 CLI 参数/环境变量/配置的唯一入口，默认情况下输出清晰提示并指向启用方法，说明何时建议启用。

**验证要求**：
- [ ] 增加迁移/互斥验证：静态检查或 bats 断言入口层所有工具调用均经编排内核；验证回滚路径可用。
- [ ] 提供 `codex exec resume --last` 的可重复验证步骤，并验证不可用/失败时降级输出包含 [Limits] 说明。
- [ ] 增加参数裁剪绕过测试：构造入口层直连或超限参数输入，验证被裁剪/拒绝且 [Limits] 可见。
- [ ] 增加 Tier-2 启用提示验证：默认配置触发 Tier-2 意图时输出“需显式启用”的提示；启用后进入 plan。

### 2026-01-23 裁决：Revise

**理由摘要**：
- “批准流程”仍要求显式勾选（“默认选择：无/需显式确认”），与“默认保守且不阻塞闭环”的约束冲突。
- Codex 会话连续性在 plan/dry-run 下的判定路径不自洽：既要求不调用 codex，又以 `codex exec resume --help` 作为能力检测，导致 AC-002/AC-003 无法确定性验证。
- 结果融合的“冲突结论”仅给出展示规则，缺少可执行的冲突判定标准，AC-011 无法稳定编写测试。

**必须修改项**（若 Revise）：
- [ ] 移除“显式勾选才开始”的阻塞式流程：将“快速批准/自定义”改为默认保守方案 + 可选项（放入 Debate Packet），不要求用户显式确认。
- [ ] 明确 plan/dry-run 下会话路径的判定机制：在不调用 codex 的前提下，用可配置开关/规则决定 `resume --last` 或 `exec`，并同步更新 AC-002/AC-003。
- [ ] 定义冲突判定规则（最小可执行）：例如基于同一去重键 + 明确的 `polarity/claim` 字段对立，或给出明确的结构化冲突信号；补充到 AC-011 与示例。

**验证要求**：
- [ ] bats：在 plan/dry-run 模式下用显式开关分别强制 `resume --last` 与 `exec`，断言 `planned_codex_command` 与 “不调用 codex” 同时成立。
- [ ] bats：构造同一去重键的互斥结论样例，验证冲突标记与 [Results] 输出稳定且可重复。

#!/usr/bin/env bats
# augment-context.bats - Structured context output tests
#
# Trace: AC-G11, AC-G12

load 'helpers/common'

HOOKS_DIR="$BATS_TEST_DIRNAME/../hooks"
AUGMENT_CONTEXT="$HOOKS_DIR/augment-context-global.sh"

PROJECT_WITH_DEVBOOKS=""
PROJECT_NO_DEVBOOKS=""

setup() {
    setup_temp_dir

    PROJECT_WITH_DEVBOOKS="$TEST_TEMP_DIR/project-devbooks"
    PROJECT_NO_DEVBOOKS="$TEST_TEMP_DIR/project-basic"

    mkdir -p "$PROJECT_WITH_DEVBOOKS" "$PROJECT_NO_DEVBOOKS"

    cat > "$PROJECT_WITH_DEVBOOKS/package.json" << 'EOF'
{
  "name": "devbooks-sample",
  "version": "0.0.1"
}
EOF

    cat > "$PROJECT_NO_DEVBOOKS/package.json" << 'EOF'
{
  "name": "basic-sample",
  "version": "0.0.1"
}
EOF

    mkdir -p "$PROJECT_WITH_DEVBOOKS/.devbooks"
    cat > "$PROJECT_WITH_DEVBOOKS/.devbooks/config.yaml" << 'EOF'
root: dev-playbooks/
paths:
  specs: specs/
  changes: changes/
EOF

    mkdir -p "$PROJECT_WITH_DEVBOOKS/dev-playbooks/specs/_meta"
    cat > "$PROJECT_WITH_DEVBOOKS/dev-playbooks/specs/_meta/project-profile.md" << 'EOF'
# 项目画像

## 技术栈
- Node.js
- TypeScript
- Bash

## 第一层：快速定位
- build: npm run build
- test: npm test
- lint: npm run lint

## 约束
- CON-TECH-002: MCP Server 使用 Node.js 薄壳调用 Shell 脚本
EOF

    mkdir -p "$PROJECT_WITH_DEVBOOKS/dev-playbooks/specs/architecture"
    cat > "$PROJECT_WITH_DEVBOOKS/dev-playbooks/specs/architecture/c4.md" << 'EOF'
# 架构地图

## 分层约束
- 分层规则：shared ← core ← integration
- 禁止：scripts/*.sh → src/*.ts
EOF
}

teardown() {
    cleanup_temp_dir
}

run_context_json() {
    local workdir="$1"
    local input_file="$workdir/input.json"
    printf '%s' '{"prompt":"how does auth module work?"}' > "$input_file"

    run env WORKING_DIRECTORY="$workdir" "$AUGMENT_CONTEXT" --format json < "$input_file"
}

require_structured_object() {
    local json="$1"
    local output_type
    output_type=$(echo "$json" | jq -r 'type' 2>/dev/null || echo "")
    if [ "$output_type" != "object" ]; then
        skip_not_implemented "structured output object"
    fi
}

@test "test_structured_output_profile: output contains project_profile" {
    skip_if_missing "jq"
    [ -x "$AUGMENT_CONTEXT" ] || skip "augment-context-global.sh not executable"

    run_context_json "$PROJECT_WITH_DEVBOOKS"
    skip_if_not_ready "$status" "$output" "augment-context-global.sh --format json"

    if ! echo "$output" | jq . >/dev/null 2>&1; then
        skip_not_implemented "structured output json"
    fi

    require_structured_object "$output"

    local has_profile
    has_profile=$(echo "$output" | jq -r 'has("project_profile")')
    if [ "$has_profile" != "true" ]; then
        skip_not_implemented "project_profile field"
    fi
}

@test "test_structured_output_state: output contains current_state" {
    skip_if_missing "jq"
    [ -x "$AUGMENT_CONTEXT" ] || skip "augment-context-global.sh not executable"

    run_context_json "$PROJECT_WITH_DEVBOOKS"
    skip_if_not_ready "$status" "$output" "augment-context-global.sh --format json"

    if ! echo "$output" | jq . >/dev/null 2>&1; then
        skip_not_implemented "structured output json"
    fi

    require_structured_object "$output"

    local has_state
    has_state=$(echo "$output" | jq -r 'has("current_state")')
    if [ "$has_state" != "true" ]; then
        skip_not_implemented "current_state field"
    fi
}

@test "test_structured_output_task: output contains task_context" {
    skip_if_missing "jq"
    [ -x "$AUGMENT_CONTEXT" ] || skip "augment-context-global.sh not executable"

    run_context_json "$PROJECT_WITH_DEVBOOKS"
    skip_if_not_ready "$status" "$output" "augment-context-global.sh --format json"

    if ! echo "$output" | jq . >/dev/null 2>&1; then
        skip_not_implemented "structured output json"
    fi

    require_structured_object "$output"

    local has_task
    has_task=$(echo "$output" | jq -r 'has("task_context")')
    if [ "$has_task" != "true" ]; then
        skip_not_implemented "task_context field"
    fi
}

@test "test_structured_output_tools: output contains recommended_tools" {
    skip_if_missing "jq"
    [ -x "$AUGMENT_CONTEXT" ] || skip "augment-context-global.sh not executable"

    run_context_json "$PROJECT_WITH_DEVBOOKS"
    skip_if_not_ready "$status" "$output" "augment-context-global.sh --format json"

    if ! echo "$output" | jq . >/dev/null 2>&1; then
        skip_not_implemented "structured output json"
    fi

    require_structured_object "$output"

    local has_tools
    has_tools=$(echo "$output" | jq -r 'has("recommended_tools")')
    if [ "$has_tools" != "true" ]; then
        skip_not_implemented "recommended_tools field"
    fi
}

@test "test_structured_output_constraints: output contains constraints" {
    skip_if_missing "jq"
    [ -x "$AUGMENT_CONTEXT" ] || skip "augment-context-global.sh not executable"

    run_context_json "$PROJECT_WITH_DEVBOOKS"
    skip_if_not_ready "$status" "$output" "augment-context-global.sh --format json"

    if ! echo "$output" | jq . >/dev/null 2>&1; then
        skip_not_implemented "structured output json"
    fi

    require_structured_object "$output"

    local has_constraints
    has_constraints=$(echo "$output" | jq -r 'has("constraints")')
    if [ "$has_constraints" != "true" ]; then
        skip_not_implemented "constraints field"
    fi
}

@test "test_structured_output_schema: output includes all required layers" {
    skip_if_missing "jq"
    [ -x "$AUGMENT_CONTEXT" ] || skip "augment-context-global.sh not executable"

    run_context_json "$PROJECT_WITH_DEVBOOKS"
    skip_if_not_ready "$status" "$output" "augment-context-global.sh --format json"

    if ! echo "$output" | jq . >/dev/null 2>&1; then
        skip_not_implemented "structured output json"
    fi

    require_structured_object "$output"

    # Verify all 5 required top-level layers exist
    local required
    required=$(echo "$output" | jq -r '. as $root | ["project_profile","current_state","task_context","recommended_tools","constraints"] as $keys | reduce $keys[] as $k (true; . and ($root | has($k)))')
    if [ "$required" != "true" ]; then
        skip_not_implemented "structured output layers"
    fi

    # Additional depth verification for each layer

    # Verify project_profile has nested fields
    local profile_has_name profile_has_tech profile_has_constraints
    profile_has_name=$(echo "$output" | jq -r 'has("project_profile") and (.project_profile | has("name") or has("project_name"))')
    profile_has_tech=$(echo "$output" | jq -r 'has("project_profile") and (.project_profile | has("tech_stack") or has("technologies"))')
    profile_has_constraints=$(echo "$output" | jq -r 'has("project_profile") and (.project_profile | has("key_constraints") or has("constraints"))')

---
#!/usr/bin/env bats
# ci.bats - CI/CD architecture check tests
#
# Trace: AC-G09

load 'helpers/common'

PROJECT_ROOT="$BATS_TEST_DIRNAME/.."
WORKFLOW_FILE="$PROJECT_ROOT/.github/workflows/arch-check.yml"
GITLAB_TEMPLATE="$PROJECT_ROOT/.gitlab-ci.yml.template"

@test "test_workflow_syntax: GitHub Action workflow passes actionlint" {
    skip_if_missing "actionlint"

    if [ ! -f "$WORKFLOW_FILE" ]; then
        skip_not_implemented "arch-check workflow file"
    fi

    run actionlint "$WORKFLOW_FILE"
    assert_exit_success "$status"
}

@test "test_workflow_trigger: workflow triggers on PR and workflow_dispatch" {
    if [ ! -f "$WORKFLOW_FILE" ]; then
        skip_not_implemented "arch-check workflow file"
    fi

    grep -q "pull_request" "$WORKFLOW_FILE" || skip_not_implemented "pull_request trigger"
    grep -q "workflow_dispatch" "$WORKFLOW_FILE" || skip_not_implemented "workflow_dispatch trigger"

    # Branch filter should include common main branch names
    if ! grep -qE "branches:.*\[.*main.*\]|branches:.*\[.*master.*\]" "$WORKFLOW_FILE"; then
        # Also check for YAML list format
        if ! grep -qE "^\s*-\s*(main|master)\s*$" "$WORKFLOW_FILE"; then
            skip_not_implemented "branch filter for main/master"
        fi
    fi
}

@test "test_workflow_cycles: workflow runs dependency cycle check" {
    if [ ! -f "$WORKFLOW_FILE" ]; then
        skip_not_implemented "arch-check workflow file"
    fi

    grep -q "dependency-guard.sh --cycles" "$WORKFLOW_FILE" || skip_not_implemented "cycle check step"
}

@test "test_workflow_violations: workflow runs architecture rule check" {
    if [ ! -f "$WORKFLOW_FILE" ]; then
        skip_not_implemented "arch-check workflow file"
    fi

    grep -q "boundary-detector.sh detect" "$WORKFLOW_FILE" || skip_not_implemented "architecture rule check"
}

@test "test_workflow_orphan: workflow runs orphan module detection" {
    if [ ! -f "$WORKFLOW_FILE" ]; then
        skip_not_implemented "arch-check workflow file"
    fi

    # Check for orphan detection step - could be via dependency-guard or dedicated script
    local has_orphan=false

    if grep -qE "orphan|--orphan|orphan-detection|unused.module" "$WORKFLOW_FILE"; then
        has_orphan=true
    fi

    # Alternative: orphan check might be part of dependency-guard with different flag
    if grep -qE "dependency-guard.sh.*(--all|--orphan|--unused)" "$WORKFLOW_FILE"; then
        has_orphan=true
    fi

    # Alternative: separate orphan detection script
    if grep -qE "orphan-detector|detect-orphan|find.*orphan" "$WORKFLOW_FILE"; then
        has_orphan=true
    fi

    if [ "$has_orphan" != "true" ]; then
        skip_not_implemented "orphan module detection step"
    fi
}

@test "test_workflow_success: workflow fails when checks fail" {
    if [ ! -f "$WORKFLOW_FILE" ]; then
        skip_not_implemented "arch-check workflow file"
    fi

    # Check for failure gate - should fail if any check fails
    local has_failure_gate=false

    if grep -q "Fail if checks failed" "$WORKFLOW_FILE"; then
        has_failure_gate=true
    fi

    if grep -qE "steps\.(cycles|violations|orphan)\.outputs\.status" "$WORKFLOW_FILE"; then
        has_failure_gate=true
    fi

    if grep -qE "if:.*failure\(\)|continue-on-error:\s*false" "$WORKFLOW_FILE"; then
        has_failure_gate=true
    fi

    # Check for exit code propagation
    if grep -qE "exit\s+\\\$\?|exit\s+1|\|\|\s+exit" "$WORKFLOW_FILE"; then
        has_failure_gate=true
    fi

    if [ "$has_failure_gate" != "true" ]; then
        skip_not_implemented "failure gate"
    fi
}

@test "test_gitlab_template: GitLab CI template includes arch checks" {
    if [ ! -f "$GITLAB_TEMPLATE" ]; then
        skip_not_implemented "gitlab ci template"
    fi

    grep -q "dependency-guard.sh --cycles" "$GITLAB_TEMPLATE" || skip_not_implemented "gitlab cycle check"
    grep -q "boundary-detector.sh detect" "$GITLAB_TEMPLATE" || skip_not_implemented "gitlab architecture check"
}

@test "test_gitlab_template_orphan: GitLab CI template includes orphan detection" {
    if [ ! -f "$GITLAB_TEMPLATE" ]; then
        skip_not_implemented "gitlab ci template"
    fi

    # Check for orphan detection in GitLab template
    local has_orphan=false

    if grep -qE "orphan|--orphan|orphan-detection" "$GITLAB_TEMPLATE"; then
        has_orphan=true
    fi

    if grep -qE "dependency-guard.sh.*(--all|--orphan|--unused)" "$GITLAB_TEMPLATE"; then
        has_orphan=true
    fi

    if [ "$has_orphan" != "true" ]; then
        skip_not_implemented "gitlab orphan module detection"
    fi
}
---
total 40
drwxr-xr-x   3 ozbombor  staff     96 Jan 16 02:14 .
drwxr-xr-x  42 ozbombor  staff   1344 Jan 23 02:47 ..
-rw-r--r--   1 ozbombor  staff  18671 Jan 19 06:30 common.bash
total 40
drwxr-xr-x  14 ozbombor  staff   448 Jan 19 22:23 .
drwxr-xr-x  42 ozbombor  staff  1344 Jan 23 02:47 ..
drwxr-xr-x   9 ozbombor  staff   288 Jan 19 22:31 benchmark
drwxr-xr-x   3 ozbombor  staff    96 Jan 19 06:08 context-compressor
drwxr-xr-x   3 ozbombor  staff    96 Jan 19 06:01 drift-detector
drwxr-xr-x   3 ozbombor  staff    96 Jan 19 22:24 graph-store
-rw-r--r--   1 ozbombor  staff   150 Jan 15 03:19 llm-rerank-disabled.yaml
-rw-r--r--   1 ozbombor  staff   160 Jan 15 03:19 llm-rerank-enabled.yaml
-rw-r--r--   1 ozbombor  staff   152 Jan 15 03:20 llm-rerank-ollama.yaml
-rw-r--r--   1 ozbombor  staff   120 Jan 15 03:20 llm-rerank-openai.yaml
-rw-r--r--   1 ozbombor  staff   123 Jan 15 03:20 llm-rerank-retry.yaml
drwxr-xr-x   3 ozbombor  staff    96 Jan 19 06:31 long-term-memory
drwxr-xr-x   4 ozbombor  staff   128 Jan 19 04:48 performance
drwxr-xr-x   5 ozbombor  staff   160 Jan 19 04:49 semantic-anomaly

# Spec: incremental-indexing

> **Version**: 1.0.0
> **Status**: Active
> **Owner**: Spec Owner
> **Created**: 2026-01-11
> **Last Verified**: 2026-01-11
> **Freshness Check**: 90 days
> **Source Change**: enhance-code-intelligence

---

## Purpose

提供基于 SCIP 的增量索引能力，单文件变更时只更新相关索引节点，避免全量重建，提升开发体验和索引性能。

---

## Requirements

### Requirement: SCIP-Based Incremental Indexing

系统 SHALL 基于 SCIP 索引实现增量更新，单文件变更不需要全量重建索引。

前置条件：`index.scip` 文件存在。

#### Scenario: Incremental update single file

- **GIVEN** `index.scip` 已存在
- **AND** 用户修改了 `src/server.ts` 单个文件
- **WHEN** 执行增量索引
- **THEN** 只更新 `src/server.ts` 相关的索引节点
- **AND** 其他文件的索引保持不变
- **AND** 更新耗时 < 1 秒

Trace: AC-007

#### Scenario: Incremental update multiple files

- **GIVEN** `index.scip` 已存在
- **AND** 用户修改了 3 个文件
- **WHEN** 执行增量索引
- **THEN** 只更新这 3 个文件相关的索引节点
- **AND** 更新耗时与修改文件数成正比

Trace: AC-007

#### Scenario: Full reindex when SCIP missing

- **GIVEN** `index.scip` 不存在
- **WHEN** 执行索引操作
- **THEN** 返回错误提示 "SCIP 索引不存在，请先运行 scip-typescript index"
- **AND** 不执行任何索引操作

Trace: AC-007

---

### Requirement: Change Detection via Git Diff

系统 SHALL 使用 git diff 检测自上次索引以来的文件变更。

#### Scenario: Detect changed files

- **GIVEN** 上次索引时间戳记录在 `.ci-cache/last-index-time`
- **WHEN** 执行变更检测
- **THEN** 返回自该时间戳以来变更的文件列表
- **AND** 列表包含新增、修改、删除的文件

Trace: AC-007

#### Scenario: No changes detected

- **GIVEN** 自上次索引以来无文件变更
- **WHEN** 执行增量索引
- **THEN** 返回 "索引已是最新，无需更新"
- **AND** 不执行任何索引操作

Trace: AC-007

---

### Requirement: Graceful Degradation to Full Index

系统 SHALL 在增量索引失败时降级为全量索引。

#### Scenario: Incremental fails, fallback to full

- **GIVEN** 增量索引过程中发生错误
- **WHEN** 检测到错误
- **THEN** 降级执行全量索引
- **AND** 日志记录 "增量索引失败，降级为全量索引"

Trace: AC-007

---

## Data Examples

### Incremental Index Output

```json
{
  "operation": "incremental",
  "changed_files": [
    {"path": "src/server.ts", "action": "modified"},
    {"path": "scripts/new-script.sh", "action": "added"}
  ],
  "updated_symbols": 15,
  "duration_ms": 450,
  "timestamp": "2026-01-11T10:30:00Z"
}
```

### Full Index Fallback Output

```json
{
  "operation": "full",
  "reason": "incremental_failed",
  "error": "Symbol reference mismatch",
  "total_files": 36,
  "total_symbols": 245,
  "duration_ms": 3200,
  "timestamp": "2026-01-11T10:31:00Z"
}
```

### Performance Expectations

| 场景 | 文件数 | 预期耗时 |
|------|--------|----------|
| 单文件增量 | 1 | < 1s |
| 多文件增量 | 5 | < 2s |
| 全量索引 | 36 | < 5s |
| 大型项目全量 | 1000 | < 60s |
# 规格：M1 AST Delta 增量索引

> **模块 ID**: `ast-delta`
> **Change ID**: `achieve-augment-full-parity`
> **Date**: 2026-01-16
> **Status**: Draft

---

## Requirements（需求）

### REQ-AD-001: 增量 AST 解析

系统必须支持对单个文件的增量 AST 解析，而非每次变更都进行全量重建。

**约束**：
- 使用 tree-sitter npm 包（`tree-sitter` + `tree-sitter-typescript`）
- 解析目标：TypeScript 文件
- 必须支持降级路径（tree-sitter → SCIP → regex）

### REQ-AD-002: AST 缓存管理

系统必须维护 AST 缓存以支持增量更新。

**约束**：
- 缓存位置：`.devbooks/ast-cache/`
- 缓存大小上限：50MB
- 缓存 TTL：30 天
- 必须使用原子写入策略

### REQ-AD-003: 索引协调协议

系统必须实现 tree-sitter 增量更新与 SCIP 全量重建之间的协调机制。

**约束**：
- 版本戳一致性检查
- SCIP 重建后自动清理 AST 缓存
- 变更文件数阈值：10 个

### REQ-AD-004: 性能要求

单文件增量更新必须满足性能目标。

**约束**：
- P95 延迟 < 100ms（±20%，上限 120ms）
- 测试条件：100-1000 行 TypeScript 文件

---

## Scenarios（场景）

### SC-AD-001: 单文件增量更新

**Given**：
- tree-sitter 可用
- AST 缓存存在且版本戳一致
- 用户修改了单个 TypeScript 文件

**When**：
- 调用 `ast-delta.sh update <file-path>`

**Then**：
- 系统解析新 AST
- 计算与缓存 AST 的差异（added/removed/modified）
- 更新 graph.db 中的对应节点和边
- 更新 AST 缓存
- 返回 Delta 摘要

**验证**：`tests/ast-delta.bats::test_single_file_update`

### SC-AD-002: 批量增量更新

**Given**：
- tree-sitter 可用
- AST 缓存存在
- 变更文件数 ≤ 10

**When**：
- 调用 `ast-delta.sh batch --since HEAD~1`

**Then**：
- 系统检测所有变更文件
- 对每个文件执行增量更新
- 返回批量 Delta 摘要

**验证**：`tests/ast-delta.bats::test_batch_update`

### SC-AD-003: 缓存失效触发全量重建

**Given**：
- AST 缓存版本戳与 graph.db 不一致
- 或 AST 缓存不存在

**When**：
- 调用 `ast-delta.sh update <file-path>`

**Then**：
- 系统检测到缓存失效
- 执行 FULL_REBUILD 路径
- 清理旧 AST 缓存
- 调用 SCIP 全量重建
- 更新版本戳

**验证**：`tests/ast-delta.bats::test_cache_invalidation`

### SC-AD-004: tree-sitter 不可用降级

**Given**：
- tree-sitter npm 包未安装或加载失败

**When**：
- 调用 `ast-delta.sh update <file-path>`

**Then**：
- 系统检测到 tree-sitter 不可用
- 执行 FALLBACK 路径
- 降级到 SCIP 解析（如可用）
- 或降级到 regex 匹配（最低保障）
- 输出降级警告

**验证**：`tests/ast-delta.bats::test_fallback_to_scip`

### SC-AD-005: 大规模变更触发全量重建

**Given**：
- 变更文件数 > 10

**When**：
- 调用 `ast-delta.sh batch --since <ref>`

**Then**：
- 系统检测到变更规模过大
- 执行 FULL_REBUILD 路径
- 输出提示信息

**验证**：`tests/ast-delta.bats::test_large_change_triggers_rebuild`

### SC-AD-006: 性能验证

**Given**：
- tree-sitter 可用
- 测试文件：src/server.ts（约 500 行）

**When**：
- 执行 50 次 AST 解析（排除首次预热）

**Then**：
- P95 延迟 ≤ 120ms
- 输出性能报告

**验证**：`tests/ast-delta.bats::test_performance`

### SC-AD-007: 原子写入保护

**Given**：
- 正在写入 AST 缓存时进程被终止

**When**：
- 下次调用 ast-delta.sh

**Then**：
- 系统清理孤儿临时文件（.tmp.* 文件超过 5 分钟）
- 不会读取到损坏的缓存文件
- 正常执行更新流程

**验证**：`tests/ast-delta.bats::test_atomic_write`

---

## Traceability Matrix（追溯矩阵）

| Requirement | Scenarios |
|-------------|-----------|
| REQ-AD-001 | SC-AD-001, SC-AD-002, SC-AD-004 |
| REQ-AD-002 | SC-AD-003, SC-AD-007 |
| REQ-AD-003 | SC-AD-003, SC-AD-005 |
| REQ-AD-004 | SC-AD-006 |

| Scenario | Test ID |
|----------|---------|
| SC-AD-001 | `tests/ast-delta.bats::test_single_file_update` |
| SC-AD-002 | `tests/ast-delta.bats::test_batch_update` |
| SC-AD-003 | `tests/ast-delta.bats::test_cache_invalidation` |
| SC-AD-004 | `tests/ast-delta.bats::test_fallback_to_scip` |
| SC-AD-005 | `tests/ast-delta.bats::test_large_change_triggers_rebuild` |
| SC-AD-006 | `tests/ast-delta.bats::test_performance` |
| SC-AD-007 | `tests/ast-delta.bats::test_atomic_write` |
---
last_referenced_by: 20260118-0057-upgrade-code-intelligence-capabilities
last_verified: 2026-01-18
health: active
---

# 规格：MCP 工具 JSON 输出格式扩展

| 属性 | 值 |
|------|-----|
| Spec-ID | SPEC-MCP-OUTPUT-001 |
| Change-ID | 20260118-0057-upgrade-code-intelligence-capabilities |
| 版本 | 1.0.0 |
| 状态 | Active |
| 作者 | Spec Owner |
| 创建日期 | 2026-01-18 |

---

## 1. Requirements（需求规格）

### REQ-MCP-001: metadata.ckb_available 字段

**描述**：所有返回 JSON 的 MCP 工具必须在 `metadata` 对象中包含 `ckb_available` 布尔字段，指示 CKB MCP 服务是否可用。

**触发工具**：
- `ci_graph_rag`
- `ci_call_chain`（如有 CKB 增强）

**字段定义**：
| 字段 | 类型 | 必需 | 默认值 | 说明 |
|------|------|------|--------|------|
| `metadata.ckb_available` | boolean | 是 | - | CKB MCP 是否可用 |

**取值规则**：
- `true`：CKB MCP 健康检查通过，使用 CKB 图数据
- `false`：CKB MCP 不可用，使用本地降级数据

---

### REQ-MCP-002: metadata.ckb_fallback_reason 字段

**描述**：当 `ckb_available = false` 时，必须提供 `ckb_fallback_reason` 字段说明降级原因。

**字段定义**：
| 字段 | 类型 | 必需 | 条件 | 说明 |
|------|------|------|------|------|
| `metadata.ckb_fallback_reason` | string | 条件 | 当 `ckb_available = false` | 降级原因 |

**枚举值**：
| 值 | 说明 |
|----|------|
| `connection_timeout` | CKB 连接超时（>5s） |
| `mcp_error` | CKB MCP 工具调用错误 |
| `health_check_failed` | CKB 健康检查失败 |
| `cooldown` | 处于降级冷却期（60s 内） |
| `disabled` | CKB 集成被禁用（配置） |

---

### REQ-MCP-003: metadata.fusion_depth 字段

**描述**：融合查询返回的结果中必须包含 `fusion_depth` 字段，指示图扩展的实际深度。

**字段定义**：
| 字段 | 类型 | 必需 | 范围 | 说明 |
|------|------|------|------|------|
| `metadata.fusion_depth` | integer | 是 | 0-5 | 融合查询的图扩展深度 |

**取值规则**：
- `0`：仅向量搜索，无图扩展
- `1`：1-hop 图扩展（默认，当前版本固定值）
- `2-5`：多跳图扩展（未来版本支持）

---

## 2. Scenarios（场景规格）

### SC-MCP-001: CKB 可用时的正常输出

**Given**：
- CKB MCP Server 运行中
- CKB 健康检查通过（<5s 响应）

**When**：
- 调用 `ci_graph_rag` 工具，query = "test function"

**Then**：
```json
{
  "candidates": [
    {"file": "src/test.ts", "relevance": 0.85, "content": "..."}
  ],
  "metadata": {
    "ckb_available": true,
    "fusion_depth": 1,
    "total_candidates": 12,
    "query_time_ms": 150
  }
}
```

---

### SC-MCP-002: CKB 连接超时降级

**Given**：
- CKB MCP Server 响应延迟 > 5s

**When**：
- 调用 `ci_graph_rag` 工具

**Then**：
```json
{
  "candidates": [...],
  "metadata": {
    "ckb_available": false,
    "ckb_fallback_reason": "connection_timeout",
    "ckb_last_error": "Connection timeout after 5000ms",
    "fallback_mode": "local_graph",
    "fusion_depth": 1
  }
}
```

---

### SC-MCP-003: CKB 降级冷却期

**Given**：
- CKB 刚降级（<60s 前）

**When**：
- 调用 `ci_graph_rag` 工具

**Then**：
```json
{
  "candidates": [...],
  "metadata": {
    "ckb_available": false,
    "ckb_fallback_reason": "cooldown",
    "ckb_cooldown_remaining_s": 45,
    "fusion_depth": 1
  }
}
```

---

### SC-MCP-004: CKB 禁用时的输出

**Given**：
- 配置 `ckb_integration.enabled = false`

**When**：
- 调用 `ci_graph_rag` 工具

**Then**：
```json
{
  "candidates": [...],
  "metadata": {
    "ckb_available": false,
    "ckb_fallback_reason": "disabled",
    "fusion_depth": 1
  }
}
```

---

## 3. API/Schema 契约

### 3.1 JSON Schema 定义

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "mcp-output-metadata.schema.json",
  "title": "MCP Output Metadata",
  "description": "MCP 工具输出的 metadata 字段规格",
  "type": "object",
  "properties": {
    "ckb_available": {
      "type": "boolean",
      "description": "CKB MCP 是否可用"
    },
    "ckb_fallback_reason": {
      "type": "string",
      "enum": ["connection_timeout", "mcp_error", "health_check_failed", "cooldown", "disabled"],
      "description": "CKB 降级原因（仅当 ckb_available = false）"
    },
    "ckb_last_error": {
      "type": "string",
      "description": "CKB 最近的错误信息"
    },
    "ckb_cooldown_remaining_s": {
      "type": "integer",
      "minimum": 0,
      "maximum": 60,
      "description": "降级冷却剩余秒数"
    },
    "fallback_mode": {
      "type": "string",
      "enum": ["local_graph", "vector_only"],
      "description": "降级模式"
    },
    "fusion_depth": {
      "type": "integer",
      "minimum": 0,
      "maximum": 5,
      "description": "融合查询图扩展深度"
    }
  },
  "required": ["ckb_available", "fusion_depth"],
  "if": {
    "properties": { "ckb_available": { "const": false } }
  },
  "then": {
    "required": ["ckb_fallback_reason"]
  }
}
```

### 3.2 向后兼容性

| 变更类型 | 兼容性 | 说明 |
|----------|--------|------|
| 新增 `metadata.ckb_available` | 向后兼容 | 新增字段，旧客户端可忽略 |
| 新增 `metadata.ckb_fallback_reason` | 向后兼容 | 新增字段，旧客户端可忽略 |
| 新增 `metadata.fusion_depth` | 向后兼容 | 新增字段，旧客户端可忽略 |

### 3.3 弃用策略

无弃用项。

---

## 4. Contract Tests

### CT-MCP-001: ckb_available 字段存在性

**类型**：schema

**覆盖**：REQ-MCP-001

**验证脚本**：
```bash
graph-rag.sh --query "test" --format json | jq -e '.metadata | has("ckb_available")'
```

---

### CT-MCP-002: ckb_fallback_reason 条件必需

**类型**：behavior

**覆盖**：REQ-MCP-002
# 模块依赖图：Code Intelligence MCP Server

> 生成时间：2026-01-10
> 生成方式：传统分析（SCIP 索引不可用）

---

## 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        External Clients                          │
│                    (Claude Code, AI Assistants)                  │
└─────────────────────────────────────────────────────────────────┘
                               │
                               │ MCP Protocol (stdio)
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                         src/server.ts                            │
│                    (MCP Server - Thin Shell)                     │
│                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ ListTools   │  │ CallTool    │  │ Transport   │              │
│  │ Handler     │  │ Handler     │  │ (stdio)     │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                               │
                               │ execAsync (shell)
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                        scripts/                                  │
│                    (Core Functionality)                          │
│                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ embedding   │  │ call-chain  │  │ bug-locator │              │
│  │    .sh      │  │    .sh      │  │    .sh      │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ complexity  │  │ graph-rag   │  │  indexer    │              │
│  │    .sh      │  │    .sh      │  │    .sh      │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                  │
│  ┌─────────────┐  ┌─────────────┐                               │
│  │  common     │  │ cache-utils │  (shared utilities)           │
│  │    .sh      │  │    .sh      │                               │
│  └─────────────┘  └─────────────┘                               │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                      External Tools                              │
│                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  ripgrep    │  │     jq      │  │   Ollama/   │              │
│  │    (rg)     │  │             │  │   OpenAI    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                  │
│  ┌─────────────┐                                                 │
│  │  CKB MCP    │  (optional - for graph-based analysis)         │
│  │   Server    │                                                 │
│  └─────────────┘                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 模块清单

### 核心模块

| 模块 | 路径 | 职责 | 依赖 |
|------|------|------|------|
| MCP Server | `src/server.ts` | MCP 协议处理，工具调度 | @modelcontextprotocol/sdk |
| Embedding | `scripts/embedding.sh` | 语义代码搜索 | common.sh, Ollama/OpenAI |
| Call Chain | `scripts/call-chain.sh` | 调用链追踪 | common.sh, CKB MCP |
| Bug Locator | `scripts/bug-locator.sh` | Bug 位置定位 | common.sh, embedding.sh |
| Complexity | `scripts/complexity.sh` | 复杂度分析 | common.sh |
| Graph-RAG | `scripts/graph-rag.sh` | 图基上下文检索 | common.sh, CKB MCP |
| Indexer | `scripts/indexer.sh` | 索引管理 | common.sh |

### 共享模块

| 模块 | 路径 | 职责 |
|------|------|------|
| Common | `scripts/common.sh` | 共享函数、配置、日志 |
| Cache Utils | `scripts/cache-utils.sh` | 缓存管理 |
| Reranker | `scripts/reranker.sh` | LLM 重排序 |

### 钩子模块

| 模块 | 路径 | 职责 |
|------|------|------|
| Global Context | `hooks/augment-context-global.sh` | 全局上下文注入 |
| Embedding Context | `hooks/augment-context-with-embedding.sh` | Embedding 增强上下文 |
| Context | `hooks/augment-context.sh` | 基础上下文注入 |
| Cache Manager | `hooks/cache-manager.sh` | 钩子缓存管理 |

### CLI 入口

| 模块 | 路径 | 职责 |
|------|------|------|
| MCP 入口 | `bin/code-intelligence-mcp` | 启动 MCP Server |
| 搜索入口 | `bin/ci-search` | 独立搜索命令 |

---

## 依赖矩阵

```
                    │ common │ cache  │ embed  │ call   │ bug    │ graph  │
                    │  .sh   │ utils  │ ding   │ chain  │ locator│  rag   │
────────────────────┼────────┼────────┼────────┼────────┼────────┼────────┤
server.ts           │   -    │   -    │   ✓    │   ✓    │   ✓    │   ✓    │
embedding.sh        │   ✓    │   ✓    │   -    │   -    │   -    │   -    │
call-chain.sh       │   ✓    │   -    │   -    │   -    │   -    │   -    │
bug-locator.sh      │   ✓    │   -    │   ✓    │   ✓    │   -    │   -    │
complexity.sh       │   ✓    │   -    │   -    │   -    │   -    │   -    │
graph-rag.sh        │   ✓    │   ✓    │   ✓    │   -    │   -    │   -    │
indexer.sh          │   ✓    │   -    │   -    │   -    │   -    │   -    │
```

**图例**：
- `✓` = 直接依赖
- `-` = 无依赖

---

## 依赖方向规则

### 允许的依赖方向

```
server.ts → scripts/*.sh → common.sh
                        → cache-utils.sh
                        → 外部工具
```

### 禁止的依赖

- ❌ scripts/*.sh → src/*.ts（脚本不得依赖 TypeScript）
- ❌ common.sh → 其他功能脚本（共享模块不得依赖功能模块）
- ❌ 循环依赖

---

## 外部依赖

### 必需依赖

| 依赖 | 类型 | 来源 |
|------|------|------|
| @modelcontextprotocol/sdk | npm | package.json |
| Node.js | 运行时 | 系统 |
| Bash | 运行时 | 系统 |

### 推荐依赖

| 依赖 | 类型 | 用途 |
|------|------|------|
| ripgrep (rg) | CLI 工具 | 文本搜索 |
| jq | CLI 工具 | JSON 处理 |

### 可选依赖

| 依赖 | 类型 | 用途 |
|------|------|------|
| Ollama | 服务 | 本地 Embedding |
| OpenAI API | 服务 | 云端 Embedding |
| CKB MCP Server | MCP | 图基代码分析 |
│                               ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                         Shared Layer                                ││
│  │                                                                     ││
│  │  ┌─────────────────────────┐    ┌─────────────────────────┐        ││
│  │  │      common.sh          │    │     cache-utils.sh      │        ││
│  │  │  (shared functions,     │    │  (caching utilities)    │        ││
│  │  │   config, logging)      │    │  [被 cache-manager.sh   │        ││
│  │  │  [ENHANCED: Phase 2]    │    │   调用，协作层]          │        ││
│  │  └─────────────────────────┘    └─────────────────────────┘        ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                      Config Layer [NEW: Phase 2]                    ││
│  │                                                                     ││
│  │  ┌─────────────────────────┐    ┌─────────────────────────┐        ││
│  │  │  config/arch-rules.yaml │    │  config/federation.yaml │        ││
│  │  │  (架构规则定义)          │    │  (联邦仓库配置)          │        ││
│  │  └─────────────────────────┘    └─────────────────────────┘        ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Container Inventory

| Container | 路径 | 类型 | 职责 | 技术栈 |
|-----------|------|------|------|--------|
| MCP Server | `src/server.ts` | Application | MCP 协议处理，工具调度 | TypeScript, Node.js |
| Global Hook | `hooks/augment-context-global.sh` | Hook | 全局上下文注入，4 维意图分析 | Bash |
| **Pre-commit Hook** | `hooks/pre-commit` | Hook | 架构规则校验 + 循环依赖检测 | Bash |
| Embedding Search | `scripts/embedding.sh` | Script | 语义代码搜索 | Bash |
| Call Chain | `scripts/call-chain.sh` | Script | 调用链追踪，数据流追踪 | Bash |
| Bug Locator | `scripts/bug-locator.sh` | Script | Bug 位置定位（集成热点算法） | Bash |
| Complexity | `scripts/complexity.sh` | Script | 圈复杂度分析 | Bash |
| Graph-RAG | `scripts/graph-rag.sh` | Script | 子图检索，边界过滤 | Bash |
| Indexer | `scripts/indexer.sh` | Script | Embedding 索引管理 | Bash |
| Hotspot Analyzer | `scripts/hotspot-analyzer.sh` | Script | Frequency × Complexity 热点计算，**Phase 2: Bug 修复历史权重** | Bash |
| Boundary Detector | `scripts/boundary-detector.sh` | Script | 用户/库/生成代码边界识别 | Bash |
| Pattern Learner | `scripts/pattern-learner.sh` | Script | 语义模式学习与异常检测 | Bash |
| AST Diff | `scripts/ast-diff.sh` | Script | SCIP 增量索引 | Bash |
| **Cache Manager** | `scripts/cache-manager.sh` | Script | **多级缓存（L1 内存 + L2 文件）、mtime + blob hash 精确失效、LRU 淘汰** | Bash |
| **Dependency Guard** | `scripts/dependency-guard.sh` | Script | **循环依赖检测（DFS）、架构规则校验、Pre-commit 集成** | Bash |
| **Context Layer** | `scripts/context-layer.sh` | Script | **Commit 语义分类（fix/feat/refactor）、Bug 修复历史提取** | Bash |
| **Federation Lite** | `scripts/federation-lite.sh` | Script | **跨仓库契约发现、符号提取、联邦索引管理** | Bash |
| Common | `scripts/common.sh` | Shared | 共享函数、配置、日志，**Phase 2: 新增缓存共享函数** | Bash |
| Cache Utils | `scripts/cache-utils.sh` | Shared | 缓存管理（L2 基础函数），**被 cache-manager.sh 调用** | Bash |
| **Arch Rules Config** | `config/arch-rules.yaml` | Config | **架构规则定义（禁止导入、循环检测白名单）** | YAML |
| **Federation Config** | `config/federation.yaml` | Config | **联邦仓库配置（显式路径 + 自动发现）** | YAML |
| ***Graph Store*** | `scripts/graph-store.sh` | Script | ***SQLite 图存储，9 种边类型 CRUD，Schema v3 迁移，孤儿节点查询*** | Bash |
| ***SCIP Parser*** | `scripts/scip-to-graph.sh` | Script | ***SCIP 索引解析，symbol_roles 映射，IMPLEMENTS/EXTENDS/RETURNS_TYPE 边类型提取，正则降级*** | Bash |
| ***Daemon*** | `scripts/daemon.sh` | Script | ***常驻守护进程，Unix Socket 通信，自动预热，P95 < 500ms*** | Bash |
| ***Features Config*** | `config/features.yaml` | Config | ***功能开关配置（LLM 重排序、孤儿检测、模式发现）*** | YAML |
| ****AST Delta TS**** | `src/ast-delta.ts` | Module | ****TypeScript tree-sitter 解析薄壳，AST 差异计算**** | TypeScript |
| ****AST Delta**** | `scripts/ast-delta.sh` | Script | ****增量 AST 解析协调，缓存管理，图更新触发**** | Bash |
| ****Impact Analyzer**** | `scripts/impact-analyzer.sh` | Script | ****传递性影响分析，BFS 图遍历，置信度衰减**** | Bash |
| ****COD Visualizer**** | `scripts/cod-visualizer.sh` | Script | ****架构可视化，Mermaid + D3.js JSON 输出**** | Bash |
| ****Intent Learner**** | `scripts/intent-learner.sh` | Script | ****查询历史记录，偏好分数计算，90 天自动清理**** | Bash |
| ****Vuln Tracker**** | `scripts/vuln-tracker.sh` | Script | ****npm audit 集成，漏洞扫描，依赖传播追踪**** | Bash |
| *****ADR Parser***** | `scripts/adr-parser.sh` | Script | *****ADR 解析与关联，MADR/Nygard 格式支持，生成 ADR_RELATED 边***** | Bash |
| *****GitHub Action***** | `.github/workflows/arch-check.yml` | CI/CD | *****PR 自动架构检查，循环依赖/孤儿模块/架构规则检测***** | YAML |
| *****GitLab CI Template***** | `.gitlab-ci.yml.template` | CI/CD | *****GitLab MR 架构检查模板***** | YAML |
| ******CKB Client Manager****** | `src/server.ts::CKBClientManager` | Component | ******CKB MCP 调用管理，健康检查，降级状态管理，60s 冷却期****** | TypeScript |
| ******Fusion Search****** | `scripts/embedding.sh::fusion_search()` | Function | ******图+向量融合查询，1-hop 图扩展，Token 预算分配****** | Bash |

**注**：粗体为 `augment-upgrade-phase2` 变更新增或增强的 Container。斜体粗体为 `augment-parity` 变更新增的 Container。四星粗体为 `achieve-augment-full-parity` 变更新增的 Container。五星粗体为 `augment-parity-final-gaps` 变更新增的 Container。六星粗体为 `upgrade-code-intelligence-capabilities` 变更新增的 Container。

**augment-parity-final-gaps 增强的 Container**：
| Container | 增强内容 |
|-----------|----------|
| `scripts/scip-to-graph.sh` | 边类型扩展：IMPLEMENTS/EXTENDS/RETURNS_TYPE/ADR_RELATED |
| `scripts/graph-store.sh` | 新增 `find-path`（A-B 最短路径）、`migrate`（Schema 迁移） |
| `scripts/intent-learner.sh` | 对话上下文持久化、会话管理、连续性加权 |
| `scripts/daemon.sh` | 预热机制（warmup）、请求取消协议 |
| `scripts/cache-manager.sh` | 子图 LRU 缓存（SQLite 持久化，跨进程共享） |
| `scripts/bug-locator.sh` | 影响分析融合（--with-impact, --impact-depth） |
| `hooks/augment-context-global.sh` | 5 层结构化上下文输出、DevBooks 适配注入 |
| `scripts/common.sh` | 新增 detect_devbooks()、load_devbooks_context() |

**upgrade-code-intelligence-capabilities 增强的 Container**：
| Container | 增强内容 |
|-----------|----------|
| `scripts/scip-to-graph.sh` | SCIP 解析器扩展：IMPLEMENTS/EXTENDS/RETURNS_TYPE 边类型提取，正则降级解析 |
| `scripts/graph-store.sh` | Schema v3 迁移：新增 3 种边类型索引，自动备份与回滚，并发迁移保护 |
| `src/server.ts` | CKB Client Manager：MCP Client SDK 集成，健康检查（5s 超时），降级状态管理（60s 冷却期） |
| `scripts/embedding.sh` | fusion_search() 函数：图+向量融合查询，1-hop 图扩展，Token 预算分配（60% embedding + 40% graph） |
| `scripts/graph-rag.sh` | 融合查询集成：--fusion-depth 参数，CKB 降级时本地 1-hop 遍历 |
| `scripts/daemon.sh` | 自动预热：start 后异步触发，30s 超时，不阻塞启动（< 2s） |

---

## C3: Component Level (Key Containers)

### src/server.ts Components

| Component | 职责 | 依赖 |
|-----------|------|------|
| `TOOLS` | MCP 工具定义数组 | - |
| `handleListTools()` | 列出可用工具 | TOOLS |
| `handleToolCall()` | 工具调用分发 | runScript() |
| `runScript()` | 执行 Shell 脚本 | execAsync |

**MCP Tools (15 个)**：
| 工具名 | 对应脚本 | 状态 |
|--------|----------|------|
| `ci_search` | embedding.sh | 已有 |
| `ci_call_chain` | call-chain.sh | 已有 |
| `ci_bug_locate` | bug-locator.sh | 已有 |
| `ci_complexity` | complexity.sh | 已有 |
| `ci_graph_rag` | graph-rag.sh | 已有，**Full Parity 增强：--budget** |
| `ci_index_status` | indexer.sh | 已有 |
| `ci_hotspot` | hotspot-analyzer.sh | 已有 |
| `ci_boundary` | boundary-detector.sh | 已有 |
| **`ci_arch_check`** | dependency-guard.sh | **Phase 2 新增** |
| **`ci_federation`** | federation-lite.sh | **Phase 2 新增，Full Parity 增强：--virtual-edges** |
| ****`ci_ast_delta`**** | ast-delta.sh | ****Full Parity 新增**** |
| ****`ci_impact`**** | impact-analyzer.sh | ****Full Parity 新增**** |
| ****`ci_cod`**** | cod-visualizer.sh | ****Full Parity 新增**** |
| ****`ci_intent`**** | intent-learner.sh | ****Full Parity 新增**** |
| ****`ci_vuln`**** | vuln-tracker.sh | ****Full Parity 新增**** |

### scripts/cache-manager.sh Components [NEW: Phase 2]

| Component | 职责 | 依赖 |
|-----------|------|------|
| `get_cached_with_validation()` | 带验证的缓存读取（L1 → L2 → Miss） | get_blob_hash(), get_file_mtime() |
| `set_cache_with_lock()` | 带锁的缓存写入（原子写入 + flock） | check_and_evict_if_needed() |
| `get_blob_hash()` | 获取文件 blob hash（git 或 md5 降级） | git hash-object, md5sum |
| `check_and_evict_if_needed()` | LRU 淘汰检查（50MB 上限） | - |
| `compute_cache_key()` | 缓存 key 计算 | - |

**缓存层级**：
| 层级 | 存储 | 失效策略 | 访问延迟 |
|------|------|----------|----------|
| L1 | Bash 关联数组（内存） | 会话结束 | < 10ms |
| L2 | JSON 文件（`$CACHE_DIR/l2/`） | mtime + blob hash | < 100ms |

### scripts/dependency-guard.sh Components [NEW: Phase 2]

| Component | 职责 | 依赖 |
|-----------|------|------|
| `detect_cycles()` | 循环依赖检测（DFS + 三色标记） | parse_imports() |
| `parse_imports()` | 解析 import/require/source 语句 | rg |
| `check_arch_rules()` | 架构规则校验 | parse_yaml(), glob_match() |
| `parse_yaml()` | 解析 arch-rules.yaml | jq (via yq) |
| `check_whitelist()` | 白名单匹配 | glob_match() |
| `format_report()` | 生成 JSON/Text 报告 | - |

**检测算法**：
| 算法 | 状态标记 | 检测条件 |
|------|----------|----------|
| DFS 循环检测 | WHITE/GRAY/BLACK | GRAY → GRAY 边 |
| 规则匹配 | - | from ∧ cannot_import |

### scripts/context-layer.sh Components [NEW: Phase 2]

| Component | 职责 | 依赖 |
|-----------|------|------|
| `classify_commit()` | 单个 Commit 语义分类 | match_commit_type() |
| `classify_batch()` | 批量 Commit 分类 | git log |
| `match_commit_type()` | 匹配分类规则（正则） | - |

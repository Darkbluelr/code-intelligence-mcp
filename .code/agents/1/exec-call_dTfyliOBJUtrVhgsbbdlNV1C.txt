---
last_referenced_by: augment-parity-final-gaps
last_verified: 2026-01-16
health: active
---


# Spec Delta: 守护进程增强（daemon-enhancement）

> **Change ID**: `augment-parity-final-gaps`
> **Capability**: daemon-enhancement
> **Base Spec**: `dev-playbooks/specs/daemon/spec.md`
> **Version**: 2.0.0
> **Status**: Draft
> **Created**: 2026-01-16

---

## 概述

本规格增量扩展现有 daemon 规格，新增：
1. **预热机制**：启动时预加载高频查询和热点子图
2. **请求取消机制**：支持请求取消令牌，检测新请求时终止旧请求

---

## Requirements（需求）

### REQ-DME-001：预热机制

系统应支持启动时预热，降低冷启动延迟：

**预热内容**：
| 预热项 | 来源 | 优先级 |
|--------|------|--------|
| 热点文件子图 | `hotspot-analyzer.sh` Top 10 | P0 |
| 常用查询 | 预配置查询列表 | P1 |
| 符号索引 | `cache-manager.sh` | P2 |

**约束**：
- 预热在后台异步执行，不阻塞启动
- 预热超时：30 秒
- 预热失败不影响正常服务

### REQ-DME-002：预热配置

系统应支持预热配置：

```yaml
# config/features.yaml
daemon:
  warmup:
    enabled: true
    timeout_seconds: 30
    queries:
      - "main"
      - "server"
      - "handler"
    hotspot_limit: 10
```

### REQ-DME-003：预热状态查询

系统应提供预热状态查询：

```json
{
  "warmup_status": "completed|in_progress|disabled|failed",
  "warmup_started_at": "2026-01-16T10:00:00Z",
  "warmup_completed_at": "2026-01-16T10:00:05Z",
  "items_cached": 15
}
```

### REQ-DME-004：请求取消机制

系统应支持请求取消，释放资源：

**取消触发条件**：
- 收到同一客户端的新请求
- 收到显式取消信号

**取消机制**：
- 使用 `flock` 文件锁保证原子性
- 取消信号文件：`.devbooks/cancel/<request_id>`
- 取消检测间隔：每个处理步骤前检查

### REQ-DME-005：请求取消协议

**取消信号文件格式**：
- 文件存在且内容为空：请求进行中
- 文件存在且内容非空（`cancelled`）：请求已取消
- 文件不存在：请求已完成或从未开始

**原子性保证**：
```bash
# 使用 flock 保证取消操作原子性
(
    flock -x 200
    echo "cancelled" > "$cancel_file"
) 200>"$LOCK_FILE"
```

### REQ-DME-006：取消响应时间

请求取消应在 100ms 内生效：

| 指标 | 目标值 |
|------|--------|
| 取消检测延迟 | < 100ms |
| 资源释放时间 | < 200ms |

### REQ-DME-007：取消后清理

请求取消后应正确清理资源：

- 终止子进程
- 释放文件锁
- 删除临时文件
- 记录取消日志

---

## Scenarios（场景）

### SC-DME-001：预热成功

**Given**:
- 守护进程启动
- 预热配置启用
- 热点文件存在
**When**: 执行预热
**Then**:
- 加载 Top 10 热点文件子图到缓存
- 执行预配置查询
- `cache-manager.sh stats` 显示已缓存条目 > 0
- `warmup_status` = `completed`

### SC-DME-002：预热超时

---
last_referenced_by: algorithm-optimization-parity
last_verified: 2026-01-17
health: active
---

# 规格：优先级排序算法 (Priority Sorting)

> **Capability ID**: ALG-001
> **模块**: graph-rag.sh
> **类型**: 行为变更（内部算法优化）

## Requirements

### REQ-PS-001: 多因子优先级计算

**描述**: 候选代码片段的优先级应基于多个因子加权计算，而非单一相关性分数。

**输入**:
- `relevance_score`: 语义相关性分数 (0-1)
- `hotspot`: 热点分数 (0-1)
- `distance`: 图距离（跳数，≥1）

**输出**:
- `priority`: 综合优先级分数 (0-1)

**公式**:
```
Priority = relevance × W_r + hotspot × W_h + (1/distance) × W_d
```

其中默认权重: W_r=0.4, W_h=0.3, W_d=0.3

---

### REQ-PS-002: 权重可配置

**描述**: 优先级计算的权重应从配置文件读取，支持运行时调整。

**配置路径**: `config/features.yaml`
**配置键**: `smart_pruning.priority_weights.{relevance,hotspot,distance}`

---

### REQ-PS-003: 边界处理

**描述**: 算法应正确处理以下边界情况：
- `distance = 0` → 视为 1（避免除零）
- 缺失字段 → 使用默认值 0
- 负值输入 → 视为 0

---

## Scenarios

### SC-PS-001: 标准优先级计算

- **Given**: 候选 `{relevance_score: 0.8, hotspot: 0.6, distance: 2}`
- **When**: 调用 `calculate_priority()` 函数
- **Then**: 返回 `0.8×0.4 + 0.6×0.3 + 0.5×0.3 = 0.32 + 0.18 + 0.15 = 0.65`

### SC-PS-002: 距离为零处理

- **Given**: 候选 `{relevance_score: 0.5, hotspot: 0.5, distance: 0}`
- **When**: 调用 `calculate_priority()` 函数
- **Then**: distance 被视为 1，返回 `0.5×0.4 + 0.5×0.3 + 1×0.3 = 0.65`

### SC-PS-003: 缺失字段处理

- **Given**: 候选 `{relevance_score: 0.9}`（缺少 hotspot 和 distance）
- **When**: 调用 `calculate_priority()` 函数
- **Then**: 缺失字段使用默认值，返回 `0.9×0.4 + 0×0.3 + 1×0.3 = 0.66`

### SC-PS-004: 自定义权重

- **Given**: 配置文件设置 `relevance: 0.6, hotspot: 0.2, distance: 0.2`
- **And**: 候选 `{relevance_score: 0.8, hotspot: 0.4, distance: 1}`
- **When**: 调用 `calculate_priority()` 函数
- **Then**: 使用自定义权重，返回 `0.8×0.6 + 0.4×0.2 + 1×0.2 = 0.76`

---

## Contract Test IDs

| Test ID | 类型 | 覆盖场景 |
|---------|------|----------|
| CT-PS-001 | behavior | SC-PS-001 |
| CT-PS-002 | boundary | SC-PS-002 |
| CT-PS-003 | boundary | SC-PS-003 |
| CT-PS-004 | config | SC-PS-004 |
# 功能开关配置
# 用于控制 Code Intelligence MCP 各功能模块的启用状态
# Change ID: augment-parity

features:
  graph_store:
    enabled: true
    wal_mode: true

  scip_parser:
    enabled: true
    fallback_regex: true

  daemon:
    enabled: true
    auto_restart: true
    max_restarts: 3
    # 预热配置（REQ-DME-001/002）
    warmup:
      enabled: true
      timeout_seconds: 30
      queries:
        - "main"
        - "server"
        - "handler"
      hotspot_limit: 10
    # 请求取消配置（REQ-DME-004/005/006）
    cancel:
      enabled: true
      check_interval_ms: 50

  llm_rerank:
    enabled: false  # 默认关闭，需要 API Key 才能启用
    provider: anthropic  # anthropic / openai / ollama / mock
    model: claude-3-haiku
    timeout_ms: 2000

  # M1: LLM Provider 抽象接口 (AC-001, AC-002)
  # 可插拔的 LLM Provider 架构
  llm_provider:
    enabled: true
    # 默认 Provider（auto 表示自动检测）
    default_provider: auto  # anthropic / openai / ollama / mock / auto
    # 请求超时（毫秒）
    timeout_ms: 2000
    # 最大输出 Token 数
    max_tokens: 1024
    # 各 Provider 特定配置
    anthropic:
      env_key: ANTHROPIC_API_KEY
      default_model: claude-3-haiku-20240307
      endpoint: https://api.anthropic.com/v1
    openai:
      env_key: OPENAI_API_KEY
      default_model: gpt-4o-mini
      endpoint: https://api.openai.com/v1
    ollama:
      default_model: llama3
      endpoint: http://localhost:11434
    mock:
      default_model: mock
      # Mock 模式特定配置（通过环境变量控制）
      # LLM_MOCK_RESPONSE - 自定义响应
      # LLM_MOCK_DELAY_MS - 模拟延迟
      # LLM_MOCK_FAIL_COUNT - 模拟失败次数

  orphan_detection:
    enabled: true

  pattern_discovery:
    enabled: true
    min_frequency: 3

  ckb:
    enabled: true

  # ========== achieve-augment-full-parity 新增 ==========

  # 模块 1: AST Delta 增量索引
  ast_delta:
    enabled: true
    cache_dir: .devbooks/ast-cache
    cache_max_size_mb: 50
    cache_ttl_days: 30
    fallback_to_scip: true
    batch_threshold: 10

  impact_analyzer:
    enabled: true
    max_depth: 5
    decay_factor: 0.8
    threshold: 0.1
    cache_intermediate: true

  intent_learner:
    enabled: true
    history_file: .devbooks/intent-history.json
    max_history_entries: 10000
    auto_cleanup_days: 90
    privacy_mode: local_only

  vuln_tracker:
    enabled: true
    scanners:
      - npm_audit
    severity_threshold: moderate
    auto_scan_on_install: false

  cod_visualizer:
    enabled: true
    output_formats:
      - mermaid
      - d3json
    include_hotspots: true
    include_complexity: true

  # MP5: Federation Virtual Edges (AC-F05)
  # 跨仓库虚拟边连接功能
  federation_virtual_edges:
    enabled: true
    # 最低置信度阈值，低于此值不生成虚拟边
    confidence_threshold: 0.5
    # 高置信度阈值，高于此值标记为"高置信"
    high_confidence_threshold: 0.8
    # 是否启用自动同步
    auto_sync: false
    # 同步间隔（小时）
    sync_interval_hours: 24

  # MP4: Smart Pruning (AC-F04)
  # 子图智能裁剪功能
  smart_pruning:
    enabled: true
    # 默认 Token 预算（tokens）
    default_budget: 8000
    # 优先级权重配置
    priority_weights:
      relevance: 0.4
      hotspot: 0.3
      distance: 0.3
    # 最低相关度阈值（0-1）
    min_relevance_threshold: 0.0
    # 保守估算裕量（百分比）
    conservative_margin_percent: 10

  # M3: 跨函数数据流追踪 (AC-004, AC-004a)
  # 支持变量在多函数间的传递追踪
  data_flow_tracing:
    enabled: true
    # 默认最大深度（跳数）
    max_depth: 5
    # 深度配置范围（REQ-DFT-006）
    min_depth: 1
    max_allowed_depth: 10
    # 默认追踪方向
    default_direction: both  # forward | backward | both
    # 性能配置
    performance:
      # 单跳延迟 P95 目标（毫秒）
      single_hop_p95_target_ms: 100
total 56
drwxr-xr-x   8 ozbombor  staff   256 Jan 17 18:14 .
drwxr-xr-x@ 35 ozbombor  staff  1120 Jan 18 09:53 ..
-rw-r--r--   1 ozbombor  staff  1306 Jan 14 01:31 arch-rules.yaml
-rw-r--r--   1 ozbombor  staff  2521 Jan 11 10:16 boundaries.yaml
-rw-r--r--   1 ozbombor  staff  1859 Jan 10 16:40 config.yaml.template
-rw-r--r--   1 ozbombor  staff  5297 Jan 17 18:14 features.yaml
-rw-r--r--   1 ozbombor  staff  1147 Jan 14 01:40 federation.yaml
-rw-r--r--   1 ozbombor  staff  3066 Jan 17 17:16 llm-providers.yaml

# C4 Architecture Map: Code Intelligence MCP Server

> **Version**: 1.5.0
> **Owner**: Architecture Owner
> **Created**: 2026-01-11
> **Last Updated**: 2026-01-22 (20260118-2112-enhance-code-intelligence-capabilities：上下文压缩、架构漂移检测、数据流追踪、图查询加速、混合检索增强、重排序管线、上下文层信号、语义异常检测、评测基准、Schema v4 迁移)
> **Freshness Check**: 90 days

---

## C1: System Context

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              External Users                              │
│                                                                          │
│    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐             │
│    │ Claude Code  │    │ AI Assistants│    │   IDE        │             │
│    │   (CLI)      │    │              │    │  Plugins     │             │
│    └──────────────┘    └──────────────┘    └──────────────┘             │
│              │                  │                  │                     │
│              └──────────────────┼──────────────────┘                     │
│                                 │                                        │
│                                 │ MCP Protocol (stdio)                   │
│                                 ▼                                        │
│    ┌────────────────────────────────────────────────────────────────┐   │
│    │                                                                │   │
│    │               Code Intelligence MCP Server                     │   │
│    │                                                                │   │
│    │   Provides: semantic search, call chain tracing, bug          │   │
│    │             localization, complexity analysis, graph RAG      │   │
│    │                                                                │   │
│    └────────────────────────────────────────────────────────────────┘   │
│                                 │                                        │
│                                 │                                        │
│              ┌──────────────────┼──────────────────┐                     │
│              │                  │                  │                     │
│              ▼                  ▼                  ▼                     │
│    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐             │
│    │   Ollama /   │    │   CKB MCP    │    │   Git        │             │
│    │   OpenAI     │    │   Server     │    │   Repository │             │
│    │ (Embedding)  │    │ (Graph)      │    │              │             │
│    └──────────────┘    └──────────────┘    └──────────────┘             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### System Boundary

| 元素 | 类型 | 描述 |
|------|------|------|
| Code Intelligence MCP Server | System | 本系统：为 AI 编程助手提供代码智能能力 |
| Claude Code | External User | 主要用户：Anthropic 官方 CLI 工具 |
| AI Assistants | External User | 其他 AI 编程助手 |
| IDE Plugins | External User | IDE 集成插件 |
| Ollama / OpenAI | External System | Embedding 生成服务（可选） |
| CKB MCP Server | External System | 图基代码分析服务（可选） |
| Git Repository | External System | 目标代码仓库 |

---

## C2: Container Level

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Code Intelligence MCP Server                        │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                        Integration Layer                            ││
│  │                                                                     ││
│  │  ┌─────────────────┐    ┌─────────────────────────────────────────┐││
│  │  │  src/server.ts  │    │          hooks/*.sh                     │││
│  │  │  (MCP Thin      │    │  (augment-context-global.sh             │││
│  │  │   Shell)        │    │   augment-context-with-embedding.sh     │││
│  │  │                 │    │   pre-commit)  [NEW: Phase 2]           │││
│  │  └─────────────────┘    └─────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────────────┘│
│                               │                                          │
│                               │ execAsync                                │
│                               ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                          Core Layer                                 ││
│  │                                                                     ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐││
│  │  │ embedding   │  │ call-chain  │  │ bug-locator │  │ complexity  │││
│  │  │    .sh      │  │    .sh      │  │    .sh      │  │    .sh      │││
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘││
│  │                                                                     ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐││
│  │  │ graph-rag   │  │  indexer    │  │ hotspot-    │  │ boundary-   │││
│  │  │    .sh      │  │    .sh      │  │ analyzer.sh │  │ detector.sh │││
│  │  └─────────────┘  └─────────────┘  └───────┬─────┘  └─────────────┘││
│  │                                            │                        ││
│  │  ┌─────────────┐  ┌─────────────┐          │ [ENHANCED: Phase 2]   ││
│  │  │ pattern-    │  │  ast-diff   │          │ --with-bug-history    ││
│  │  │ learner.sh  │  │    .sh      │          │                        ││
│  │  └─────────────┘  └─────────────┘          │                        ││
│  │                                            ▼                        ││
│  │  ┌──────────────────────────────────────────────────────────────┐  ││
│  │  │              [NEW: Phase 2 Containers]                       │  ││
│  │  │                                                              │  ││
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │  ││
│  │  │  │ cache-      │  │ dependency- │  │ context-    │          │  ││
│  │  │  │ manager.sh  │  │ guard.sh    │  │ layer.sh    │          │  ││
│  │  │  │             │  │             │  │             │          │  ││
│  │  │  │ L1内存+L2文件│  │ 循环检测    │  │ Commit分类   │          │  ││
│  │  │  │ blob hash  │  │ 规则校验    │  │ Bug历史     │          │  ││
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘          │  ││
│  │  │                                                              │  ││
│  │  │  ┌─────────────┐                                            │  ││
│  │  │  │ federation- │                                            │  ││
│  │  │  │ lite.sh     │                                            │  ││
│  │  │  │             │                                            │  ││
│  │  │  │ 跨仓库契约   │                                            │  ││
│  │  │  └─────────────┘                                            │  ││
│  │  └──────────────────────────────────────────────────────────────┘  ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                               │                                          │
│                               │ source                                   │
│                               ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                         Shared Layer                                ││
│  │                                                                     ││
│  │  ┌─────────────────────────┐    ┌─────────────────────────┐        ││
│  │  │      common.sh          │    │     cache-utils.sh      │        ││
│  │  │  (shared functions,     │    │  (caching utilities)    │        ││
│  │  │   config, logging)      │    │  [被 cache-manager.sh   │        ││
│  │  │  [ENHANCED: Phase 2]    │    │   调用，协作层]          │        ││
│  │  └─────────────────────────┘    └─────────────────────────┘        ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                      Config Layer [NEW: Phase 2]                    ││
│  │                                                                     ││
│  │  ┌─────────────────────────┐    ┌─────────────────────────┐        ││
│  │  │  config/arch-rules.yaml │    │  config/federation.yaml │        ││
│  │  │  (架构规则定义)          │    │  (联邦仓库配置)          │        ││
│  │  └─────────────────────────┘    └─────────────────────────┘        ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Container Inventory

| Container | 路径 | 类型 | 职责 | 技术栈 |
|-----------|------|------|------|--------|
| MCP Server | `src/server.ts` | Application | MCP 协议处理，工具调度 | TypeScript, Node.js |
| Global Hook (Wrapper) | `hooks/augment-context-global.sh` | Hook | 全局上下文注入兼容包装（转发到 context-inject-global.sh） | Bash |
| Context Inject Hook | `hooks/context-inject-global.sh` | Hook | 上下文注入入口薄适配（委托 auto-tool-orchestrator.sh） | Bash |
| Auto Tool Orchestrator | `hooks/auto-tool-orchestrator.sh` | Script | 自动工具计划/执行/融合/降级，输出 schema v1.0 | Bash |
| **Pre-commit Hook** | `hooks/pre-commit` | Hook | 架构规则校验 + 循环依赖检测 | Bash |
| Embedding Search | `scripts/embedding.sh` | Script | 语义代码搜索 | Bash |
| Call Chain | `scripts/call-chain.sh` | Script | 调用链追踪，数据流追踪 | Bash |
| Bug Locator | `scripts/bug-locator.sh` | Script | Bug 位置定位（集成热点算法） | Bash |
| Complexity | `scripts/complexity.sh` | Script | 圈复杂度分析 | Bash |
| Graph-RAG | `scripts/graph-rag.sh` | Script | 子图检索，边界过滤 | Bash |
| Indexer | `scripts/indexer.sh` | Script | Embedding 索引管理 | Bash |
| Hotspot Analyzer | `scripts/hotspot-analyzer.sh` | Script | Frequency × Complexity 热点计算，**Phase 2: Bug 修复历史权重** | Bash |
| Boundary Detector | `scripts/boundary-detector.sh` | Script | 用户/库/生成代码边界识别 | Bash |
| Pattern Learner | `scripts/pattern-learner.sh` | Script | 语义模式学习与异常检测 | Bash |
| AST Diff | `scripts/ast-diff.sh` | Script | SCIP 增量索引 | Bash |
| **Cache Manager** | `scripts/cache-manager.sh` | Script | **多级缓存（L1 内存 + L2 文件）、mtime + blob hash 精确失效、LRU 淘汰** | Bash |
| **Dependency Guard** | `scripts/dependency-guard.sh` | Script | **循环依赖检测（DFS）、架构规则校验、Pre-commit 集成** | Bash |
| **Context Layer** | `scripts/context-layer.sh` | Script | **Commit 语义分类（fix/feat/refactor）、Bug 修复历史提取** | Bash |
| **Federation Lite** | `scripts/federation-lite.sh` | Script | **跨仓库契约发现、符号提取、联邦索引管理** | Bash |
| Common | `scripts/common.sh` | Shared | 共享函数、配置、日志，**Phase 2: 新增缓存共享函数** | Bash |
| Cache Utils | `scripts/cache-utils.sh` | Shared | 缓存管理（L2 基础函数），**被 cache-manager.sh 调用** | Bash |
| **Arch Rules Config** | `config/arch-rules.yaml` | Config | **架构规则定义（禁止导入、循环检测白名单）** | YAML |
| **Federation Config** | `config/federation.yaml` | Config | **联邦仓库配置（显式路径 + 自动发现）** | YAML |
| ***Graph Store*** | `scripts/graph-store.sh` | Script | ***SQLite 图存储，9 种边类型 CRUD，Schema v3 迁移，孤儿节点查询*** | Bash |
| ***SCIP Parser*** | `scripts/scip-to-graph.sh` | Script | ***SCIP 索引解析，symbol_roles 映射，IMPLEMENTS/EXTENDS/RETURNS_TYPE 边类型提取，正则降级*** | Bash |
| ***Daemon*** | `scripts/daemon.sh` | Script | ***常驻守护进程，Unix Socket 通信，自动预热，P95 < 500ms*** | Bash |
| ***Features Config*** | `config/features.yaml` | Config | ***功能开关配置（LLM 重排序、孤儿检测、模式发现）*** | YAML |
| ****AST Delta TS**** | `src/ast-delta.ts` | Module | ****TypeScript tree-sitter 解析薄壳，AST 差异计算**** | TypeScript |
| ****AST Delta**** | `scripts/ast-delta.sh` | Script | ****增量 AST 解析协调，缓存管理，图更新触发**** | Bash |
| ****Impact Analyzer**** | `scripts/impact-analyzer.sh` | Script | ****传递性影响分析，BFS 图遍历，置信度衰减**** | Bash |
| ****COD Visualizer**** | `scripts/cod-visualizer.sh` | Script | ****架构可视化，Mermaid + D3.js JSON 输出**** | Bash |
| ****Intent Learner**** | `scripts/intent-learner.sh` | Script | ****查询历史记录，偏好分数计算，90 天自动清理**** | Bash |
| ****Vuln Tracker**** | `scripts/vuln-tracker.sh` | Script | ****npm audit 集成，漏洞扫描，依赖传播追踪**** | Bash |
| *****ADR Parser***** | `scripts/adr-parser.sh` | Script | *****ADR 解析与关联，MADR/Nygard 格式支持，生成 ADR_RELATED 边***** | Bash |
| *****GitHub Action***** | `.github/workflows/arch-check.yml` | CI/CD | *****PR 自动架构检查，循环依赖/孤儿模块/架构规则检测***** | YAML |
| *****GitLab CI Template***** | `.gitlab-ci.yml.template` | CI/CD | *****GitLab MR 架构检查模板***** | YAML |
| ******CKB Client Manager****** | `src/server.ts::CKBClientManager` | Component | ******CKB MCP 调用管理，健康检查，降级状态管理，60s 冷却期****** | TypeScript |
| ******Fusion Search****** | `scripts/embedding.sh::fusion_search()` | Function | ******图+向量融合查询，1-hop 图扩展，Token 预算分配****** | Bash |

**注**：粗体为 `augment-upgrade-phase2` 变更新增或增强的 Container。斜体粗体为 `augment-parity` 变更新增的 Container。四星粗体为 `achieve-augment-full-parity` 变更新增的 Container。五星粗体为 `augment-parity-final-gaps` 变更新增的 Container。六星粗体为 `upgrade-code-intelligence-capabilities` 变更新增的 Container。

**augment-parity-final-gaps 增强的 Container**：
| Container | 增强内容 |
|-----------|----------|
| `scripts/scip-to-graph.sh` | 边类型扩展：IMPLEMENTS/EXTENDS/RETURNS_TYPE/ADR_RELATED |
| `scripts/graph-store.sh` | 新增 `find-path`（A-B 最短路径）、`migrate`（Schema 迁移） |
| `scripts/intent-learner.sh` | 对话上下文持久化、会话管理、连续性加权 |
| `scripts/daemon.sh` | 预热机制（warmup）、请求取消协议 |
| `scripts/cache-manager.sh` | 子图 LRU 缓存（SQLite 持久化，跨进程共享） |
| `scripts/bug-locator.sh` | 影响分析融合（--with-impact, --impact-depth） |
| `hooks/augment-context-global.sh` | 5 层结构化上下文输出、DevBooks 适配注入 |
| `scripts/common.sh` | 新增 detect_devbooks()、load_devbooks_context() |

**upgrade-code-intelligence-capabilities 增强的 Container**：
| Container | 增强内容 |
|-----------|----------|
| `scripts/scip-to-graph.sh` | SCIP 解析器扩展：IMPLEMENTS/EXTENDS/RETURNS_TYPE 边类型提取，正则降级解析 |
| `scripts/graph-store.sh` | Schema v3 迁移：新增 3 种边类型索引，自动备份与回滚，并发迁移保护 |
| `src/server.ts` | CKB Client Manager：MCP Client SDK 集成，健康检查（5s 超时），降级状态管理（60s 冷却期） |
| `scripts/embedding.sh` | fusion_search() 函数：图+向量融合查询，1-hop 图扩展，Token 预算分配（60% embedding + 40% graph） |
| `scripts/graph-rag.sh` | 融合查询集成：--fusion-depth 参数，CKB 降级时本地 1-hop 遍历 |
| `scripts/daemon.sh` | 自动预热：start 后异步触发，30s 超时，不阻塞启动（< 2s） |

---

## C3: Component Level (Key Containers)

### src/server.ts Components

| Component | 职责 | 依赖 |
|-----------|------|------|
| `TOOLS` | MCP 工具定义数组 | - |
| `handleListTools()` | 列出可用工具 | TOOLS |
| `handleToolCall()` | 工具调用分发 | runScript() |
| `runScript()` | 执行 Shell 脚本 | execAsync |

**MCP Tools (15 个)**：
| 工具名 | 对应脚本 | 状态 |
|--------|----------|------|
| `ci_search` | embedding.sh | 已有 |
| `ci_call_chain` | call-chain.sh | 已有 |
| `ci_bug_locate` | bug-locator.sh | 已有 |
| `ci_complexity` | complexity.sh | 已有 |
| `ci_graph_rag` | graph-rag.sh | 已有，**Full Parity 增强：--budget** |
| `ci_index_status` | indexer.sh | 已有 |
| `ci_hotspot` | hotspot-analyzer.sh | 已有 |
| `ci_boundary` | boundary-detector.sh | 已有 |
| **`ci_arch_check`** | dependency-guard.sh | **Phase 2 新增** |
| **`ci_federation`** | federation-lite.sh | **Phase 2 新增，Full Parity 增强：--virtual-edges** |
| ****`ci_ast_delta`**** | ast-delta.sh | ****Full Parity 新增**** |
| ****`ci_impact`**** | impact-analyzer.sh | ****Full Parity 新增**** |
| ****`ci_cod`**** | cod-visualizer.sh | ****Full Parity 新增**** |
| ****`ci_intent`**** | intent-learner.sh | ****Full Parity 新增**** |
| ****`ci_vuln`**** | vuln-tracker.sh | ****Full Parity 新增**** |

### scripts/cache-manager.sh Components [NEW: Phase 2]

| Component | 职责 | 依赖 |
|-----------|------|------|
| `get_cached_with_validation()` | 带验证的缓存读取（L1 → L2 → Miss） | get_blob_hash(), get_file_mtime() |
| `set_cache_with_lock()` | 带锁的缓存写入（原子写入 + flock） | check_and_evict_if_needed() |
| `get_blob_hash()` | 获取文件 blob hash（git 或 md5 降级） | git hash-object, md5sum |
| `check_and_evict_if_needed()` | LRU 淘汰检查（50MB 上限） | - |
| `compute_cache_key()` | 缓存 key 计算 | - |

**缓存层级**：
| 层级 | 存储 | 失效策略 | 访问延迟 |
|------|------|----------|----------|
| L1 | Bash 关联数组（内存） | 会话结束 | < 10ms |
| L2 | JSON 文件（`$CACHE_DIR/l2/`） | mtime + blob hash | < 100ms |

### scripts/dependency-guard.sh Components [NEW: Phase 2]

| Component | 职责 | 依赖 |
|-----------|------|------|
| `detect_cycles()` | 循环依赖检测（DFS + 三色标记） | parse_imports() |
| `parse_imports()` | 解析 import/require/source 语句 | rg |
| `check_arch_rules()` | 架构规则校验 | parse_yaml(), glob_match() |
| `parse_yaml()` | 解析 arch-rules.yaml | jq (via yq) |
| `check_whitelist()` | 白名单匹配 | glob_match() |
| `format_report()` | 生成 JSON/Text 报告 | - |

**检测算法**：
| 算法 | 状态标记 | 检测条件 |
|------|----------|----------|
| DFS 循环检测 | WHITE/GRAY/BLACK | GRAY → GRAY 边 |
| 规则匹配 | - | from ∧ cannot_import |

### scripts/context-layer.sh Components [NEW: Phase 2]

| Component | 职责 | 依赖 |
|-----------|------|------|
| `classify_commit()` | 单个 Commit 语义分类 | match_commit_type() |
| `classify_batch()` | 批量 Commit 分类 | git log |
| `match_commit_type()` | 匹配分类规则（正则） | - |
| `extract_bug_history()` | 提取文件 Bug 修复历史 | classify_commit() |
| `generate_context_index()` | 生成上下文索引 | - |

**Commit 分类规则优先级**：
| 优先级 | 类型 | 匹配模式 |
|--------|------|----------|
| 1 | fix | `^fix[:\(]` / `bug` / `issue` / `error` |
| 2 | feat | `^feat[:\(]` / `add` / `new` / `implement` |
| 3 | refactor | `^refactor[:\(]` / `clean` / `improve` |
| 4 | docs | `^docs[:\(]` / `document` / `readme` |
| 5 | chore | `^chore[:\(]` / `build` / `ci` / `dep` |

### scripts/federation-lite.sh Components [NEW: Phase 2]

| Component | 职责 | 依赖 |
|-----------|------|------|
| `discover_repos()` | 发现联邦仓库（显式 + 自动） | parse_federation_config() |
| `scan_contracts()` | 扫描契约文件 | find, glob |
| `extract_symbols()` | 提取导出符号 | extract_proto_symbols(), extract_openapi_symbols() |
| `extract_proto_symbols()` | 提取 .proto 符号 | rg |
| `extract_openapi_symbols()` | 提取 OpenAPI 符号 | jq |
| `search_symbol()` | 搜索符号定义 | - |
| `update_index()` | 更新联邦索引（增量） | get_content_hash() |

**契约类型支持**：
| 类型 | 文件模式 | 提取内容 |
|------|----------|----------|
| Protocol Buffers | `**/*.proto` | service, message, enum |
| OpenAPI | `**/openapi.yaml`, `**/swagger.json` | paths, schemas |
| GraphQL | `**/*.graphql` | type, query, mutation |
| TypeScript | `**/*.d.ts`, `**/types/**/*.ts` | export interface/type/class |

### scripts/bug-locator.sh Components

| Component | 职责 | 依赖 |
|-----------|------|------|
| `main()` | 入口，参数解析 | get_hotspot_files(), embedding_search() |
| `get_hotspot_files()` | 获取热点文件列表 | hotspot-analyzer.sh |
| `add_hotspot_scores()` | 为候选添加热点分数 | hotspot-analyzer.sh |
| `embedding_search()` | Embedding 搜索 | embedding.sh |
| `call_chain_search()` | 调用链搜索 | call-chain.sh |
| **`cached_search()`** | **缓存加速搜索** [Phase 2] | **cache-manager.sh** |

### scripts/hotspot-analyzer.sh Components [ENHANCED: Phase 2]

| Component | 职责 | 依赖 |
|-----------|------|------|
| `main()` | 入口，参数解析（支持 --with-bug-history） | calculate_score() |
| `calculate_score()` | 热点分数计算（含 Bug 权重） | get_change_freq(), get_complexity() |
| **`get_bug_fix_ratio()`** | **获取 Bug 修复比例** [Phase 2] | **context-layer.sh** |
| **`apply_bug_weight()`** | **应用 Bug 修复权重** [Phase 2] | - |

**增强后热点公式**：
```
score = change_freq × complexity × (1 + bug_weight × bug_fix_ratio)
```

### scripts/graph-rag.sh Components

| Component | 职责 | 依赖 |
|-----------|------|------|
| `search()` | 主搜索函数 | embedding_search(), subgraph_traverse() |
| `embedding_search()` | Embedding 搜索 | embedding.sh |
| `subgraph_traverse()` | 子图遍历（保留边关系） | CKB MCP |
| `filter_by_boundary()` | 边界过滤 | boundary-detector.sh |
| **`cached_subgraph()`** | **缓存加速子图检索** [Phase 2] | **cache-manager.sh** |

### hooks/augment-context-global.sh Components

| Component | 职责 | 依赖 |
|-----------|------|------|
| `generate_context()` | 主函数：生成上下文 | analyze_intent_4d() |
| **`analyze_intent_4d()`** | 4 维意图信号分析 | - |
| `extract_explicit_signals()` | 提取显式信号 | - |
| `extract_implicit_signals()` | 提取隐式信号 | - |
| `extract_historical_signals()` | 提取历史信号 | - |
| `extract_code_signals()` | 提取代码信号 | - |

---

## Architecture Guardrails

### Layering Constraints

本项目采用 3 层架构，依赖方向为：**shared ← core ← integration**

| 层级 | 目录 | 职责 | 可依赖 | 禁止依赖 |
|------|------|------|--------|----------|
| shared | `scripts/common.sh`, `scripts/cache-utils.sh` | 共享工具函数 | （无） | core, integration |
| core | `scripts/*.sh`（功能脚本） | 核心功能实现 | shared | integration |
| integration | `src/server.ts`, `hooks/*.sh` | 集成层（MCP/钩子） | shared, core | （无） |

### Environment Constraints

| 脚本类型 | 可调用 | 禁止调用 |
|----------|--------|----------|
| scripts/*.sh | common.sh, 外部 CLI 工具 | src/*.ts, node 模块 |
| hooks/*.sh | scripts/*.sh, common.sh | src/*.ts |
| src/*.ts | scripts/*.sh (via execAsync) | hooks/*.sh 直接 import |

### Validation Commands

```bash
# 检查脚本是否违规引用 TypeScript
rg "import.*from|require\(" scripts/*.sh && echo "FAIL" || echo "OK"

# 检查 common.sh 是否被 core 脚本正确引用
grep -l "source.*common.sh" scripts/*.sh | wc -l  # 应 > 0

# 检查循环依赖：bug-locator.sh 不应被 hotspot-analyzer.sh 引用
grep "hotspot-analyzer.sh" scripts/bug-locator.sh && \
grep "bug-locator.sh" scripts/hotspot-analyzer.sh && \
echo "FAIL: 循环依赖" || echo "OK"

# 检查分层违规
npm run lint  # ShellCheck
```

### Fitness Tests

| 测试 ID | 约束 | 验证方式 |
|---------|------|----------|
| FT-LAYER-001 | scripts 不引用 src/*.ts | grep/rg 检查 |
| FT-LAYER-002 | common.sh 不引用功能脚本 | grep 检查 |
| FT-CYCLE-001 | 无循环依赖 | 依赖图分析 |
| FT-CONFIG-001 | 新配置有默认模板 | 文件存在性检查 |

---

## Dependency Direction

```
src/server.ts (MCP 薄壳)
    │
    ├──→ scripts/cache-manager.sh [Phase 2 新增，性能优化核心]
    │       └──→ scripts/cache-utils.sh (协作层，基础缓存函数)
    │
    ├──→ scripts/dependency-guard.sh [Phase 2 新增] (ci_arch_check)
    │       └──→ config/arch-rules.yaml
    │
    ├──→ scripts/federation-lite.sh [Phase 2 新增] (ci_federation)
    │       ├──→ config/federation.yaml
    │       └──→ [Full Parity 增强] 虚拟边生成
    │
    ├──→ scripts/hotspot-analyzer.sh ──→ context-layer.sh [Phase 2 增强]
    │                                      └──→ (Bug 修复历史)
    │
    ├──→ scripts/boundary-detector.sh
    ├──→ scripts/pattern-learner.sh
    ├──→ scripts/ast-diff.sh
    │
    ├──→ scripts/bug-locator.sh ──→ hotspot-analyzer.sh
    │                           └──→ cache-manager.sh [Phase 2 新增依赖]
    │
    ├──→ scripts/graph-rag.sh ──→ boundary-detector.sh
    │                         ├──→ cache-manager.sh [Phase 2 新增依赖]
    │                         └──→ intent-learner.sh [Full Parity 新增依赖，偏好加权]
    │
    ├──→ scripts/call-chain.sh (增强：--trace-data-flow)
    │
    ├──→ [Full Parity 新增] scripts/ast-delta.sh ──→ graph-store.sh
    │                                              └──→ src/ast-delta.ts (tree-sitter)
    │
    ├──→ [Full Parity 新增] scripts/impact-analyzer.sh ──→ graph-store.sh
    │
    ├──→ [Full Parity 新增] scripts/cod-visualizer.sh ──→ graph-store.sh
    │                                                  └──→ hotspot-analyzer.sh
    │
    ├──→ [Full Parity 新增] scripts/intent-learner.sh ──→ common.sh
    │
    ├──→ [Full Parity 新增] scripts/vuln-tracker.sh ──→ graph-store.sh
    │
    └──→ hooks/augment-context-global.sh ──→ pattern-learner.sh
              │
              └──→ scripts/common.sh (共享函数)

hooks/pre-commit [Phase 2 新增]
    └──→ scripts/dependency-guard.sh

依赖合规性：
✅ server.ts → scripts/*.sh → common.sh（符合分层）
✅ hooks/*.sh → scripts/*.sh（钩子调用工具脚本）
✅ cache-manager.sh → cache-utils.sh（协作层，不替代）
✅ hotspot-analyzer.sh → context-layer.sh（功能脚本 → 工具脚本）
✅ bug-locator.sh → cache-manager.sh（缓存加速）
✅ graph-rag.sh → cache-manager.sh（缓存加速）
✅ graph-rag.sh → intent-learner.sh（偏好加权，Full Parity 新增）
✅ ast-delta.sh → graph-store.sh（增量更新，Full Parity 新增）
✅ impact-analyzer.sh → graph-store.sh（图遍历，Full Parity 新增）
✅ cod-visualizer.sh → graph-store.sh + hotspot-analyzer.sh（数据源，Full Parity 新增）
✅ vuln-tracker.sh → graph-store.sh（依赖追踪，Full Parity 新增）
✅ adr-parser.sh → graph-store.sh（ADR_RELATED 边写入，Final Gaps 新增）
✅ bug-locator.sh → impact-analyzer.sh（影响分析融合，Final Gaps 新增）
✅ daemon.sh → cache-manager.sh（预热调用，Final Gaps 新增）
✅ daemon.sh → hotspot-analyzer.sh（预热数据源，Final Gaps 新增）
✅ intent-learner.sh → augment-context-global.sh（对话上下文注入，Final Gaps 新增）
✅ augment-context-global.sh → common.sh::detect_devbooks()（DevBooks 检测，Final Gaps 新增）
❌ scripts/*.sh → src/*.ts（禁止反向依赖，ast-delta.sh 例外：调用 ast-delta.ts）
❌ 循环依赖（无）
```

---

## External Dependencies

| 依赖 | 类型 | 必需 | 用途 |
|------|------|------|------|
| @modelcontextprotocol/sdk | npm | 是 | MCP 协议实现 |
| Node.js (>= 18) | 运行时 | 是 | 服务器运行环境 |
| Bash | 运行时 | 是 | 脚本执行 |
| ripgrep (rg) | CLI | 推荐 | 文本搜索 |
| jq | CLI | 推荐 | JSON 处理 |
| git | CLI | 是 | 热点分析、增量索引 |
| Ollama / OpenAI | 服务 | 可选 | Embedding 生成 |
| CKB MCP Server | MCP | 可选 | 图基代码分析 |
| ****tree-sitter**** | npm | 可选 | ****AST 解析（Full Parity 新增，降级到 SCIP）**** |
| ****tree-sitter-typescript**** | npm | 可选 | ****TypeScript 语法支持（Full Parity 新增）**** |

---

## Change Log

| 日期 | 变更 ID | 变更内容 |
|------|---------|----------|
| 2026-01-11 | enhance-code-intelligence | 初始创建；新增 hotspot-analyzer, boundary-detector, pattern-learner, ast-diff；增强 bug-locator, graph-rag, call-chain, augment-context-global |
| 2026-01-13 | **augment-upgrade-phase2** | **Phase 2 升级**：新增 cache-manager（多级缓存 L1+L2，mtime+blob hash 失效，LRU 淘汰）、dependency-guard（循环依赖检测，架构规则校验）、context-layer（Commit 语义分类，Bug 修复历史）、federation-lite（跨仓库契约索引）；新增 pre-commit 钩子；新增 config/arch-rules.yaml、config/federation.yaml 配置；增强 hotspot-analyzer（--with-bug-history）、common.sh（缓存共享函数）；新增 MCP 工具 ci_arch_check、ci_federation |
| 2026-01-15 | **augment-parity** | **Augment 能力对等**：新增 graph-store.sh（SQLite 图存储，4 种边类型 CRUD）、scip-to-graph.sh（SCIP 索引解析转换）、daemon.sh（常驻守护进程，Unix Socket 通信）；增强 graph-rag.sh（LLM 重排序）、dependency-guard.sh（孤儿模块检测）、pattern-learner.sh（自动模式发现）、common.sh（llm_call() 适配函数）；新增 MCP 工具 ci_graph_store；新增 config/features.yaml 功能开关配置 |
| 2026-01-16 | ****achieve-augment-full-parity**** | ****全面达到 Augment 代码智能水平****：新增 ast-delta.sh + src/ast-delta.ts（tree-sitter 增量 AST 解析）、impact-analyzer.sh（传递性影响分析，BFS + 置信度衰减）、cod-visualizer.sh（Mermaid + D3.js 架构可视化）、intent-learner.sh（查询历史 + 偏好学习）、vuln-tracker.sh（npm audit 漏洞追踪）；增强 graph-rag.sh（--budget 智能裁剪）、federation-lite.sh（虚拟边生成）；新增 MCP 工具 ci_ast_delta、ci_impact、ci_cod、ci_intent、ci_vuln；新增 tree-sitter 依赖 |
| 2026-01-17 | *****augment-parity-final-gaps***** | *****补齐 Augment 对等最后差距（100% 轻资产能力对等）*****：新增 adr-parser.sh（ADR 解析与关联）、.github/workflows/arch-check.yml（GitHub Action CI/CD）、.gitlab-ci.yml.template（GitLab CI 模板）；增强 scip-to-graph.sh（边类型扩展：IMPLEMENTS/EXTENDS/RETURNS_TYPE/ADR_RELATED）、graph-store.sh（find-path 路径查询 + migrate 迁移命令）、intent-learner.sh（对话上下文持久化 + 会话管理 + 连续性加权）、daemon.sh（预热机制 + 请求取消协议）、cache-manager.sh（子图 LRU 缓存，SQLite 持久化，跨进程共享）、bug-locator.sh（影响分析融合 --with-impact）、augment-context-global.sh（5 层结构化输出 + DevBooks 适配）、common.sh（detect_devbooks() + load_devbooks_context()） |
| 2026-01-18 | ******upgrade-code-intelligence-capabilities****** | ******代码智能能力轻资产升级（70% → 85-90%）******：新增 CKBClientManager（src/server.ts 内，MCP Client SDK 集成，健康检查，降级状态管理）、fusion_search()（scripts/embedding.sh，图+向量融合查询）；增强 scip-to-graph.sh（IMPLEMENTS/EXTENDS/RETURNS_TYPE 边类型解析，正则降级）、graph-store.sh（Schema v3 迁移，自动备份与回滚，并发保护）、graph-rag.sh（--fusion-depth 参数，融合查询集成）、daemon.sh（自动预热，异步执行，30s 超时）；新增 4 个 CLI 规格（mcp-output-format, graph-store-cli, graph-rag-cli, daemon-cli） |
| 2026-01-18 | *******optimize-indexing-pipeline-20260117******* | *******索引管线优化*******：新增 `vendored/scip.proto`（离线 proto 支持）、`scripts/vendor-proto.sh`（proto vendoring 辅助）；增强 `scripts/indexer.sh`（新增 `dispatch_index()` 调度组件，增量优先 + 可靠回退策略，防抖窗口聚合，`--dry-run`/`--once` CLI 入口）；增强 `scripts/scip-to-graph.sh`（离线优先 proto 发现策略，`ensure_scip_proto()` 函数，`proto_source` 输出字段）；修改 `src/server.ts`（`ci_index_status` 调用路由从 `indexer.sh` 改为 `embedding.sh`，语义对齐 Embedding 索引管理）；新增依赖：`indexer.sh` -> `ast-delta.sh`、`indexer.sh` -> `scip-to-graph.sh`、`scip-to-graph.sh` -> `vendored/scip.proto`、`ci_index_status` -> `embedding.sh`；删除依赖：`ci_index_status` -> `indexer.sh` |
| 2026-01-22 | ********20260118-2112-enhance-code-intelligence-capabilities******** | ********代码智能能力增强（9 大核心能力）********：新增 `scripts/context-compressor.sh`（上下文压缩，30-50% 压缩率）、`scripts/drift-detector.sh`（架构漂移检测，C4 合规校验）、`scripts/semantic-anomaly.sh`（语义异常检测，6 种异常类型）、`scripts/benchmark.sh`（评测基准，latency/accuracy/token metrics）、`src/context-signal-manager.ts`（上下文信号管理器，4 维信号采集）；增强 `scripts/call-chain.sh`（--data-flow 跨函数数据流追踪）、`scripts/graph-store.sh`（Schema v4 迁移：transitive_closure/path_index/user_signals 表）、`scripts/embedding.sh`（fusion_search() 混合检索，RRF 融合）、`scripts/reranker.sh`（默认重排序管线，LLM Provider 抽象）；新增 MCP 工具 ci_context_compress、ci_drift_detect、ci_semantic_anomaly、ci_benchmark；Schema v3 → v4 迁移 |

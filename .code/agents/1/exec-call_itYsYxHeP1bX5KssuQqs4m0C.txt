dev-playbooks/specs/pattern-learning/spec.md:119:      "examples": ["embedding.sh", "bug-locator.sh"]
dev-playbooks/specs/hotspot-analysis/spec.md:87:| scripts/embedding.sh | 5 | 6 | 30 |
dev-playbooks/specs/graph-rag-cli/spec.md:77:      "source": "embedding|graph|virtual",
dev-playbooks/specs/graph-rag-cli/spec.md:84:    "embedding_candidates": 10,
dev-playbooks/specs/graph-rag-cli/spec.md:99:| `candidates[].source` | string | ç»“æœæ¥æºï¼šembedding/graph/virtual |
dev-playbooks/specs/graph-rag-cli/spec.md:101:| `metadata.embedding_candidates` | integer | æ¥è‡ªå‘é‡æœç´¢çš„å€™é€‰æ•° |
dev-playbooks/specs/graph-rag-cli/spec.md:141:    {"file": "src/auth/handler.ts", "relevance": 0.92, "source": "embedding", "distance": 0},
dev-playbooks/specs/graph-rag-cli/spec.md:147:    "embedding_candidates": 5,
dev-playbooks/specs/graph-rag-cli/spec.md:222:    "embedding_candidates": 10,
dev-playbooks/specs/graph-rag-cli/spec.md:244:    {"file": "src/client.ts", "relevance": 0.88, "source": "embedding", "distance": 0},
dev-playbooks/specs/graph-rag-cli/spec.md:249:    "embedding_candidates": 5,
dev-playbooks/specs/graph-rag-cli/spec.md:332:          "source": { "type": "string", "enum": ["embedding", "graph", "virtual"] },
dev-playbooks/specs/graph-rag-cli/spec.md:343:        "embedding_candidates": { "type": "integer", "minimum": 0 },
dev-playbooks/specs/_meta/project-profile.md:38:â”‚   â”œâ”€â”€ embedding.sh       # Embedding æœç´¢
dev-playbooks/specs/_meta/key-concepts.md:32:**ç›¸å…³ç»„ä»¶**ï¼š`scripts/embedding.sh`ï¼Œ`scripts/indexer.sh`
dev-playbooks/specs/_meta/verification-baseline.md:98:check "embedding.sh å¯æ‰§è¡Œ" "test -x scripts/embedding.sh"
dev-playbooks/specs/_meta/verification-baseline.md:115:| AC-003 | è„šæœ¬å¯æ‰§è¡Œ | `bash scripts/embedding.sh --help` | é˜»æ–­ |
dev-playbooks/specs/_meta/verification-baseline.md:133:   ci_search â†’ embedding.sh â†’ [Ollama/OpenAI] â†’ ç»“æœ
dev-playbooks/specs/architecture/module-graph.md:35:â”‚  â”‚ embedding   â”‚  â”‚ call-chain  â”‚  â”‚ bug-locator â”‚              â”‚
dev-playbooks/specs/architecture/module-graph.md:75:| Embedding | `scripts/embedding.sh` | è¯­ä¹‰ä»£ç æœç´¢ | common.sh, Ollama/OpenAI |
dev-playbooks/specs/architecture/module-graph.md:77:| Bug Locator | `scripts/bug-locator.sh` | Bug ä½ç½®å®šä½ | common.sh, embedding.sh |
dev-playbooks/specs/architecture/module-graph.md:95:| Embedding Context | `hooks/augment-context-with-embedding.sh` | Embedding å¢å¼ºä¸Šä¸‹æ–‡ |
dev-playbooks/specs/architecture/module-graph.md:115:embedding.sh        â”‚   âœ“    â”‚   âœ“    â”‚   -    â”‚   -    â”‚   -    â”‚   -    â”‚
dev-playbooks/specs/architecture/c4.md:74:â”‚  â”‚  â”‚   Shell)        â”‚    â”‚   augment-context-with-embedding.sh     â”‚â”‚â”‚
dev-playbooks/specs/architecture/c4.md:85:â”‚  â”‚  â”‚ embedding   â”‚  â”‚ call-chain  â”‚  â”‚ bug-locator â”‚  â”‚ complexity  â”‚â”‚â”‚
dev-playbooks/specs/architecture/c4.md:151:| Embedding Search | `scripts/embedding.sh` | Script | è¯­ä¹‰ä»£ç æœç´¢ | Bash |
dev-playbooks/specs/architecture/c4.md:183:| ******Fusion Search****** | `scripts/embedding.sh::fusion_search()` | Function | ******å›¾+å‘é‡èåˆæŸ¥è¯¢ï¼Œ1-hop å›¾æ‰©å±•ï¼ŒToken é¢„ç®—åˆ†é…****** | Bash |
dev-playbooks/specs/architecture/c4.md:205:| `scripts/embedding.sh` | fusion_search() å‡½æ•°ï¼šå›¾+å‘é‡èåˆæŸ¥è¯¢ï¼Œ1-hop å›¾æ‰©å±•ï¼ŒToken é¢„ç®—åˆ†é…ï¼ˆ60% embedding + 40% graphï¼‰ |
dev-playbooks/specs/architecture/c4.md:225:| `ci_search` | embedding.sh | å·²æœ‰ |
dev-playbooks/specs/architecture/c4.md:317:| `main()` | å…¥å£ï¼Œå‚æ•°è§£æ | get_hotspot_files(), embedding_search() |
dev-playbooks/specs/architecture/c4.md:320:| `embedding_search()` | Embedding æœç´¢ | embedding.sh |
dev-playbooks/specs/architecture/c4.md:342:| `search()` | ä¸»æœç´¢å‡½æ•° | embedding_search(), subgraph_traverse() |
dev-playbooks/specs/architecture/c4.md:343:| `embedding_search()` | Embedding æœç´¢ | embedding.sh |
dev-playbooks/specs/architecture/c4.md:510:| 2026-01-18 | ******upgrade-code-intelligence-capabilities****** | ******ä»£ç æ™ºèƒ½èƒ½åŠ›è½»èµ„äº§å‡çº§ï¼ˆ70% â†’ 85-90%ï¼‰******ï¼šæ–°å¢ CKBClientManagerï¼ˆsrc/server.ts å†…ï¼ŒMCP Client SDK é›†æˆï¼Œå¥åº·æ£€æŸ¥ï¼Œé™çº§çŠ¶æ€ç®¡ç†ï¼‰ã€fusion_search()ï¼ˆscripts/embedding.shï¼Œå›¾+å‘é‡èåˆæŸ¥è¯¢ï¼‰ï¼›å¢å¼º scip-to-graph.shï¼ˆIMPLEMENTS/EXTENDS/RETURNS_TYPE è¾¹ç±»å‹è§£æï¼Œæ­£åˆ™é™çº§ï¼‰ã€graph-store.shï¼ˆSchema v3 è¿ç§»ï¼Œè‡ªåŠ¨å¤‡ä»½ä¸å›æ»šï¼Œå¹¶å‘ä¿æŠ¤ï¼‰ã€graph-rag.shï¼ˆ--fusion-depth å‚æ•°ï¼ŒèåˆæŸ¥è¯¢é›†æˆï¼‰ã€daemon.shï¼ˆè‡ªåŠ¨é¢„çƒ­ï¼Œå¼‚æ­¥æ‰§è¡Œï¼Œ30s è¶…æ—¶ï¼‰ï¼›æ–°å¢ 4 ä¸ª CLI è§„æ ¼ï¼ˆmcp-output-format, graph-store-cli, graph-rag-cli, daemon-cliï¼‰ |
dev-playbooks/specs/architecture/hotspots.md:30:| 1 | `scripts/embedding.sh` | 1332 | ğŸ”´ é«˜ | è€ƒè™‘æ‹†åˆ†ä¸ºå­æ¨¡å— |
dev-playbooks/specs/architecture/hotspots.md:62:embedding.sh (1332 è¡Œ)
dev-playbooks/specs/architecture/hotspots.md:76:| Ollama | embedding.sh | OpenAI â†’ å…³é”®è¯æœç´¢ |
dev-playbooks/specs/architecture/hotspots.md:78:| OpenAI API | embedding.sh, reranker.sh | Ollama â†’ å…³é”®è¯æœç´¢ |
dev-playbooks/specs/architecture/hotspots.md:86:1. **ä¸º embedding.sh æ·»åŠ æµ‹è¯•è¦†ç›–**
dev-playbooks/specs/architecture/hotspots.md:96:1. **æ‹†åˆ† embedding.sh**
dev-playbooks/specs/architecture/hotspots.md:98:     - `embedding-index.sh`ï¼šç´¢å¼•æ„å»º
dev-playbooks/specs/architecture/hotspots.md:99:     - `embedding-search.sh`ï¼šæœç´¢æŸ¥è¯¢
dev-playbooks/specs/architecture/hotspots.md:100:     - `embedding-provider.sh`ï¼šProvider æŠ½è±¡
dev-playbooks/specs/architecture/hotspots.md:104:   - è¦†ç›–ï¼šembedding, graph-rag, call-chain
dev-playbooks/specs/architecture/hotspots.md:119:  â”‚                        â— embedding.sh (1332)
./scripts/embedding.sh:12:# å‚è€ƒï¼šSPEC-EMB-001

ä¸‰çº§é™çº§è¯´æ˜:
  1. Ollamaï¼ˆæœ¬åœ°ï¼‰â†’ ä¼˜å…ˆä½¿ç”¨ï¼Œæ— ç½‘ç»œå»¶è¿Ÿï¼Œéšç§å®‰å…¨
  2. OpenAI API   â†’ Ollama ä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§
  3. å…³é”®è¯æœç´¢   â†’ API ä¸å¯ç”¨æ—¶çš„å…œåº•æ–¹æ¡ˆ

EOF
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
  log_info "å‘é‡ç´¢å¼•çŠ¶æ€"
  echo ""

  if [ ! -f "$VECTOR_DB_DIR/metadata.json" ]; then
    echo "  çŠ¶æ€: æœªåˆå§‹åŒ–"
    echo ""
    echo "  è¿è¡Œ '$0 build' æ¥æ„å»ºç´¢å¼•"
    return 0
  fi

  local metadata=$(cat "$VECTOR_DB_DIR/metadata.json")

  echo "  æ¨¡å‹: $(echo "$metadata" | jq -r '.model')"
  echo "  å‘é‡ç»´åº¦: $(echo "$metadata" | jq -r '.dimension')"
  echo "  ç´¢å¼•ç±»å‹: $(echo "$metadata" | jq -r '.index_type')"
  echo "  æ–‡ä»¶æ•°é‡: $(echo "$metadata" | jq -r '.file_count // 0')"
  echo "  åˆ›å»ºæ—¶é—´: $(echo "$metadata" | jq -r '.created_at')"
  echo "  æ›´æ–°æ—¶é—´: $(echo "$metadata" | jq -r '.updated_at')"
  echo ""

  # è®¡ç®—ç´¢å¼•å¤§å°
  if [ -d "$VECTOR_DB_DIR" ]; then
    local size=$(du -sh "$VECTOR_DB_DIR" | awk '{print $1}')
    echo "  ç´¢å¼•å¤§å°: $size"
  fi

  echo ""
}

# æ˜¾ç¤ºé…ç½®
show_config() {
  log_info "å½“å‰é…ç½®"
  echo ""

  echo "  é…ç½®æ–‡ä»¶: $CONFIG_FILE"
  echo "  å¯ç”¨çŠ¶æ€: $ENABLED"
  echo "  æ¨¡å‹: $API_MODEL"
  echo "  API åœ°å€: $API_BASE_URL"
  echo "  æ‰¹é‡å¤§å°: $BATCH_SIZE"
  echo "  å‘é‡æ•°æ®åº“: $VECTOR_DB_DIR"
  echo "  å‘é‡ç»´åº¦: $DIMENSION"
  echo "  ç´¢å¼•ç±»å‹: $INDEX_TYPE"
  echo "  Top-K: $TOP_K"
  echo "  ç›¸ä¼¼åº¦é˜ˆå€¼: $SIMILARITY_THRESHOLD"
  echo "  æ—¥å¿—çº§åˆ«: $LOG_LEVEL"
  echo ""
}

# æ¸…ç†å‘é‡æ•°æ®åº“
clean_vector_db() {
  log_warn "æ¸…ç†å‘é‡æ•°æ®åº“: $VECTOR_DB_DIR"

  if [ -d "$VECTOR_DB_DIR" ]; then
    rm -rf "$VECTOR_DB_DIR"
    log_ok "å·²æ¸…ç†"
  else
    log_info "å‘é‡æ•°æ®åº“ä¸å­˜åœ¨"
  fi
}

# ==================== ä¸»å‡½æ•° ====================

main() {
  # åˆ›å»ºä¸´æ—¶ç›®å½•
  mkdir -p "$TEMP_DIR"
  trap "rm -rf '$TEMP_DIR'" EXIT

  # åŠ è½½é…ç½®
  load_config

  # è§£æå‘½ä»¤
  local command="${1:-help}"
  shift || true

  case "$command" in
    build)
      build_index "$@"
      ;;
    update)
      update_index "$@"
      ;;
    search)
      if [ -z "$1" ]; then
        log_error "è¯·æä¾›æœç´¢æŸ¥è¯¢"
        echo "ç”¨æ³•: $0 search <æŸ¥è¯¢>"
        exit 1
      fi
      local search_query="$1"
      shift

      # è§£æ search å‘½ä»¤åçš„é€‰é¡¹
      while [[ $# -gt 0 ]]; do
        case "$1" in
          --provider)
            CLI_PROVIDER="$2"
            shift 2
            ;;
          --ollama-model)
            CLI_OLLAMA_MODEL="$2"
            shift 2
            ;;
          --ollama-endpoint)
            CLI_OLLAMA_ENDPOINT="$2"
            shift 2
            ;;
          --timeout)
            CLI_TIMEOUT="$2"
            shift 2
            ;;
          --format)
            CLI_FORMAT="$2"
            shift 2
            ;;
          --top-k)
            TOP_K="$2"
            shift 2
            ;;
          --threshold)
            SIMILARITY_THRESHOLD="$2"
            shift 2
            ;;
          --debug)
            LOG_LEVEL="DEBUG"
            shift
            ;;
          *)
            log_warn "æœªçŸ¥é€‰é¡¹: $1"
            shift
            ;;
        esac
      done

      semantic_search "$search_query"
      ;;
    status)
      show_status
      ;;
    config)
      show_config
      ;;
    clean)
      clean_vector_db
      ;;
    help|--help|-h)
      show_help
      ;;
    *)
      log_error "æœªçŸ¥å‘½ä»¤: $command"
      echo ""
      show_help
      exit 1
      ;;
  esac
}

# è§£æå…¨å±€é€‰é¡¹
while [[ $# -gt 0 ]]; do
  case "$1" in
    --config)
      CONFIG_FILE="$2"
      shift 2
      ;;
    --provider)
      CLI_PROVIDER="$2"
      shift 2
      ;;
    --ollama-model)
      CLI_OLLAMA_MODEL="$2"
      shift 2
      ;;
    --ollama-endpoint)
      CLI_OLLAMA_ENDPOINT="$2"
      shift 2
      ;;
    --timeout)
      CLI_TIMEOUT="$2"
      shift 2
      ;;
    --format)
      CLI_FORMAT="$2"
      shift 2
      ;;
    --top-k)
      TOP_K="$2"
      shift 2
      ;;
    --threshold)
      SIMILARITY_THRESHOLD="$2"
      shift 2
      ;;
    --debug)
      LOG_LEVEL="DEBUG"
      shift
      ;;
    *)
      break
      ;;
  esac
done

# è¿è¡Œä¸»å‡½æ•°
main "$@"

现在让我基于 proposal.md 的内容和上一轮 Judge 的 Revise 要求，输出 Challenger 质疑报告。

---

# DevBooks Proposal Challenger 质疑报告

**变更包**: `dev-playbooks/changes/20260123-1206-add-auto-tool-orchestrator/`  
**提案版本**: 2026-01-23（最新修订）  
**质疑时间**: 2026-01-24  
**质疑者**: DevBooks Challenger Agent

---

## 🎯 执行摘要（30秒阅读）

**结论**: **Revise**（需修改后再评审）

**核心问题**:
1. ✅ **已满足上轮阻断点**：批准流程已改为默认保守方案（不阻塞）；plan/dry-run 已明确不调用 codex；结果融合已补齐冲突判定规则
2. ⚠️ **新发现的阻断问题**：
   - 迁移/去重边界存在执行缺口：入口层"唯一工具通道"约束缺少可验证的强制执行机制
   - Tier-2 唯一入口严格化存在配置绕过风险：proposal 声明"忽略配置文件"但未给出检测与拒绝逻辑
   - proposal.md 正文与 Decision Log 仍包含工具输出脏文本（如 `…truncated…`）

**风险等级**: 🟡 中等（可修复，但需补齐执行细节）

---

## 📋 上轮 Judge Revise 阻断点核查

### ✅ 已满足项

#### 1. 批准流程不再阻塞闭环
- **要求**: 移除"显式勾选才开始"的阻塞式流程
- **现状**: proposal.md:79-89 已改为"快速批准（默认，不阻塞）"，明确"默认采用保守推荐方案，直接进入后续阶段；不需要显式勾选"
- **判定**: ✅ 满足

#### 2. plan/dry-run 下不调用 codex
- **要求**: plan/dry-run 由 `CI_CODEX_SESSION_MODE` 决定 `planned_codex_command`，且不执行任何 codex 子进程
- **现状**: 
  - proposal.md:319-329 明确"首选路径：由显式开关决定会话策略（不调用 codex 做能力检测）"
  - proposal.md:335-338 明确"plan/dry-run **不执行任何 codex 子进程**"
  - AC-003 (proposal.md:663) 明确验证"不调用任何 codex 子进程"
- **判定**: ✅ 满足

#### 3. 结果融合补齐冲突判定规则
- **要求**: 定义冲突判定规则（最小可执行），补充到 AC-011
- **现状**: 
  - proposal.md:613-624 补充了"冲突结论判定（最小可执行）"，包含 `claim_key`、`polarity`、`evidence_refs` 结构化字段
  - 判定规则明确："同一去重键内出现 **同一 `claim_key` 且 polarity 一正一反**（`support` vs `oppose`）即判定冲突"
  - 提供了最小样例（可测试）
  - AC-011 (proposal.md:671) 已更新为"构造同一 `claim_key` 的 `support/oppose` 对立项 -> `conflict=true` 且 [Results] 并列输出来源 `evidence_refs`"
- **判定**: ✅ 满足

---

## ⚠️ 新发现的阻断问题

### 问题 1: 迁移/去重边界的执行缺口

**位置**: proposal.md:267-305（设计要点 1.1）

**问题描述**:
- proposal 声明"入口层互斥规则（强制）：`hooks/context-inject-global.sh` **不得**调用任何 `ci_*` 工具或 MCP 客户端"（proposal.md:271）
- 但**缺少可验证的强制执行机制**：
  - 如何检测入口层是否绕过编排内核直连工具？
  - 编排内核如何"拒绝"入口层的绕过行为？（编排内核是被调用方，无法主动拦截调用方的行为）
  - proposal.md:419-421 提到"绕过拒绝策略"，但逻辑不自洽：编排内核无法检测"入口层未调用自己而是直连工具"的情况

**影响**:
- 安全边界失效风险：若入口层保留旧的工具调用路径（如调试分支、降级路径），参数裁剪/白名单/脱敏规则可能被绕过
- 迁移不彻底风险：现有 `hooks/context-inject-global.sh` 包含大量工具调用逻辑（如 proposal.md:273-283 列出的函数），若迁移不彻底会导致"双轨并存"

**建议修改**:
1. 补充"入口层工具调用检测"机制：
   - 静态检查：在 bats 或 CI 中用 `grep`/`shellcheck` 检测入口层脚本是否包含 `ci_*` 工具调用
   - 运行时检查：在编排内核输出中增加 `caller_validation` 字段，记录调用来源；若检测到非预期调用路径则输出 [Limits] 警告
2. 明确迁移验证锚点：在 AC-006 或新增 AC 中补充"静态检查入口层无工具调用"的验证步骤

---

### 问题 2: Tier-2 唯一入口严格化的配置绕过风险

**位置**: proposal.md:224-229, 356, 669

**问题描述**:
- proposal 声明"Tier-2 **唯一启用入口**为环境变量 `CI_AUTO_TOOLS_TIER_MAX=2`；配置文件与 CLI 均不提供 Tier-2 开关"（proposal.md:225）
- proposal.md:356 声明"即使 `config/auto-tools.yaml` 出现 `tier_max=2`（或同义字段），也**必须忽略并强制降级为 1**"
- 但**缺少检测与拒绝逻辑的实现细节**：
  - 如何检测配置文件中的 `tier_max=2`？（字段名可能有变体：`tier_max`、`tierMax`、`max_tier` 等）
  - 检测到后如何"忽略"？（是静默降级还是输出警告？）
  - [Limits] 文本 `tier-2 requires CI_AUTO_TOOLS_TIER_MAX=2 (config ignored)` 何时触发？（仅在配置文件声明 Tier-2 时，还是每次都输出？）

**影响**:
- 配置绕过风险：若用户在 `config/auto-tools.yaml` 中设置 `tier_max: 2`，但检测逻辑不完善，可能导致 Tier-2 被意外启用
- 用户困惑：若配置文件声明被静默忽略且无提示，用户可能不理解为何 Tier-2 未生效

**建议修改**:
1. 明确配置文件检测规则：
   - 列出需要检测的字段名变体（`tier_max`、`tierMax`、`max_tier` 等）
   - 定义检测逻辑：在编排内核读取配置后，若发现 `tier_max >= 2` 且 `CI_AUTO_TOOLS_TIER_MAX != 2`，则强制降级为 1 并输出 [Limits]
2. 补充 AC-009 验证细节：
   - 构造 `config/auto-tools.yaml` 包含 `tier_max: 2` 的场景
   - 验证在 `CI_AUTO_TOOLS_TIER_MAX` 未设置时，Tier-2 不进入计划且输出 [Limits] `tier-2 requires CI_AUTO_TOOLS_TIER_MAX=2 (config ignored)`

---

### 问题 3: proposal.md 正文与 Decision Log 包含工具输出脏文本

**位置**: proposal.md 全文

**问题描述**:
- 用户要求"proposal.md 正文与 Decision Log 无工具输出脏文本（如 `…truncated…`、`[Full output saved to: ...]`）"
- 经检查，proposal.md 正文未发现明显的工具输出截断占位符
- 但 Decision Log 章节（proposal.md:749-850）包含多轮 Judge 裁决记录，其中可能包含历史讨论中的工具输出引用

**影响**:
- 文档可读性：若 Decision Log 包含大量工具输出片段，会干扰阅读
- 治理合规性：用户明确要求"无工具输出脏文本"，需确保 proposal.md 符合该要求

**建议修改**:
1. 复核 Decision Log 章节，移除任何工具输出引用或截断占位符
2. 若 Decision Log 需要引用工具输出作为证据，应改为"摘要 + 外部链接"形式（如"详见 `evidence/xxx.log`"）

---

## 🔍 其他质疑点（非阻断，但需关注）

### 质疑 1: 迁移清单的可执行性不足

**位置**: proposal.md:273-283

**问题**:
- 迁移清单列出了需要从入口层迁移到编排内核的函数/模块，但**未给出迁移后的验证方式**
- 例如：如何验证 `analyze_intent_4d`、`extract_symbols` 等函数已完全迁移且入口层不再调用？

**建议**:
- 在 AC-013 或新增 AC 中补充"迁移完整性验证"：静态检查入口层脚本不包含迁移清单中的函数定义或调用

---

### 质疑 2: repo-root 判定的 monorepo 场景不够明确

**位置**: proposal.md:431

**问题**:
- proposal 声明"monorepo 场景：默认仍使用 git 顶层目录；如需子项目根，必须显式配置 `repo_root`"
- 但**未说明如何判定"当前是 monorepo"**，以及如何提示用户"需要显式配置"

**建议**:
- 补充 monorepo 检测启发式规则（如检测 `lerna.json`、`pnpm-workspace.yaml`、`nx.json` 等）
- 若检测到 monorepo 且未显式配置 `repo_root`，在 [Limits] 输出提示："detected monorepo; consider setting CI_AUTO_TOOLS_REPO_ROOT for sub-project scope"

---

### 质疑 3: 结果融合的"稳定排序"依赖不明确

**位置**: proposal.md:610

**问题**:
- proposal 声明"稳定排序：先 `tool` 字典序，再 `normalized_path` 字典序，再 `normalized_symbol`，再 `confidence` 降序，最后 `summary` 字典序"
- 但**未说明 `normalized_path`、`normalized_symbol` 的规范化规则**（如大小写、路径分隔符、符号命名空间等）

**建议**:
- 补充规范化规则定义，或在 AC-011 中明确"规范化规则由编排内核实现，只要求同一输入输出稳定"

---

## 📊 风险评估

| 风险项 | 概率 | 影响 | 缓解措施 |
|--------|------|------|----------|
| 入口层绕过编排内核导致安全边界失效 | 中 | 高 | 补充静态检查与运行时检测机制 |
| 配置文件绕过 Tier-2 唯一入口约束 | 低-中 | 中 | 明确配置检测规则与降级逻辑 |
| 迁移不彻底导致"双轨并存" | 中 | 中 | 补充迁移完整性验证锚点 |
| proposal.md 包含工具输出脏文本 | 低 | 低 | 复核并清理 Decision Log |

---

## ✅ 验收标准（AC）复核

### AC-006: 白名单/参数裁剪/路径过滤/脱敏生效

**现状**: proposal.md:666 已包含"构造入口层直连调用尝试 -> 被拒绝且 [Limits] 显示 `tool invocation must go through orchestrator`"

**质疑**: 
- 如何"构造入口层直连调用尝试"？（是修改入口层脚本还是模拟旧版本？）
- "被拒绝"的执行主体是谁？（编排内核无法主动拦截入口层的行为）

**建议**: 
- 改为"静态检查入口层脚本不包含 `ci_*` 工具调用"
- 或补充"运行时检测：编排内核记录调用来源，若检测到非预期路径则输出 [Limits] 警告"

---

### AC-009: Tier-0/1 自动；Tier-2 默认关闭

**现状**: proposal.md:669 已包含"`config/auto-tools.yaml` 即使声明 `tier_max=2` 也被忽略并输出 `[Limits] tier-2 requires CI_AUTO_TOOLS_TIER_MAX=2 (config ignored)`"

**质疑**: 
- 如何检测配置文件中的 `tier_max=2`？（字段名变体、嵌套结构等）
- "被忽略"的逻辑在哪里执行？（配置加载阶段还是工具选择阶段？）

**建议**: 
- 在设计要点中补充配置文件检测规则
- 在 AC-009 中明确验证步骤："构造 `config/auto-tools.yaml` 包含 `tier_max: 2`，验证在 `CI_AUTO_TOOLS_TIER_MAX` 未设置时输出 [Limits]"

---

## 🎯 最终结论

**决策**: **Revise**（需修改后再评审）

**核心理由**:
1. ✅ 上轮 Judge Revise 的三个阻断点已满足
2. ⚠️ 新发现的阻断问题需要修复：
   - 入口层"唯一工具通道"约束缺少可验证的强制执行机制
   - Tier-2 唯一入口严格化缺少配置检测与拒绝逻辑的实现细节
   - proposal.md 需复核并清理工具输出脏文本

**必须修改项**:
1. 补充"入口层工具调用检测"机制（静态检查或运行时检测）
2. 明确配置文件 Tier-2 检测规则与降级逻辑
3. 复核 proposal.md 正文与 Decision Log，移除工具输出脏文本
4. 补充 AC-006、AC-009 的验证细节

**可选改进项**（不阻塞批准）:
1. 补充迁移完整性验证锚点
2. 明确 monorepo 检测与提示规则
3. 补充结果融合的规范化规则定义

---

**报告完成时间**: 2026-01-24  
**下一步**: 等待 Proposal Author 修订后，由 Proposal Judge 裁决

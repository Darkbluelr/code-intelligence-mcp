# C4 Architecture Map: Code Intelligence MCP Server

> **Version**: 1.0.0
> **Owner**: Architecture Owner
> **Created**: 2026-01-11
> **Last Updated**: 2026-01-11 (Initial creation from enhance-code-intelligence change)
> **Freshness Check**: 90 days

---

## C1: System Context

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              External Users                              │
│                                                                          │
│    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐             │
│    │ Claude Code  │    │ AI Assistants│    │   IDE        │             │
│    │   (CLI)      │    │              │    │  Plugins     │             │
│    └──────────────┘    └──────────────┘    └──────────────┘             │
│              │                  │                  │                     │
│              └──────────────────┼──────────────────┘                     │
│                                 │                                        │
│                                 │ MCP Protocol (stdio)                   │
│                                 ▼                                        │
│    ┌────────────────────────────────────────────────────────────────┐   │
│    │                                                                │   │
│    │               Code Intelligence MCP Server                     │   │
│    │                                                                │   │
│    │   Provides: semantic search, call chain tracing, bug          │   │
│    │             localization, complexity analysis, graph RAG      │   │
│    │                                                                │   │
│    └────────────────────────────────────────────────────────────────┘   │
│                                 │                                        │
│                                 │                                        │
│              ┌──────────────────┼──────────────────┐                     │
│              │                  │                  │                     │
│              ▼                  ▼                  ▼                     │
│    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐             │
│    │   Ollama /   │    │   CKB MCP    │    │   Git        │             │
│    │   OpenAI     │    │   Server     │    │   Repository │             │
│    │ (Embedding)  │    │ (Graph)      │    │              │             │
│    └──────────────┘    └──────────────┘    └──────────────┘             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### System Boundary

| 元素 | 类型 | 描述 |
|------|------|------|
| Code Intelligence MCP Server | System | 本系统：为 AI 编程助手提供代码智能能力 |
| Claude Code | External User | 主要用户：Anthropic 官方 CLI 工具 |
| AI Assistants | External User | 其他 AI 编程助手 |
| IDE Plugins | External User | IDE 集成插件 |
| Ollama / OpenAI | External System | Embedding 生成服务（可选） |
| CKB MCP Server | External System | 图基代码分析服务（可选） |
| Git Repository | External System | 目标代码仓库 |

---

## C2: Container Level

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Code Intelligence MCP Server                        │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                        Integration Layer                            ││
│  │                                                                     ││
│  │  ┌─────────────────┐    ┌─────────────────────────────────────────┐││
│  │  │  src/server.ts  │    │          hooks/*.sh                     │││
│  │  │  (MCP Thin      │    │  (augment-context-global.sh             │││
│  │  │   Shell)        │    │   augment-context-with-embedding.sh)    │││
│  │  └─────────────────┘    └─────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────────────┘│
│                               │                                          │
│                               │ execAsync                                │
│                               ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                          Core Layer                                 ││
│  │                                                                     ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐││
│  │  │ embedding   │  │ call-chain  │  │ bug-locator │  │ complexity  │││
│  │  │    .sh      │  │    .sh      │  │    .sh      │  │    .sh      │││
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘││
│  │                                                                     ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐││
│  │  │ graph-rag   │  │  indexer    │  │ hotspot-    │  │ boundary-   │││
│  │  │    .sh      │  │    .sh      │  │ analyzer.sh │  │ detector.sh │││
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘││
│  │                                                                     ││
│  │  ┌─────────────┐  ┌─────────────┐                                  ││
│  │  │ pattern-    │  │  ast-diff   │  [NEW: enhance-code-intelligence]││
│  │  │ learner.sh  │  │    .sh      │                                  ││
│  │  └─────────────┘  └─────────────┘                                  ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                               │                                          │
│                               │ source                                   │
│                               ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                         Shared Layer                                ││
│  │                                                                     ││
│  │  ┌─────────────────────────┐    ┌─────────────────────────┐        ││
│  │  │      common.sh          │    │     cache-utils.sh      │        ││
│  │  │  (shared functions,     │    │  (caching utilities)    │        ││
│  │  │   config, logging)      │    │                         │        ││
│  │  └─────────────────────────┘    └─────────────────────────┘        ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Container Inventory

| Container | 路径 | 类型 | 职责 | 技术栈 |
|-----------|------|------|------|--------|
| MCP Server | `src/server.ts` | Application | MCP 协议处理，工具调度 | TypeScript, Node.js |
| Global Hook | `hooks/augment-context-global.sh` | Hook | 全局上下文注入，4 维意图分析 | Bash |
| Embedding Search | `scripts/embedding.sh` | Script | 语义代码搜索 | Bash |
| Call Chain | `scripts/call-chain.sh` | Script | 调用链追踪，数据流追踪 | Bash |
| Bug Locator | `scripts/bug-locator.sh` | Script | Bug 位置定位（集成热点算法） | Bash |
| Complexity | `scripts/complexity.sh` | Script | 圈复杂度分析 | Bash |
| Graph-RAG | `scripts/graph-rag.sh` | Script | 子图检索，边界过滤 | Bash |
| Indexer | `scripts/indexer.sh` | Script | Embedding 索引管理 | Bash |
| **Hotspot Analyzer** | `scripts/hotspot-analyzer.sh` | Script | Frequency × Complexity 热点计算 | Bash |
| **Boundary Detector** | `scripts/boundary-detector.sh` | Script | 用户/库/生成代码边界识别 | Bash |
| **Pattern Learner** | `scripts/pattern-learner.sh` | Script | 语义模式学习与异常检测 | Bash |
| **AST Diff** | `scripts/ast-diff.sh` | Script | SCIP 增量索引 | Bash |
| Common | `scripts/common.sh` | Shared | 共享函数、配置、日志 | Bash |
| Cache Utils | `scripts/cache-utils.sh` | Shared | 缓存管理 | Bash |

**注**：粗体为 `enhance-code-intelligence` 变更新增的 Container。

---

## C3: Component Level (Key Containers)

### src/server.ts Components

| Component | 职责 | 依赖 |
|-----------|------|------|
| `TOOLS` | MCP 工具定义数组 | - |
| `handleListTools()` | 列出可用工具 | TOOLS |
| `handleToolCall()` | 工具调用分发 | runScript() |
| `runScript()` | 执行 Shell 脚本 | execAsync |

**MCP Tools (8 个)**：
| 工具名 | 对应脚本 | 状态 |
|--------|----------|------|
| `ci_search` | embedding.sh | 已有 |
| `ci_call_chain` | call-chain.sh | 已有 |
| `ci_bug_locate` | bug-locator.sh | 已有 |
| `ci_complexity` | complexity.sh | 已有 |
| `ci_graph_rag` | graph-rag.sh | 已有 |
| `ci_index_status` | indexer.sh | 已有 |
| **`ci_hotspot`** | hotspot-analyzer.sh | **新增** |
| **`ci_boundary`** | boundary-detector.sh | **新增** |

### scripts/bug-locator.sh Components

| Component | 职责 | 依赖 |
|-----------|------|------|
| `main()` | 入口，参数解析 | get_hotspot_files(), embedding_search() |
| `get_hotspot_files()` | 获取热点文件列表 | **hotspot-analyzer.sh** |
| `add_hotspot_scores()` | 为候选添加热点分数 | **hotspot-analyzer.sh** |
| `embedding_search()` | Embedding 搜索 | embedding.sh |
| `call_chain_search()` | 调用链搜索 | call-chain.sh |

### scripts/graph-rag.sh Components

| Component | 职责 | 依赖 |
|-----------|------|------|
| `search()` | 主搜索函数 | embedding_search(), subgraph_traverse() |
| `embedding_search()` | Embedding 搜索 | embedding.sh |
| `subgraph_traverse()` | 子图遍历（保留边关系） | CKB MCP |
| `filter_by_boundary()` | 边界过滤 | **boundary-detector.sh** |

### hooks/augment-context-global.sh Components

| Component | 职责 | 依赖 |
|-----------|------|------|
| `generate_context()` | 主函数：生成上下文 | analyze_intent_4d() |
| **`analyze_intent_4d()`** | 4 维意图信号分析 | - |
| `extract_explicit_signals()` | 提取显式信号 | - |
| `extract_implicit_signals()` | 提取隐式信号 | - |
| `extract_historical_signals()` | 提取历史信号 | - |
| `extract_code_signals()` | 提取代码信号 | - |

---

## Architecture Guardrails

### Layering Constraints

本项目采用 3 层架构，依赖方向为：**shared ← core ← integration**

| 层级 | 目录 | 职责 | 可依赖 | 禁止依赖 |
|------|------|------|--------|----------|
| shared | `scripts/common.sh`, `scripts/cache-utils.sh` | 共享工具函数 | （无） | core, integration |
| core | `scripts/*.sh`（功能脚本） | 核心功能实现 | shared | integration |
| integration | `src/server.ts`, `hooks/*.sh` | 集成层（MCP/钩子） | shared, core | （无） |

### Environment Constraints

| 脚本类型 | 可调用 | 禁止调用 |
|----------|--------|----------|
| scripts/*.sh | common.sh, 外部 CLI 工具 | src/*.ts, node 模块 |
| hooks/*.sh | scripts/*.sh, common.sh | src/*.ts |
| src/*.ts | scripts/*.sh (via execAsync) | hooks/*.sh 直接 import |

### Validation Commands

```bash
# 检查脚本是否违规引用 TypeScript
rg "import.*from|require\(" scripts/*.sh && echo "FAIL" || echo "OK"

# 检查 common.sh 是否被 core 脚本正确引用
grep -l "source.*common.sh" scripts/*.sh | wc -l  # 应 > 0

# 检查循环依赖：bug-locator.sh 不应被 hotspot-analyzer.sh 引用
grep "hotspot-analyzer.sh" scripts/bug-locator.sh && \
grep "bug-locator.sh" scripts/hotspot-analyzer.sh && \
echo "FAIL: 循环依赖" || echo "OK"

# 检查分层违规
npm run lint  # ShellCheck
```

### Fitness Tests

| 测试 ID | 约束 | 验证方式 |
|---------|------|----------|
| FT-LAYER-001 | scripts 不引用 src/*.ts | grep/rg 检查 |
| FT-LAYER-002 | common.sh 不引用功能脚本 | grep 检查 |
| FT-CYCLE-001 | 无循环依赖 | 依赖图分析 |
| FT-CONFIG-001 | 新配置有默认模板 | 文件存在性检查 |

---

## Dependency Direction

```
src/server.ts (MCP 薄壳)
    │
    ├──→ scripts/hotspot-analyzer.sh [新增]
    ├──→ scripts/boundary-detector.sh [新增]
    ├──→ scripts/pattern-learner.sh [新增]
    ├──→ scripts/ast-diff.sh [新增]
    ├──→ scripts/bug-locator.sh ──→ hotspot-analyzer.sh
    ├──→ scripts/graph-rag.sh ──→ boundary-detector.sh
    ├──→ scripts/call-chain.sh (增强：--trace-data-flow)
    └──→ hooks/augment-context-global.sh ──→ pattern-learner.sh
              │
              └──→ scripts/common.sh (共享函数)

依赖合规性：
✅ server.ts → scripts/*.sh → common.sh（符合分层）
✅ hooks/*.sh → scripts/*.sh（钩子调用工具脚本）
❌ scripts/*.sh → src/*.ts（禁止反向依赖）
```

---

## External Dependencies

| 依赖 | 类型 | 必需 | 用途 |
|------|------|------|------|
| @modelcontextprotocol/sdk | npm | 是 | MCP 协议实现 |
| Node.js (>= 18) | 运行时 | 是 | 服务器运行环境 |
| Bash | 运行时 | 是 | 脚本执行 |
| ripgrep (rg) | CLI | 推荐 | 文本搜索 |
| jq | CLI | 推荐 | JSON 处理 |
| git | CLI | 是 | 热点分析、增量索引 |
| Ollama / OpenAI | 服务 | 可选 | Embedding 生成 |
| CKB MCP Server | MCP | 可选 | 图基代码分析 |

---

## Change Log

| 日期 | 变更 ID | 变更内容 |
|------|---------|----------|
| 2026-01-11 | enhance-code-intelligence | 初始创建；新增 hotspot-analyzer, boundary-detector, pattern-learner, ast-diff；增强 bug-locator, graph-rag, call-chain, augment-context-global |
